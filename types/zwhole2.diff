diff --git a/bin/dd/conv.c b/bin/dd/conv.c
index 3ddde5c641..0440a12732 100644
--- a/bin/dd/conv.c
+++ b/bin/dd/conv.c
@@ -39,6 +39,7 @@
 #include <sys/param.h>
 
 #include <err.h>
+#include <stdint.h>
 #include <string.h>
 
 #include "dd.h"
diff --git a/bin/dd/conv_tab.c b/bin/dd/conv_tab.c
index 5aebe1e475..a1f5175a1e 100644
--- a/bin/dd/conv_tab.c
+++ b/bin/dd/conv_tab.c
@@ -37,6 +37,7 @@
  */
 
 #include <sys/types.h>
+#include <stdint.h>
 
 #include "dd.h"
 #include "extern.h"
diff --git a/bin/dd/dd.h b/bin/dd/dd.h
index a0a55d545b..6f742b5841 100644
--- a/bin/dd/dd.h
+++ b/bin/dd/dd.h
@@ -37,6 +37,7 @@
  */
 
 #include <sys/time.h>
+#include <stdint.h>
 
 /* Input/output stream state. */
 typedef struct {
diff --git a/bin/pax/cpio.c b/bin/pax/cpio.c
index f73037d82a..d0ca1ab175 100644
--- a/bin/pax/cpio.c
+++ b/bin/pax/cpio.c
@@ -32,13 +32,13 @@
  *
  * @(#)cpio.c	8.1 (Berkeley) 5/31/93
  * $FreeBSD: src/bin/pax/cpio.c,v 1.12.2.1 2001/08/01 05:03:11 obrien Exp $
- * $DragonFly: src/bin/pax/cpio.c,v 1.8 2006/09/27 21:58:08 pavalos Exp $
  */
 
 #include <sys/types.h>
 #include <sys/time.h>
 #include <sys/stat.h>
 #include <string.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <unistd.h>
 #include <stdlib.h>
diff --git a/bin/pax/gen_subs.c b/bin/pax/gen_subs.c
index fcfb362c58..e4b00121ce 100644
--- a/bin/pax/gen_subs.c
+++ b/bin/pax/gen_subs.c
@@ -40,6 +40,7 @@
 #include <grp.h>
 #include <langinfo.h>
 #include <pwd.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
@@ -171,7 +172,7 @@ ls_tty(ARCHD *arcn)
 /*
  * l_strncpy()
  *	copy src to dest up to len chars (stopping at first '\0').
- *	when src is shorter than len, pads to len with '\0'. 
+ *	when src is shorter than len, pads to len with '\0'.
  * Return:
  *	number of chars copied. (Note this is a real performance win over
  *	doing a strncpy(), a strlen(), and then a possible memset())
diff --git a/contrib/openbsd_libm/src/math_private.h b/contrib/openbsd_libm/src/math_private.h
index 5bece0cbe6..64f1e58adb 100644
--- a/contrib/openbsd_libm/src/math_private.h
+++ b/contrib/openbsd_libm/src/math_private.h
@@ -5,7 +5,7 @@
  *
  * Developed at SunPro, a Sun Microsystems, Inc. business.
  * Permission to use, copy, modify, and distribute this
- * software is freely granted, provided that this notice 
+ * software is freely granted, provided that this notice
  * is preserved.
  * ====================================================
  */
@@ -18,6 +18,7 @@
 #define _MATH_PRIVATE_H_
 
 #include <sys/types.h>
+#include <stdint.h>
 
 /* The original fdlibm code used statements like:
 	n0 = ((*(int*)&one)>>29)^1;		* index of high word *
diff --git a/contrib/openbsd_libm/src/s_rintl.c b/contrib/openbsd_libm/src/s_rintl.c
index 55ebca5ba0..b627cbc9c8 100644
--- a/contrib/openbsd_libm/src/s_rintl.c
+++ b/contrib/openbsd_libm/src/s_rintl.c
@@ -29,6 +29,7 @@
 #include <machine/ieee.h>
 #include <float.h>
 #include <math.h>
+#include <stdint.h>
 
 #if LDBL_MAX_EXP != 0x4000
 /* We also require the usual bias, min exp and expsign packing. */
diff --git a/contrib/smbfs/lib/smb/nls.c b/contrib/smbfs/lib/smb/nls.c
index abd831f3b8..b45631334a 100644
--- a/contrib/smbfs/lib/smb/nls.c
+++ b/contrib/smbfs/lib/smb/nls.c
@@ -40,6 +40,7 @@
 #include <dlfcn.h>
 #endif
 #include <errno.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <string.h>
 #include <strings.h>
diff --git a/contrib/smbfs/smbutil/dumptree.c b/contrib/smbfs/smbutil/dumptree.c
index 2ae383318e..6325405c47 100644
--- a/contrib/smbfs/smbutil/dumptree.c
+++ b/contrib/smbfs/smbutil/dumptree.c
@@ -2,6 +2,7 @@
 #include <sys/time.h>
 #include <grp.h>
 #include <pwd.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <string.h>
 #include <unistd.h>
diff --git a/contrib/smbfs/smbutil/smbutil.c b/contrib/smbfs/smbutil/smbutil.c
index 4d14f9e4a3..3a3460d5d0 100644
--- a/contrib/smbfs/smbutil/smbutil.c
+++ b/contrib/smbfs/smbutil/smbutil.c
@@ -1,5 +1,6 @@
 #include <sys/param.h>
 #include <sys/time.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <string.h>
 #include <unistd.h>
diff --git a/games/fish/fish.c b/games/fish/fish.c
index b31d4b068a..b2c6fdf47b 100644
--- a/games/fish/fish.c
+++ b/games/fish/fish.c
@@ -39,6 +39,7 @@
 #include <errno.h>
 #include <fcntl.h>
 #include <spawn.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/games/hack/hack.h b/games/hack/hack.h
index 0d3868ecab..82e385ddb2 100644
--- a/games/hack/hack.h
+++ b/games/hack/hack.h
@@ -6,6 +6,7 @@
 #include <signal.h>
 #include <stdarg.h>
 #include <stdbool.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/games/morse/morse.c b/games/morse/morse.c
index 21a9eee660..78fce2ed1a 100644
--- a/games/morse/morse.c
+++ b/games/morse/morse.c
@@ -47,6 +47,7 @@
 #include <locale.h>
 #include <math.h>
 #include <signal.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/games/tetris/screen.c b/games/tetris/screen.c
index bbcc9f1faa..026267022f 100644
--- a/games/tetris/screen.c
+++ b/games/tetris/screen.c
@@ -44,6 +44,7 @@
 #include <err.h>
 #include <setjmp.h>
 #include <signal.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/gnu/usr.bin/binutils225/block1/libbfd/Makefile b/gnu/usr.bin/binutils225/block1/libbfd/Makefile
index c686c47eea..3b23f7e77a 100644
--- a/gnu/usr.bin/binutils225/block1/libbfd/Makefile
+++ b/gnu/usr.bin/binutils225/block1/libbfd/Makefile
@@ -74,7 +74,7 @@ elf64-gen.c elf64-x86-64.c: elf64-target.h
 cache.c elf32-i386.c elf64-x86-64.c: bfd_stdint.h
 
 bfd_stdint.h:
-	touch ${.TARGET}
+	echo "#include <stdint.h>" > ${.TARGET}
 
 targmatch.h: config.bfd targmatch.sed
 	sed -f ${CONTRIBDIR}/targmatch.sed < ${CONTRIBDIR}/config.bfd \
diff --git a/gnu/usr.bin/binutils225/block2/Makefile.block2 b/gnu/usr.bin/binutils225/block2/Makefile.block2
index caf70abec1..14c8c92bf0 100644
--- a/gnu/usr.bin/binutils225/block2/Makefile.block2
+++ b/gnu/usr.bin/binutils225/block2/Makefile.block2
@@ -29,4 +29,4 @@ LDADD_OPCODE=	${OBJTOP}/block1/libopcodes/libopcodes.a
 STD_LDADD=	${LDADD_BU} ${LDADD_BFD} ${LDADD_IBERTY}
 
 bfd_stdint.h:
-	touch ${.TARGET}
+	echo "#include <stdint.h>" > ${.TARGET}
diff --git a/gnu/usr.bin/binutils227/block1/libbfd/Makefile b/gnu/usr.bin/binutils227/block1/libbfd/Makefile
index 3d0a7892da..4d31547107 100644
--- a/gnu/usr.bin/binutils227/block1/libbfd/Makefile
+++ b/gnu/usr.bin/binutils227/block1/libbfd/Makefile
@@ -75,7 +75,7 @@ elf64-gen.c elf64-x86-64.c: elf64-target.h
 cache.c elf32-i386.c elf64-x86-64.c: bfd_stdint.h
 
 bfd_stdint.h:
-	touch ${.TARGET}
+	echo "#include <stdint.h>" > ${.TARGET}
 
 targmatch.h: config.bfd targmatch.sed
 	sed -f ${CONTRIBDIR}/targmatch.sed < ${CONTRIBDIR}/config.bfd \
diff --git a/gnu/usr.bin/binutils227/block2/Makefile.block2 b/gnu/usr.bin/binutils227/block2/Makefile.block2
index 5e151f55a2..b26bd030b7 100644
--- a/gnu/usr.bin/binutils227/block2/Makefile.block2
+++ b/gnu/usr.bin/binutils227/block2/Makefile.block2
@@ -29,4 +29,4 @@ LDADD_OPCODE=	${OBJTOP}/block1/libopcodes/libopcodes.a
 STD_LDADD=	${LDADD_BU} ${LDADD_BFD} ${LDADD_IBERTY}
 
 bfd_stdint.h:
-	touch ${.TARGET}
+	echo "#include <stdint.h>" > ${.TARGET}
diff --git a/gnu/usr.bin/gdb/libbfd/Makefile b/gnu/usr.bin/gdb/libbfd/Makefile
index 37755e1eea..e66e17d297 100644
--- a/gnu/usr.bin/gdb/libbfd/Makefile
+++ b/gnu/usr.bin/gdb/libbfd/Makefile
@@ -74,6 +74,6 @@ SRCS+=		bfd_stdint.h
 CLEANFILES+=	bfd_stdint.h
 
 bfd_stdint.h:
-	touch ${.TARGET}
+	echo "#include <stdint.h>" > ${.TARGET}
 
 .include <bsd.lib.mk>
diff --git a/include/arpa/inet.h b/include/arpa/inet.h
index 871956f297..b0277f030c 100644
--- a/include/arpa/inet.h
+++ b/include/arpa/inet.h
@@ -51,7 +51,6 @@
  *	@(#)inet.h	8.1 (Berkeley) 6/2/93
  *	$Id: inet.h,v 1.2.18.1 2005/04/27 05:00:50 sra Exp $
  * $FreeBSD: src/include/arpa/inet.h,v 1.30 2007/08/24 20:25:52 bms Exp $
- * $DragonFly: src/include/arpa/inet.h,v 1.5 2005/07/13 12:49:56 joerg Exp $
  */
 
 #ifndef _ARPA_INET_H_
@@ -60,10 +59,11 @@
 /* External definitions for functions in inet(3) */
 
 #include <sys/cdefs.h>
-#include <stdint.h>
-
-/* Required for byteorder(3) functions. */
-#include <machine/endian.h>
+#include <machine/endian.h>	/* Required for byteorder(3) functions. */
+#include <machine/stdint.h>	/* for __size_t, __socklen_t */
+#ifndef _KERNEL
+#include <stdint.h>		/* for uint16_t, uint32_t as per POSIX */
+#endif
 
 #define	INET_ADDRSTRLEN		16
 #define	INET6_ADDRSTRLEN	46
diff --git a/include/ctype.h b/include/ctype.h
index 5a85be9263..a42bd88aed 100644
--- a/include/ctype.h
+++ b/include/ctype.h
@@ -42,7 +42,7 @@
 #define _CTYPE_H_
 
 #include <sys/cdefs.h>
-#include <sys/types.h>
+#include <machine/stdint.h>
 
 #define	_CTYPE_A	0x00000100L		/* Alpha */
 #define	_CTYPE_C	0x00000200L		/* Control */
diff --git a/include/db.h b/include/db.h
index 20cd9955e4..315220eca6 100644
--- a/include/db.h
+++ b/include/db.h
@@ -37,6 +37,7 @@
 #include <sys/cdefs.h>
 
 #include <limits.h>
+#include <stdint.h>
 
 #define	RET_ERROR	-1		/* Return values. */
 #define	RET_SUCCESS	 0
diff --git a/include/netdb.h b/include/netdb.h
index 141503f139..19aa7b6548 100644
--- a/include/netdb.h
+++ b/include/netdb.h
@@ -58,6 +58,7 @@
 #define _NETDB_H_
 
 #include <sys/cdefs.h>
+#include <machine/stdint.h>	/* for __size_t, __socklen_t */
 #include <stdint.h>
 
 #ifndef _IN_ADDR_T_DECLARED
diff --git a/include/pthread_np.h b/include/pthread_np.h
index 28d0ebb117..3e3754683e 100644
--- a/include/pthread_np.h
+++ b/include/pthread_np.h
@@ -31,7 +31,18 @@
 #ifndef _PTHREAD_NP_H_
 #define _PTHREAD_NP_H_
 
-#include <sched.h>
+#include <sys/cdefs.h>
+#include <sys/types.h>
+#include <sys/cpumask.h>
+#include <sys/_timespec.h>
+#include <time.h>
+
+/* In case <sched.h> has limited visibility. */
+#ifndef _CPU_SET_T_DECLARED
+#define	_CPU_SET_T_DECLARED
+typedef	cpumask_t		cpu_set_t;
+typedef	cpumask_t		cpuset_t;	/* FreeBSD compat */
+#endif
 
 /*
  * Non-POSIX type definitions:
@@ -64,4 +75,4 @@ int pthread_switch_delete_np(pthread_switch_routine_t);
 int pthread_timedjoin_np(pthread_t, void **, const struct timespec *);
 __END_DECLS
 
-#endif
+#endif /* !_PTHREAD_NP_H_ */
diff --git a/include/resolv.h b/include/resolv.h
index 9c632b1110..a0268ea1a5 100644
--- a/include/resolv.h
+++ b/include/resolv.h
@@ -48,7 +48,6 @@
  *	@(#)resolv.h	8.1 (Berkeley) 6/2/93
  *	$Id: resolv.h,v 1.19.18.4 2008/04/03 23:15:15 marka Exp $
  * $FreeBSD: src/include/resolv.h,v 1.33 2008/12/14 19:39:53 ume Exp $
- * $DragonFly: src/include/resolv.h,v 1.4 2004/02/26 13:58:25 joerg Exp $
  */
 
 #ifndef _RESOLV_H_
@@ -58,6 +57,7 @@
 #include <sys/types.h>
 #include <sys/cdefs.h>
 #include <sys/socket.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <arpa/nameser.h>
 
diff --git a/include/rpc/auth.h b/include/rpc/auth.h
index baea8ca6c4..13e983afe4 100644
--- a/include/rpc/auth.h
+++ b/include/rpc/auth.h
@@ -49,6 +49,7 @@
 #include <rpc/clnt_stat.h>
 #include <sys/cdefs.h>
 #include <sys/socket.h>
+#include <stdint.h>
 
 #define MAX_AUTH_BYTES	400
 #define MAXNETNAMELEN	255	/* maximum length of network user's name */
diff --git a/include/rpc/types.h b/include/rpc/types.h
index 89c0b700c7..702e467b04 100644
--- a/include/rpc/types.h
+++ b/include/rpc/types.h
@@ -40,6 +40,7 @@
 
 #include <sys/types.h>
 #include <sys/_null.h>
+#include <stdint.h>
 
 typedef int32_t bool_t;
 typedef int32_t enum_t;
diff --git a/include/runetype.h b/include/runetype.h
index da5954fe94..9a3c7316fb 100644
--- a/include/runetype.h
+++ b/include/runetype.h
@@ -37,7 +37,7 @@
 #define	_RUNETYPE_H_
 
 #include <sys/cdefs.h>
-#include <sys/types.h>
+#include <machine/stdint.h>
 
 #define	_CACHED_RUNES	(1 <<8 )	/* Must be a power of 2 */
 #define	_CRMASK		(~(_CACHED_RUNES - 1))
diff --git a/include/spawn.h b/include/spawn.h
index 149d18738b..f0dbf709a0 100644
--- a/include/spawn.h
+++ b/include/spawn.h
@@ -30,8 +30,8 @@
 #define _SPAWN_H_
 
 #include <sys/cdefs.h>
-#include <sys/stdint.h>
 #include <sys/_sigset.h>
+#include <machine/stdint.h>
 
 #ifndef _MODE_T_DECLARED
 typedef	__uint16_t	mode_t;
diff --git a/include/stddef.h b/include/stddef.h
index 97d513063c..5c29e9a33e 100644
--- a/include/stddef.h
+++ b/include/stddef.h
@@ -36,12 +36,10 @@
 
 #include <sys/cdefs.h>
 #include <sys/_null.h>
+#include <machine/stdint.h>
 #ifndef __cplusplus
 #include <machine/wchar.h>		/* for ___wchar_t */
 #endif
-#ifndef _SYS_STDINT_H_
-#include <sys/stdint.h>			/* __rune_t and friends */
-#endif
 
 #ifndef _SIZE_T_DECLARED
 #define _SIZE_T_DECLARED
diff --git a/include/stdint.h b/include/stdint.h
index 5af4e612c3..4a3d37376f 100644
--- a/include/stdint.h
+++ b/include/stdint.h
@@ -27,7 +27,7 @@
 #ifndef _STDINT_H_
 #define _STDINT_H_
 
-#include <sys/stdint.h>
+#include <machine/stdint.h>
 
 typedef __int8_t	int8_t;
 typedef __int16_t	int16_t;
@@ -48,11 +48,6 @@ typedef __uintptr_t	uintptr_t;
 typedef __intmax_t	intmax_t;
 typedef __uintmax_t	uintmax_t;
 
-#ifndef _PTRDIFF_T_DECLARED
-#define _PTRDIFF_T_DECLARED
-typedef __ptrdiff_t		ptrdiff_t;            /* ptr1 - ptr2 */
-#endif
-
 typedef __int_fast8_t		int_fast8_t;
 typedef __int_fast16_t		int_fast16_t;
 typedef __int_fast32_t		int_fast32_t;
diff --git a/include/termios.h b/include/termios.h
index 3c77d3f327..beae79a749 100644
--- a/include/termios.h
+++ b/include/termios.h
@@ -36,7 +36,7 @@
 #include <sys/cdefs.h>
 #include <sys/_termios.h>
 /* Needed by tcgetsid(3). */
-#include <sys/stdint.h>
+#include <machine/stdint.h>
 
 #ifndef _PID_T_DECLARED
 typedef	__pid_t	pid_t;
diff --git a/include/time.h b/include/time.h
index 1825f454b8..54fa2c0af2 100644
--- a/include/time.h
+++ b/include/time.h
@@ -43,7 +43,7 @@
 
 #include <sys/cdefs.h>
 #include <sys/_null.h>
-#include <sys/stdint.h>
+#include <machine/stdint.h>
 
 #if __BSD_VISIBLE || (__POSIX_VISIBLE && __POSIX_VISIBLE < 200112)
 /*
diff --git a/include/uchar.h b/include/uchar.h
index 4866f15b42..87f7b4f772 100644
--- a/include/uchar.h
+++ b/include/uchar.h
@@ -30,7 +30,7 @@
 #define	_UCHAR_H_
 
 #include <sys/cdefs.h>
-#include <sys/types.h>
+#include <machine/stdint.h>
 #include <machine/wchar.h>	/* for __mbstate_t */
 
 #if !defined(__cplusplus) || __cplusplus < 201103
diff --git a/include/utmpx.h b/include/utmpx.h
index 845c7bee40..08675de441 100644
--- a/include/utmpx.h
+++ b/include/utmpx.h
@@ -33,6 +33,7 @@
 #include <sys/cdefs.h>
 #include <sys/socket.h>
 #include <sys/time.h>
+#include <stdint.h>
 
 #define	_PATH_UTMPX		"/var/run/utmpx"
 #define	_PATH_WTMPX		"/var/log/wtmpx"
diff --git a/include/uuid.h b/include/uuid.h
index 20eb9a5943..077f18077b 100644
--- a/include/uuid.h
+++ b/include/uuid.h
@@ -32,6 +32,7 @@
 
 #include <sys/types.h>
 #include <sys/uuid.h>
+#include <stdint.h>
 
 /*
  * This implementation mostly conforms to the DCE 1.1 specification.
diff --git a/include/wchar.h b/include/wchar.h
index b37c7e498d..81b7d3cd9a 100644
--- a/include/wchar.h
+++ b/include/wchar.h
@@ -62,8 +62,8 @@
 
 #include <sys/cdefs.h>
 #include <sys/_null.h>
-#include <sys/types.h>
 #include <machine/stdarg.h>	/* for __va_list */
+#include <machine/stdint.h>
 #include <machine/wchar_limits.h>
 #include <machine/wchar.h>
 #include <ctype.h>		/* for __wcwidth() */
diff --git a/include/wctype.h b/include/wctype.h
index be61aa6ee5..24da2bb692 100644
--- a/include/wctype.h
+++ b/include/wctype.h
@@ -32,9 +32,7 @@
 #define	_WCTYPE_H_
 
 #include <sys/cdefs.h>
-#include <sys/types.h>
 #include <machine/wchar.h>		/* for __wint_t */
-
 #include <ctype.h>
 
 #ifndef _WCTRANS_T
diff --git a/lib/csu/common/crtbrand.c b/lib/csu/common/crtbrand.c
index 82142a462c..59631d6ffa 100644
--- a/lib/csu/common/crtbrand.c
+++ b/lib/csu/common/crtbrand.c
@@ -26,6 +26,7 @@
  */
 
 #include <sys/param.h>
+#include <stdint.h>
 #include "notes.h"
 
 /*
diff --git a/lib/csu/common/initfini.c b/lib/csu/common/initfini.c
index 48dd815ad2..b0caa10e08 100644
--- a/lib/csu/common/initfini.c
+++ b/lib/csu/common/initfini.c
@@ -23,6 +23,7 @@
  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
+#include <stdint.h>
 #include "notes.h"
 
 extern int main(int, char **, char **);
diff --git a/lib/libc/citrus/citrus_bcs.h b/lib/libc/citrus/citrus_bcs.h
index 10afacdb98..db0dffc671 100644
--- a/lib/libc/citrus/citrus_bcs.h
+++ b/lib/libc/citrus/citrus_bcs.h
@@ -28,6 +28,7 @@
  */
 
 #include <sys/types.h>
+#include <stdint.h>
 
 #ifndef _CITRUS_BCS_H_
 #define _CITRUS_BCS_H_
diff --git a/lib/libc/citrus/citrus_iconv_local.h b/lib/libc/citrus/citrus_iconv_local.h
index 4335ca3a52..7102b78d42 100644
--- a/lib/libc/citrus/citrus_iconv_local.h
+++ b/lib/libc/citrus/citrus_iconv_local.h
@@ -32,6 +32,7 @@
 
 #include <iconv.h>
 #include <stdbool.h>
+#include <stdint.h>
 
 #define _CITRUS_ICONV_GETOPS_FUNC_BASE(_n_)				\
     int _n_(struct _citrus_iconv_ops *)
diff --git a/lib/libc/citrus/citrus_types.h b/lib/libc/citrus/citrus_types.h
index e691219eab..f50d194cd0 100644
--- a/lib/libc/citrus/citrus_types.h
+++ b/lib/libc/citrus/citrus_types.h
@@ -27,7 +27,7 @@
  * SUCH DAMAGE.
  */
 
-#include <sys/types.h>
+#include <stdint.h>
 
 #ifndef _CITRUS_TYPES_H_
 #define _CITRUS_TYPES_H_
diff --git a/lib/libc/db/btree/btree.h b/lib/libc/db/btree/btree.h
index 41cad14f2c..8faaf42529 100644
--- a/lib/libc/db/btree/btree.h
+++ b/lib/libc/db/btree/btree.h
@@ -39,6 +39,7 @@
 #define	F_ISSET(p, f)	((p)->flags & (f))
 
 #include <mpool.h>
+#include <stdint.h>
 
 #define	DEFMINKEYPAGE	(2)		/* Minimum keys per page */
 #define	MINCACHE	(5)		/* Minimum cached pages */
diff --git a/lib/libc/gen/arc4random.c b/lib/libc/gen/arc4random.c
index 13ad9ce4b0..9146fc513e 100644
--- a/lib/libc/gen/arc4random.c
+++ b/lib/libc/gen/arc4random.c
@@ -34,6 +34,7 @@
 #include <sys/types.h>
 #include <sys/time.h>
 #include <sys/sysctl.h>
+#include <stdint.h>
 #include <stdlib.h>
 #include <fcntl.h>
 #include <unistd.h>
diff --git a/lib/libc/gen/disklabel.c b/lib/libc/gen/disklabel.c
index 79fc8b7651..01351a554c 100644
--- a/lib/libc/gen/disklabel.c
+++ b/lib/libc/gen/disklabel.c
@@ -28,13 +28,13 @@
  *
  * @(#)disklabel.c	8.2 (Berkeley) 5/3/95
  * $FreeBSD: src/lib/libc/gen/disklabel.c,v 1.9.2.1 2001/03/05 08:40:47 obrien Exp $
- * $DragonFly: src/lib/libc/gen/disklabel.c,v 1.13 2007/06/18 05:13:34 dillon Exp $
  */
 
 #include <sys/param.h>
 #define DKTYPENAMES
 #include <sys/disklabel32.h>
 #include <sys/dtype.h>
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/fs.h>
 
diff --git a/lib/libc/gen/disktab.c b/lib/libc/gen/disktab.c
index 1aeab1ea09..e5711787fb 100644
--- a/lib/libc/gen/disktab.c
+++ b/lib/libc/gen/disktab.c
@@ -1,13 +1,13 @@
 /*
  * Copyright (c) 2007 The DragonFly Project.  All rights reserved.
- * 
+ *
  * This code is derived from software contributed to The DragonFly Project
  * by Matthew Dillon <dillon@backplane.com>
- * 
+ *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
- * 
+ *
  * 1. Redistributions of source code must retain the above copyright
  *    notice, this list of conditions and the following disclaimer.
  * 2. Redistributions in binary form must reproduce the above copyright
@@ -17,7 +17,7 @@
  * 3. Neither the name of The DragonFly Project nor the names of its
  *    contributors may be used to endorse or promote products derived
  *    from this software without specific, prior written permission.
- * 
+ *
  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
@@ -60,7 +60,6 @@
  * SUCH DAMAGE.
  */
 /*
- * $DragonFly: src/lib/libc/gen/disktab.c,v 1.11 2007/06/17 23:50:13 dillon Exp $
  * @(#)disklabel.c     8.2 (Berkeley) 5/3/95
  * $FreeBSD: src/lib/libc/gen/disklabel.c,v 1.9.2.1 2001/03/05 08:40:47 obrien
  */
@@ -69,6 +68,7 @@
 #define DKTYPENAMES
 #include <sys/disklabel.h>
 #include <sys/dtype.h>
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/fs.h>
 
diff --git a/lib/libc/gen/exec.c b/lib/libc/gen/exec.c
index 487b2df2bf..cae99bce86 100644
--- a/lib/libc/gen/exec.c
+++ b/lib/libc/gen/exec.c
@@ -36,6 +36,7 @@
 #include <sys/stat.h>
 #include <errno.h>
 #include <unistd.h>
+#include <stdint.h>	/* for uintptr_t in __DECONST() */
 #include <stdlib.h>
 #include <string.h>
 #include <stdio.h>
diff --git a/lib/libc/gen/ldexp.c b/lib/libc/gen/ldexp.c
index 87d3dd8ab0..12776f312e 100644
--- a/lib/libc/gen/ldexp.c
+++ b/lib/libc/gen/ldexp.c
@@ -15,6 +15,7 @@
 #include <sys/types.h>
 #include <machine/endian.h>
 #include <math.h>
+#include <stdint.h>
 
 /* Bit fiddling routines copied from msun/src/math_private.h,v 1.15 */
 
diff --git a/lib/libc/gen/modf.c b/lib/libc/gen/modf.c
index 4e1b80599b..4b8d26e904 100644
--- a/lib/libc/gen/modf.c
+++ b/lib/libc/gen/modf.c
@@ -24,6 +24,7 @@
 #include <sys/types.h>
 #include <machine/endian.h>
 #include <math.h>
+#include <stdint.h>
 
 /* Bit fiddling routines copied from msun/src/math_private.h,v 1.15 */
 
diff --git a/lib/libc/gen/popen.c b/lib/libc/gen/popen.c
index 2e016780b8..a0d5c83cc5 100644
--- a/lib/libc/gen/popen.c
+++ b/lib/libc/gen/popen.c
@@ -31,7 +31,6 @@
  *
  * @(#)popen.c	8.3 (Berkeley) 5/3/95
  * $FreeBSD: src/lib/libc/gen/popen.c,v 1.20 2008/07/29 16:29:59 ed Exp $
- * $DragonFly: src/lib/libc/gen/popen.3,v 1.4 2006/04/08 08:17:06 swildner Exp $
  */
 
 #include "namespace.h"
@@ -42,6 +41,7 @@
 #include <signal.h>
 #include <errno.h>
 #include <unistd.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/lib/libc/gen/setproctitle.c b/lib/libc/gen/setproctitle.c
index a1cd166a54..e30739920b 100644
--- a/lib/libc/gen/setproctitle.c
+++ b/lib/libc/gen/setproctitle.c
@@ -15,7 +15,6 @@
  *    Peter Wemm.
  *
  * $FreeBSD: src/lib/libc/gen/setproctitle.c,v 1.18 2003/07/01 09:45:35 alfred Exp $
- * $DragonFly: src/lib/libc/gen/setproctitle.c,v 1.5 2005/11/13 00:07:42 swildner Exp $
  */
 
 #include "namespace.h"
@@ -24,9 +23,9 @@
 #include <sys/exec.h>
 #include <sys/sysctl.h>
 
+#include <vm/pmap.h>
 #include <vm/vm.h>
 #include <vm/vm_param.h>
-#include <vm/pmap.h>
 
 #include <stdio.h>
 #include <string.h>
diff --git a/lib/libc/gen/ucontext.c b/lib/libc/gen/ucontext.c
index b193ef87c8..02a2f53785 100644
--- a/lib/libc/gen/ucontext.c
+++ b/lib/libc/gen/ucontext.c
@@ -31,6 +31,7 @@
 
 #include <errno.h>
 #include <stdarg.h>
+#include <stdint.h>
 #include <stdlib.h>
 #include <unistd.h>
 #include <signal.h>
diff --git a/lib/libc/gen/vis.c b/lib/libc/gen/vis.c
index 42f6d03df3..4f8658773f 100644
--- a/lib/libc/gen/vis.c
+++ b/lib/libc/gen/vis.c
@@ -63,6 +63,7 @@
 #include <assert.h>
 #include <vis.h>
 #include <errno.h>
+#include <stdint.h>
 #include <stdlib.h>
 #include <wchar.h>
 #include <wctype.h>
diff --git a/lib/libc/include/libc_private.h b/lib/libc/include/libc_private.h
index c3459e2a57..895b67b67f 100644
--- a/lib/libc/include/libc_private.h
+++ b/lib/libc/include/libc_private.h
@@ -35,8 +35,8 @@
 #ifndef _LIBC_PRIVATE_H_
 #define _LIBC_PRIVATE_H_
 
-#include <machine/types.h>
 #include <sys/_pthreadtypes.h>
+#include <machine/stdint.h>
 
 /*
  * This global flag is non-zero when a process has created one
diff --git a/lib/libc/locale/rune.c b/lib/libc/locale/rune.c
index 0641cea956..dcd5e3ffb2 100644
--- a/lib/libc/locale/rune.c
+++ b/lib/libc/locale/rune.c
@@ -38,6 +38,7 @@
 #include "namespace.h"
 #include <errno.h>
 #include <runetype.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <string.h>
 #include <stdlib.h>
diff --git a/lib/libc/net/nsdispatch.c b/lib/libc/net/nsdispatch.c
index 897a1f78a7..c8b68bece1 100644
--- a/lib/libc/net/nsdispatch.c
+++ b/lib/libc/net/nsdispatch.c
@@ -79,6 +79,7 @@
 #define _NS_PRIVATE
 #include <nsswitch.h>
 #include <pthread.h>
+#include <stdint.h>	/* for uinptr_t in __DECONST() */
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/lib/libc/net/ntoh.c b/lib/libc/net/ntoh.c
index be0c51b165..fd212beb1b 100644
--- a/lib/libc/net/ntoh.c
+++ b/lib/libc/net/ntoh.c
@@ -27,6 +27,7 @@
  */
 
 #include <sys/endian.h>
+#include <stdint.h>
 
 uint32_t
 htonl(uint32_t hl)
diff --git a/lib/libc/stdio/mktemp.c b/lib/libc/stdio/mktemp.c
index 28d70021db..4470d9df5e 100644
--- a/lib/libc/stdio/mktemp.c
+++ b/lib/libc/stdio/mktemp.c
@@ -28,7 +28,6 @@
  *
  * @(#)mktemp.c	8.1 (Berkeley) 6/4/93
  * $FreeBSD: src/lib/libc/stdio/mktemp.c,v 1.31 2008/07/28 21:18:59 jhb Exp $
- * $DragonFly: src/lib/libc/stdio/mktemp.c,v 1.7 2005/11/20 11:07:30 swildner Exp $
  */
 
 #include "namespace.h"
@@ -36,6 +35,7 @@
 #include <sys/stat.h>
 #include <fcntl.h>
 #include <errno.h>
+#include <stdint.h>	/* for uint32_t */
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/lib/libc/stdlib/bsearch.c b/lib/libc/stdlib/bsearch.c
index 10fd11a6d4..92769de50f 100644
--- a/lib/libc/stdlib/bsearch.c
+++ b/lib/libc/stdlib/bsearch.c
@@ -28,10 +28,10 @@
  *
  * @(#)bsearch.c	8.1 (Berkeley) 6/4/93
  * $FreeBSD: src/lib/libc/stdlib/bsearch.c,v 1.4 2007/01/09 00:28:09 imp Exp $
- * $DragonFly: src/lib/libc/stdlib/bsearch.c,v 1.5 2005/11/20 12:37:48 swildner Exp $
  */
 
 #include <stddef.h>
+#include <stdint.h>
 #include <stdlib.h>
 
 /*
diff --git a/lib/libc/stdlib/getopt_long.c b/lib/libc/stdlib/getopt_long.c
index e27326f231..fdf13e7ef7 100644
--- a/lib/libc/stdlib/getopt_long.c
+++ b/lib/libc/stdlib/getopt_long.c
@@ -56,12 +56,12 @@
  * POSSIBILITY OF SUCH DAMAGE.
  *
  * $FreeBSD: src/lib/libc/stdlib/getopt_long.c,v 1.15 2006/09/23 14:48:31 ache Exp $
- * $DragonFly: src/lib/libc/stdlib/getopt_long.c,v 1.14 2005/11/20 12:37:48 swildner Exp $
  */
 
 #include <err.h>
 #include <errno.h>
 #include <getopt.h>
+#include <stdint.h>
 #include <stdlib.h>
 #include <string.h>
 
diff --git a/lib/libc/stdlib/hcreate.c b/lib/libc/stdlib/hcreate.c
index 2d542e8818..b662359598 100644
--- a/lib/libc/stdlib/hcreate.c
+++ b/lib/libc/stdlib/hcreate.c
@@ -1,7 +1,7 @@
 /*
  * Copyright (c) 2001 Christopher G. Demetriou
  * All rights reserved.
- * 
+ *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
@@ -17,7 +17,7 @@
  *          information about NetBSD.
  * 4. The name of the author may not be used to endorse or promote products
  *    derived from this software without specific prior written permission.
- * 
+ *
  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
@@ -28,12 +28,11 @@
  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
- * 
+ *
  * <<Id: LICENSE,v 1.2 2000/06/14 15:57:33 cgd Exp>>
  *
  * $NetBSD: hcreate.c,v 1.2 2001/02/19 21:26:04 ross Exp $
  * $FreeBSD: src/lib/libc/stdlib/hcreate.c,v 1.4 2008/07/06 11:31:20 danger Exp $
- * $DragonFly: src/lib/libc/stdlib/hcreate.c,v 1.2 2003/06/17 04:26:46 dillon Exp $
  */
 
 /*
@@ -52,6 +51,7 @@
 #include <sys/queue.h>
 #include <errno.h>
 #include <search.h>
+#include <stdint.h>
 #include <stdlib.h>
 #include <string.h>
 
@@ -107,7 +107,7 @@ hcreate(size_t nel)
 			nel >>= 1;
 		nel = 1 << p2;
 	}
-	
+
 	/* Allocate the table. */
 	htablesize = nel;
 	htable = malloc(htablesize * sizeof htable[0]);
diff --git a/lib/libc/stdlib/tsearch.c b/lib/libc/stdlib/tsearch.c
index 94615257aa..2dc2264991 100644
--- a/lib/libc/stdlib/tsearch.c
+++ b/lib/libc/stdlib/tsearch.c
@@ -14,6 +14,7 @@
 
 #define _SEARCH_PRIVATE
 #include <search.h>
+#include <stdint.h>
 #include <stdlib.h>
 
 /*
diff --git a/lib/libc/string/bcopy.c b/lib/libc/string/bcopy.c
index 91acab54d2..7c4fc66dbf 100644
--- a/lib/libc/string/bcopy.c
+++ b/lib/libc/string/bcopy.c
@@ -34,6 +34,7 @@
  */
 
 #include <sys/types.h>
+#include <stdint.h>
 
 /*
  * sizeof(word) MUST BE A POWER OF TWO
diff --git a/lib/libc/upmap/upmap.h b/lib/libc/upmap/upmap.h
index 99d2cc5b8a..3d57448361 100644
--- a/lib/libc/upmap/upmap.h
+++ b/lib/libc/upmap/upmap.h
@@ -35,9 +35,8 @@
 #ifndef	_UPMAP_H_
 #define	_UPMAP_H_
 
-#ifndef _SYS_TYPES_H_
-#include <sys/types.h>
-#endif
+#include <stdarg.h>
+#include <stdint.h>
 
 void __kpmap_map(void *datap, int *state, uint16_t type);
 void __upmap_map(void *datap, int *state, uint16_t type);
diff --git a/lib/libcam/camlib.c b/lib/libcam/camlib.c
index febd00d96a..7ca3112e07 100644
--- a/lib/libcam/camlib.c
+++ b/lib/libcam/camlib.c
@@ -27,6 +27,7 @@
 
 #include <sys/types.h>
 #include <sys/param.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/lib/libcompat/4.3/re_comp.c b/lib/libcompat/4.3/re_comp.c
index eebf068e3b..5cdc8c0648 100644
--- a/lib/libcompat/4.3/re_comp.c
+++ b/lib/libcompat/4.3/re_comp.c
@@ -42,6 +42,7 @@
 
 #include <regex.h>
 #include <stddef.h>
+#include <stdint.h>
 #include <unistd.h>
 
 static regex_t re_regexp;
diff --git a/lib/libcrypt/crypt-des.c b/lib/libcrypt/crypt-des.c
index 2189a82ca9..d7ab6ac69b 100644
--- a/lib/libcrypt/crypt-des.c
+++ b/lib/libcrypt/crypt-des.c
@@ -60,6 +60,7 @@
 #include <sys/types.h>
 #include <sys/param.h>
 #include <pwd.h>
+#include <stdint.h>
 #include <string.h>
 #include "crypt.h"
 #include "local_xsi.h"
diff --git a/lib/libcrypt/deprecated-crypt-sha256.c b/lib/libcrypt/deprecated-crypt-sha256.c
index dc4b2d6911..35d1194d01 100644
--- a/lib/libcrypt/deprecated-crypt-sha256.c
+++ b/lib/libcrypt/deprecated-crypt-sha256.c
@@ -34,6 +34,7 @@
  */
 
 #include <sys/types.h>
+#include <stdint.h>
 #include <string.h>
 
 #include "crypt.h"
@@ -44,7 +45,7 @@
  */
 
 #define SHA256_SIZE 32
- 
+
 char*
 crypt_deprecated_sha256(const char *pw, const char *salt)
 {
@@ -79,30 +80,30 @@ crypt_deprecated_sha256(const char *pw, const char *salt)
 
 	/* Get the actual salt length. */
 	sl = ep - sp;
-	
+
 	__crypt__sha256_init_ctx(&ctx);
 
 	/* Hash in the password first. */
 	__crypt__sha256_process_bytes(pw, strlen(pw), &ctx);
-	
+
         /*
          * Then the magic string
          *
          * XXX: sizeof instead of strlen, must retain
          */
 	__crypt__sha256_process_bytes(magic, sizeof(magic), &ctx);
-	
+
 	/* Then the raw salt. */
 	__crypt__sha256_process_bytes(sp, sl, &ctx);
-	
+
 	/* Finish and create the output string. */
 	__crypt__sha256_finish_ctx(&ctx, final);
 	strcpy(passwd, magic);
 	strncat(passwd, sp, sl);
 	strcat(passwd, "$");
-	
+
 	p = passwd + strlen(passwd);
-	
+
 	l = (final[ 0] << 16) | (final[11] << 8) | final[21];
 	_crypt_to64(p, l, 4); p += 4;
 	l = (final[ 1] << 16) | (final[12] << 8) | final[22];
@@ -126,7 +127,7 @@ crypt_deprecated_sha256(const char *pw, const char *salt)
 	l = (final[10] << 16) | (final[31] << 8);
 	_crypt_to64(p, l, 4); p += 4;
 	*p = '\0';
-	
+
 	/* Clear memory. */
 	memset(final, 0, sizeof(final));
 
diff --git a/lib/libcrypt/deprecated-crypt-sha512.c b/lib/libcrypt/deprecated-crypt-sha512.c
index f710eeec3b..0f992be269 100644
--- a/lib/libcrypt/deprecated-crypt-sha512.c
+++ b/lib/libcrypt/deprecated-crypt-sha512.c
@@ -34,6 +34,7 @@
  */
 
 #include <sys/types.h>
+#include <stdint.h>
 #include <string.h>
 
 #include "crypt.h"
@@ -44,7 +45,7 @@
  */
 
 #define SHA512_SIZE 64
- 
+
 char*
 crypt_deprecated_sha512(const char *pw, const char *salt)
 {
@@ -79,30 +80,30 @@ crypt_deprecated_sha512(const char *pw, const char *salt)
 
 	/* Get the actual salt length. */
 	sl = ep - sp;
-	
+
 	__crypt__sha512_init_ctx(&ctx);
-	
+
 	/* Hash in the password first. */
 	__crypt__sha512_process_bytes(pw, strlen(pw), &ctx);
-	
+
 	/*
 	 * Then the magic string
 	 *
 	 * XXX: sizeof instead of strlen, must retain
 	 */
 	__crypt__sha512_process_bytes(magic, sizeof(magic), &ctx);
-	
+
 	/* Then the raw salt. */
 	__crypt__sha512_process_bytes(sp, sl, &ctx);
-	
+
 	/* Finish and create the output string. */
 	__crypt__sha512_finish_ctx(&ctx, final);
 	strcpy(passwd, magic);
 	strncat(passwd, sp, sl);
 	strcat(passwd, "$");
-	
+
 	p = passwd + strlen(passwd);
-	
+
 	/*
 	 * For-loop form of the algorithm in sha256.c;
 	 * breaks the final output up into 3cols and then base64's each row.
@@ -114,9 +115,9 @@ crypt_deprecated_sha512(const char *pw, const char *salt)
 	l = (final[20] << 16) | (final[41] << 8);
 	_crypt_to64(p, l, 4); p += 4;
 	*p = '\0';
-	
+
 	/* Clear memory. */
 	memset(final, 0, sizeof(final));
-	
+
 	return (passwd);
 }
diff --git a/lib/libdevinfo/devinfo.h b/lib/libdevinfo/devinfo.h
index 9723f7cd57..923d42a0dd 100644
--- a/lib/libdevinfo/devinfo.h
+++ b/lib/libdevinfo/devinfo.h
@@ -25,7 +25,6 @@
  * SUCH DAMAGE.
  *
  * $FreeBSD: src/lib/libdevinfo/devinfo.h,v 1.5 2005/08/31 14:57:39 rodrigc Exp $
- * $DragonFly: src/lib/libdevinfo/devinfo.h,v 1.1 2008/09/30 12:20:29 hasso Exp $
  */
 
 #ifndef _DEVINFO_H_INCLUDED
@@ -33,6 +32,7 @@
 
 #include <sys/cdefs.h>
 #include <sys/types.h>
+#include <stdint.h>
 
 typedef __uintptr_t	devinfo_handle_t;
 #define DEVINFO_ROOT_DEVICE	((devinfo_handle_t)0)
@@ -69,7 +69,7 @@ struct devinfo_rman {
 
 	unsigned long		dm_start;	/* resource start */
 	unsigned long		dm_size;	/* resource size */
-    
+
 	char			*dm_desc;	/* resource description */
 };
 
@@ -114,8 +114,8 @@ extern struct devinfo_rman
  * (fn) returns nonzero, abort the scan and return.
  */
 extern int
-	devinfo_foreach_device_child(struct devinfo_dev *parent, 
-	    int (* fn)(struct devinfo_dev *child, void *arg), 
+	devinfo_foreach_device_child(struct devinfo_dev *parent,
+	    int (* fn)(struct devinfo_dev *child, void *arg),
 	    void *arg);
 
 /*
@@ -124,7 +124,7 @@ extern int
  */
 extern int
 	devinfo_foreach_device_resource(struct devinfo_dev *dev,
-	    int (* fn)(struct devinfo_dev *dev, 
+	    int (* fn)(struct devinfo_dev *dev,
 	    struct devinfo_res *res, void *arg),
 	    void *arg);
 
diff --git a/lib/libevtr/evtr.c b/lib/libevtr/evtr.c
index 5e6daf4efe..8160f36b7b 100644
--- a/lib/libevtr/evtr.c
+++ b/lib/libevtr/evtr.c
@@ -1,10 +1,10 @@
 /*
  * Copyright (c) 2009, 2010 Aggelos Economopoulos.  All rights reserved.
- * 
+ *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
- * 
+ *
  * 1. Redistributions of source code must retain the above copyright
  *    notice, this list of conditions and the following disclaimer.
  * 2. Redistributions in binary form must reproduce the above copyright
@@ -14,7 +14,7 @@
  * 3. Neither the name of The DragonFly Project nor the names of its
  *    contributors may be used to endorse or promote products derived
  *    from this software without specific, prior written permission.
- * 
+ *
  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
@@ -35,6 +35,7 @@
 #include <errno.h>
 #include <limits.h>
 #include <stdarg.h>
+#include <stddef.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
@@ -1030,7 +1031,7 @@ evtr_dump_fmt(evtr_t evtr, uint64_t ts, const evtr_event_t ev)
 
 /*
  * Replace string pointers or string ids in fmtdata
- */ 
+ */
 static
 int
 mangle_string_ptrs(const char *fmt, uint8_t *fmtdata,
@@ -1684,7 +1685,7 @@ int
 evtr_skip_to_record(evtr_t evtr)
 {
 	int skip;
-	
+
 	skip = REC_ALIGN - (evtr->bytes % REC_ALIGN);
 	if (skip > 0) {
 		if (fseek(evtr->f, skip, SEEK_CUR)) {
@@ -1955,7 +1956,7 @@ void
 evtr_query_destroy(struct evtr_query *q)
 {
 	evtr_deregister_filters(q, q->filt, q->nfilt);
-		
+
 	free(q->buf);
 	free(q);
 }
diff --git a/lib/libfsid/libfsid.h b/lib/libfsid/libfsid.h
index 9649a4a1fd..50e587116b 100644
--- a/lib/libfsid/libfsid.h
+++ b/lib/libfsid/libfsid.h
@@ -40,6 +40,7 @@
 
 #include <err.h>
 #include <fcntl.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/lib/libhammer/libhammer.h b/lib/libhammer/libhammer.h
index 522f1e76c9..ba6ca069b0 100644
--- a/lib/libhammer/libhammer.h
+++ b/lib/libhammer/libhammer.h
@@ -39,6 +39,7 @@
 
 #include <sys/queue.h>
 #include <sys/param.h>
+#include <stdint.h>
 
 #include <vfs/hammer/hammer_disk.h>
 #include <vfs/hammer/hammer_ioctl.h>
diff --git a/lib/libkiconv/quirks.c b/lib/libkiconv/quirks.c
index a502c784b1..24ddc03a5b 100644
--- a/lib/libkiconv/quirks.c
+++ b/lib/libkiconv/quirks.c
@@ -38,7 +38,7 @@
  * Since each vendors has their own Unicode mapping rules,
  * we need some quirks until iconv(3) supports them.
  * We can define Microsoft mappings here.
- * 
+ *
  * For example, the eucJP and Unocode mapping rule is based on
  * the JIS standard. Since Microsoft uses cp932 for Unicode mapping
  * which is not truly based on the JIS standard, reading a file
@@ -55,6 +55,7 @@
 #include <sys/types.h>
 #include <sys/iconv.h>
 
+#include <stdint.h>
 #include <stdio.h>
 #include <string.h>
 
diff --git a/lib/libkiconv/xlat16_iconv.c b/lib/libkiconv/xlat16_iconv.c
index c843e7c377..9b2aeebd49 100644
--- a/lib/libkiconv/xlat16_iconv.c
+++ b/lib/libkiconv/xlat16_iconv.c
@@ -43,6 +43,7 @@
 #include <errno.h>
 #include <iconv.h>
 #include <locale.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/lib/libkvm/kvm_minidump_x86_64.c b/lib/libkvm/kvm_minidump_x86_64.c
index 753d9eaddc..1d8e959579 100644
--- a/lib/libkvm/kvm_minidump_x86_64.c
+++ b/lib/libkvm/kvm_minidump_x86_64.c
@@ -39,6 +39,7 @@
 #include <unistd.h>
 #include <nlist.h>
 
+#include <cpu/pmap.h>
 #include <vm/vm.h>
 #include <vm/vm_param.h>
 
diff --git a/lib/libkvm/kvm_proc.c b/lib/libkvm/kvm_proc.c
index 96864245bb..9cfc9e3de0 100644
--- a/lib/libkvm/kvm_proc.c
+++ b/lib/libkvm/kvm_proc.c
@@ -59,6 +59,7 @@
 #include <unistd.h>
 #include <nlist.h>
 
+#include <cpu/pmap.h>
 #include <vm/vm.h>
 #include <vm/vm_param.h>
 #include <vm/swap_pager.h>
diff --git a/lib/libkvm/kvm_x86_64.c b/lib/libkvm/kvm_x86_64.c
index 7f40752e5b..e88b24a738 100644
--- a/lib/libkvm/kvm_x86_64.c
+++ b/lib/libkvm/kvm_x86_64.c
@@ -50,6 +50,7 @@
 #include <unistd.h>
 #include <nlist.h>
 
+#include <cpu/pmap.h>
 #include <vm/vm.h>
 #include <vm/vm_param.h>
 
diff --git a/lib/libsdp/sdp.h b/lib/libsdp/sdp.h
index a54fac7872..d8fa7bd26f 100644
--- a/lib/libsdp/sdp.h
+++ b/lib/libsdp/sdp.h
@@ -1,5 +1,4 @@
 /* $NetBSD: sdp.h,v 1.2 2006/08/17 20:13:31 plunky Exp $ */
-/* $DragonFly: src/lib/libsdp/sdp.h,v 1.2 2008/09/30 16:57:05 swildner Exp $ */
 
 /*-
  * Copyright (c) 2006 Itronix Inc.
@@ -66,6 +65,7 @@
 #define _SDP_H_
 
 #include <string.h>
+#include <stdint.h>
 
 __BEGIN_DECLS
 
diff --git a/lib/libstand/printf.c b/lib/libstand/printf.c
index fdc9858249..030f738700 100644
--- a/lib/libstand/printf.c
+++ b/lib/libstand/printf.c
@@ -42,6 +42,7 @@
 #include <sys/types.h>
 #include <sys/stdint.h>
 #include <limits.h>
+#include <stddef.h>
 #include <string.h>
 #include "stand.h"
 
diff --git a/lib/libthread_xu/thread/thr_private.h b/lib/libthread_xu/thread/thr_private.h
index 72e5afa9dc..86edcd88d3 100644
--- a/lib/libthread_xu/thread/thr_private.h
+++ b/lib/libthread_xu/thread/thr_private.h
@@ -45,10 +45,10 @@
 #include <sys/rtprio.h>
 #include <sys/mman.h>
 #include <machine/atomic.h>
-#include <machine/cpumask.h>
 #include <errno.h>
 #include <limits.h>
 #include <signal.h>
+#include <sys/cpumask.h>
 #include <sys/sched.h>
 #include <stdarg.h>
 #include <unistd.h>
diff --git a/lib/libutil/libutil.h b/lib/libutil/libutil.h
index f501a5d81a..d3d6bb0f8b 100644
--- a/lib/libutil/libutil.h
+++ b/lib/libutil/libutil.h
@@ -40,6 +40,7 @@
 #define	_LIBUTIL_H_
 
 #include <sys/types.h>
+#include <stdint.h>
 
 #ifdef _PWD_H_
 #define	_PWSCAN_MASTER	0x01
diff --git a/libexec/bootpd/bptypes.h b/libexec/bootpd/bptypes.h
index 0783009f59..08c08e14f1 100644
--- a/libexec/bootpd/bptypes.h
+++ b/libexec/bootpd/bptypes.h
@@ -1,11 +1,11 @@
 /* $FreeBSD: src/libexec/bootpd/bptypes.h,v 1.2 1999/11/12 10:11:48 marcel Exp $
- * $DragonFly: src/libexec/bootpd/bptypes.h,v 1.3 2008/08/22 14:47:47 swildner Exp $
  */
 
 #ifndef	BPTYPES_H
 #define	BPTYPES_H
 
 #include <sys/types.h>
+#include <stdint.h>
 
 /*
  * 32 bit integers are different types on various architectures
diff --git a/libexec/talkd/announce.c b/libexec/talkd/announce.c
index 568d2248c1..6f87831e9f 100644
--- a/libexec/talkd/announce.c
+++ b/libexec/talkd/announce.c
@@ -37,6 +37,7 @@
 #include <sys/wait.h>
 #include <sys/socket.h>
 
+#include <stdint.h>
 #include <protocols/talkd.h>
 
 #include <errno.h>
diff --git a/libexec/talkd/print.c b/libexec/talkd/print.c
index faf6c8a300..6b06311263 100644
--- a/libexec/talkd/print.c
+++ b/libexec/talkd/print.c
@@ -35,9 +35,10 @@
 #include <sys/param.h>
 #include <sys/types.h>
 #include <sys/socket.h>
-#include <protocols/talkd.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <syslog.h>
+#include <protocols/talkd.h>
 
 #include "extern.h"
 
diff --git a/libexec/talkd/table.c b/libexec/talkd/table.c
index 1c3472c98b..69b188a18d 100644
--- a/libexec/talkd/table.c
+++ b/libexec/talkd/table.c
@@ -41,12 +41,13 @@
 #include <sys/param.h>
 #include <sys/time.h>
 #include <sys/socket.h>
-#include <protocols/talkd.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
 #include <syslog.h>
 #include <unistd.h>
+#include <protocols/talkd.h>
 
 #include "extern.h"
 
diff --git a/libexec/talkd/talkd.c b/libexec/talkd/talkd.c
index f1e1c46f7b..c05536eff9 100644
--- a/libexec/talkd/talkd.c
+++ b/libexec/talkd/talkd.c
@@ -40,17 +40,18 @@
 #include <sys/types.h>
 #include <sys/socket.h>
 #include <sys/param.h>
-#include <protocols/talkd.h>
 #include <err.h>
 #include <errno.h>
 #include <paths.h>
 #include <signal.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
 #include <syslog.h>
 #include <time.h>
 #include <unistd.h>
+#include <protocols/talkd.h>
 
 #include "extern.h"
 
diff --git a/sbin/badsect/badsect.c b/sbin/badsect/badsect.c
index aa054ed722..eb262a0135 100644
--- a/sbin/badsect/badsect.c
+++ b/sbin/badsect/badsect.c
@@ -29,7 +29,6 @@
  * @(#) Copyright (c) 1981, 1983, 1993 The Regents of the University of California.  All rights reserved.
  * @(#)badsect.c	8.1 (Berkeley) 6/5/93
  * $FreeBSD: src/sbin/badsect/badsect.c,v 1.7.2.2 2001/07/30 10:30:04 dd Exp $
- * $DragonFly: src/sbin/badsect/badsect.c,v 1.11 2006/04/03 01:58:46 dillon Exp $
  */
 
 /*
@@ -45,6 +44,7 @@
 #include <sys/param.h>
 #include <sys/stat.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/fs.h>
 
diff --git a/sbin/camcontrol/modeedit.c b/sbin/camcontrol/modeedit.c
index 335873ec90..a3582b7f1e 100644
--- a/sbin/camcontrol/modeedit.c
+++ b/sbin/camcontrol/modeedit.c
@@ -12,16 +12,16 @@
  *    without modification, immediately at the beginning of the file.
  * 2. Redistributions in binary form must reproduce the above copyright
  *    notice, this list of conditions and the following disclaimer in the
- *    documentation and/or other materials provided with the distribution. 
- *    
+ *    documentation and/or other materials provided with the distribution.
+ *
  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
- * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  
+ * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
- * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  
+ * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  *
@@ -35,6 +35,7 @@
 #include <ctype.h>
 #include <err.h>
 #include <errno.h>
+#include <stdint.h>
 #include <stdlib.h>
 #include <string.h>
 #include <stdio.h>
@@ -899,7 +900,7 @@ mode_list(struct cam_device *device, int page_control, int dbd,
 			printf("0x%02x\n", mph->page_code);
 		else
 			printf("0x%02x\t%s\n", mph->page_code,
-			    nameentry->name); 
+			    nameentry->name);
 		len += mph->page_length + sizeof(*mph);
 	}
 }
diff --git a/sbin/clri/clri.c b/sbin/clri/clri.c
index 0e8a87b464..d920ebd5c1 100644
--- a/sbin/clri/clri.c
+++ b/sbin/clri/clri.c
@@ -32,11 +32,11 @@
  * @(#) Copyright (c) 1990, 1993 The Regents of the University of California.  All rights reserved.
  * @(#)clri.c	8.2 (Berkeley) 9/23/93
  * $FreeBSD: src/sbin/clri/clri.c,v 1.4 1999/08/28 00:12:32 peter Exp $
- * $DragonFly: src/sbin/clri/clri.c,v 1.8 2006/04/03 01:58:48 dillon Exp $
  */
 
 #include <sys/param.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/fs.h>
 
diff --git a/sbin/disklabel64/crc32.c b/sbin/disklabel64/crc32.c
index e3d6fbed68..75c5f30c4c 100644
--- a/sbin/disklabel64/crc32.c
+++ b/sbin/disklabel64/crc32.c
@@ -26,10 +26,10 @@
  * CRC32 code derived from work by Gary S. Brown.
  *
  * $FreeBSD: src/sbin/gpt/gpt.c,v 1.16 2006/07/07 02:44:23 marcel Exp $
- * $DragonFly: src/sbin/disklabel64/crc32.c,v 1.2 2008/11/03 00:25:45 pavalos Exp $
  */
 
 #include <sys/types.h>
+#include <stdint.h>
 
 uint32_t	crc32(const void *, size_t);
 
diff --git a/sbin/dump/cache.c b/sbin/dump/cache.c
index c68de27d92..18388251b9 100644
--- a/sbin/dump/cache.c
+++ b/sbin/dump/cache.c
@@ -41,6 +41,7 @@
 #include <sys/stat.h>
 #include <sys/mman.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dir.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/fs.h>
diff --git a/sbin/dump/itime.c b/sbin/dump/itime.c
index 0074086a5b..bb5cc90836 100644
--- a/sbin/dump/itime.c
+++ b/sbin/dump/itime.c
@@ -34,6 +34,7 @@
 #include <sys/queue.h>
 #include <sys/time.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/fs.h>
 
diff --git a/sbin/dump/main.c b/sbin/dump/main.c
index 5134c04bb2..5366998615 100644
--- a/sbin/dump/main.c
+++ b/sbin/dump/main.c
@@ -34,6 +34,7 @@
 #include <sys/param.h>
 #include <sys/stat.h>
 #include <sys/time.h>
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/fs.h>
 
diff --git a/sbin/dump/optr.c b/sbin/dump/optr.c
index cc9f0c0eba..380966b174 100644
--- a/sbin/dump/optr.c
+++ b/sbin/dump/optr.c
@@ -38,6 +38,7 @@
 #include <errno.h>
 #include <fstab.h>
 #include <grp.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
@@ -345,7 +346,7 @@ fstabsearch(const char *key)
 /*
  *	Tell the operator what to do
  *
- * char arg: w ==> just what to do; W ==> most recent dumps 
+ * char arg: w ==> just what to do; W ==> most recent dumps
  */
 void
 lastdump(int arg)
diff --git a/sbin/dump/tape.c b/sbin/dump/tape.c
index 6856da5e29..8ab5b48b4c 100644
--- a/sbin/dump/tape.c
+++ b/sbin/dump/tape.c
@@ -35,6 +35,7 @@
 #include <sys/time.h>
 #include <sys/wait.h>
 #include <sys/stat.h>
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/fs.h>
 
diff --git a/sbin/dump/traverse.c b/sbin/dump/traverse.c
index e606be014a..810bb4c3eb 100644
--- a/sbin/dump/traverse.c
+++ b/sbin/dump/traverse.c
@@ -32,6 +32,7 @@
 
 #include <sys/param.h>
 #include <sys/stat.h>
+#include <stdint.h>
 #include <vfs/ufs/dir.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/fs.h>
diff --git a/sbin/dump/unctime.c b/sbin/dump/unctime.c
index 8915788368..7871876e0b 100644
--- a/sbin/dump/unctime.c
+++ b/sbin/dump/unctime.c
@@ -28,11 +28,11 @@
  *
  * @(#)unctime.c	8.2 (Berkeley) 6/14/94
  * $FreeBSD: src/sbin/dump/unctime.c,v 1.3.2.1 2001/09/19 09:29:39 ru Exp $
- * $DragonFly: src/sbin/dump/unctime.c,v 1.6 2005/08/28 04:35:12 dillon Exp $
  */
 
 #include <sys/types.h>
 #include <time.h>
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 
 #include "dump.h"
diff --git a/sbin/dumpfs/dumpfs.c b/sbin/dumpfs/dumpfs.c
index 13c7dce7f3..22cf6235d0 100644
--- a/sbin/dumpfs/dumpfs.c
+++ b/sbin/dumpfs/dumpfs.c
@@ -34,6 +34,7 @@
 #include <sys/param.h>
 #include <sys/time.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/fs.h>
 
diff --git a/sbin/fsck/dir.c b/sbin/fsck/dir.c
index 95a556171c..1d7cf8a720 100644
--- a/sbin/fsck/dir.c
+++ b/sbin/fsck/dir.c
@@ -33,6 +33,7 @@
 #include <sys/param.h>
 #include <sys/time.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/dir.h>
 #include <vfs/ufs/fs.h>
diff --git a/sbin/fsck/fsck.h b/sbin/fsck/fsck.h
index 7d5c78dba9..b90ae39a03 100644
--- a/sbin/fsck/fsck.h
+++ b/sbin/fsck/fsck.h
@@ -32,6 +32,7 @@
 
 #include <unistd.h>
 #include <stdlib.h>
+#include <stdint.h>
 #include <stdio.h>
 
 #define	MAXDUP		10	/* limit on dup blks (per inode) */
diff --git a/sbin/fsck/inode.c b/sbin/fsck/inode.c
index f19d0d7920..8ea95fd36f 100644
--- a/sbin/fsck/inode.c
+++ b/sbin/fsck/inode.c
@@ -33,6 +33,7 @@
 #include <sys/param.h>
 #include <sys/time.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/dir.h>
 #include <vfs/ufs/fs.h>
diff --git a/sbin/fsck/pass1.c b/sbin/fsck/pass1.c
index efa9d9ec67..bd7067a5f1 100644
--- a/sbin/fsck/pass1.c
+++ b/sbin/fsck/pass1.c
@@ -32,6 +32,7 @@
 
 #include <sys/param.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/dir.h>
 #include <vfs/ufs/fs.h>
diff --git a/sbin/fsck/pass1b.c b/sbin/fsck/pass1b.c
index 19239df610..24132ceaf4 100644
--- a/sbin/fsck/pass1b.c
+++ b/sbin/fsck/pass1b.c
@@ -32,6 +32,7 @@
 
 #include <sys/param.h>
 
+#include <sys/stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/fs.h>
 
diff --git a/sbin/fsck/pass2.c b/sbin/fsck/pass2.c
index b713b505df..734f6915b2 100644
--- a/sbin/fsck/pass2.c
+++ b/sbin/fsck/pass2.c
@@ -32,6 +32,7 @@
 
 #include <sys/param.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/dir.h>
 
diff --git a/sbin/fsck/pass3.c b/sbin/fsck/pass3.c
index ddde30e455..819bc0dde0 100644
--- a/sbin/fsck/pass3.c
+++ b/sbin/fsck/pass3.c
@@ -32,6 +32,7 @@
 
 #include <sys/param.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/dir.h>
 #include <vfs/ufs/fs.h>
diff --git a/sbin/fsck/pass4.c b/sbin/fsck/pass4.c
index a8fdb75f52..00603f4a7d 100644
--- a/sbin/fsck/pass4.c
+++ b/sbin/fsck/pass4.c
@@ -32,6 +32,7 @@
 
 #include <sys/param.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/fs.h>
 
diff --git a/sbin/fsck/pass5.c b/sbin/fsck/pass5.c
index c91a674bdd..6cab406d59 100644
--- a/sbin/fsck/pass5.c
+++ b/sbin/fsck/pass5.c
@@ -32,6 +32,7 @@
 
 #include <sys/param.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/fs.h>
 
diff --git a/sbin/fsck/preen.c b/sbin/fsck/preen.c
index e5676f22dd..b6d4dfb6e9 100644
--- a/sbin/fsck/preen.c
+++ b/sbin/fsck/preen.c
@@ -34,6 +34,7 @@
 #include <sys/stat.h>
 #include <sys/wait.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 
 #include <ctype.h>
diff --git a/sbin/fsck/setup.c b/sbin/fsck/setup.c
index 3c2126cacb..fe517a3c71 100644
--- a/sbin/fsck/setup.c
+++ b/sbin/fsck/setup.c
@@ -36,6 +36,7 @@
 #include <sys/diskslice.h>
 #include <sys/file.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/fs.h>
 
diff --git a/sbin/fsck/utilities.c b/sbin/fsck/utilities.c
index da7181f413..d3c1ea385d 100644
--- a/sbin/fsck/utilities.c
+++ b/sbin/fsck/utilities.c
@@ -32,6 +32,7 @@
 
 #include <sys/param.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/dir.h>
 #include <vfs/ufs/fs.h>
diff --git a/sbin/fsck_msdosfs/ext.h b/sbin/fsck_msdosfs/ext.h
index c7e3dc6fe6..a6d095602a 100644
--- a/sbin/fsck_msdosfs/ext.h
+++ b/sbin/fsck_msdosfs/ext.h
@@ -31,6 +31,7 @@
 #define	EXT_H
 
 #include <sys/types.h>
+#include <stdint.h>
 
 #include "dosfs.h"
 
diff --git a/sbin/fsdb/fsdb.c b/sbin/fsdb/fsdb.c
index 482ec1080c..2215117fb6 100644
--- a/sbin/fsdb/fsdb.c
+++ b/sbin/fsdb/fsdb.c
@@ -3,7 +3,7 @@
 /*
  *  Copyright (c) 1995 John T. Kohl
  *  All rights reserved.
- * 
+ *
  *  Redistribution and use in source and binary forms, with or without
  *  modification, are permitted provided that the following conditions
  *  are met:
@@ -14,7 +14,7 @@
  *     documentation and/or other materials provided with the distribution.
  *  3. The name of the author may not be used to endorse or promote products
  *     derived from this software without specific prior written permission.
- * 
+ *
  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR `AS IS'' AND ANY EXPRESS OR
  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
@@ -37,6 +37,7 @@
 #include <grp.h>
 #include <histedit.h>
 #include <pwd.h>
+#include <stdint.h>
 #include <string.h>
 
 #include <vfs/ufs/dinode.h>
@@ -49,7 +50,7 @@
 static void usage(void);
 int cmdloop(void);
 
-static void 
+static void
 usage(void)
 {
 	fprintf(stderr, "usage: fsdb [-d] [-f] [-r] fsname\n");
@@ -184,7 +185,7 @@ helpfn(int argc, char **argv)
 
     printf("Commands are:\n%-10s %5s %5s   %s\n",
 	   "command", "min argc", "max argc", "what");
-    
+
     for (cmdtp = cmds; cmdtp->cmd; cmdtp++)
 	printf("%-10s %5u %5u   %s\n",
 	       cmdtp->cmd, cmdtp->minargc, cmdtp->maxargc, cmdtp->helptxt);
@@ -376,7 +377,7 @@ const char *typename[] = {
     "unregistered #13",
     "whiteout",
 };
-    
+
 int slot;
 
 int
@@ -440,7 +441,7 @@ CMDFUNCSTART(focusname)
 	return 1;
 
     ocurrent = curinum;
-    
+
     if (argv[1][0] == '/') {
 	curinum = UFS_ROOTINO;
 	curinode = ginode(UFS_ROOTINO);
@@ -516,7 +517,7 @@ CMDFUNCSTART(chinum)
     char *cp;
     ino_t inum;
     struct inodesc idesc;
-    
+
     slotcount = 0;
     if (!checkactivedir())
 	return 1;
@@ -566,7 +567,7 @@ CMDFUNCSTART(chname)
     int rval;
     char *cp;
     struct inodesc idesc;
-    
+
     slotcount = 0;
     if (!checkactivedir())
 	return 1;
@@ -642,11 +643,11 @@ CMDFUNCSTART(chlen)
 	return 1;
 
     len = strtol(argv[1], &cp, 0);
-    if (cp == argv[1] || *cp != '\0' || len < 0) { 
+    if (cp == argv[1] || *cp != '\0' || len < 0) {
 	warnx("bad length `%s'", argv[1]);
 	return 1;
     }
-    
+
     curinode->di_size = len;
     inodirty();
     printactive(0);
@@ -663,11 +664,11 @@ CMDFUNCSTART(chmode)
 	return 1;
 
     modebits = strtol(argv[1], &cp, 8);
-    if (cp == argv[1] || *cp != '\0' || (modebits & ~07777)) { 
+    if (cp == argv[1] || *cp != '\0' || (modebits & ~07777)) {
 	warnx("bad modebits `%s'", argv[1]);
 	return 1;
     }
-    
+
     curinode->di_mode &= ~07777;
     curinode->di_mode |= modebits;
     inodirty();
@@ -685,11 +686,11 @@ CMDFUNCSTART(chaflags)
 	return 1;
 
     flags = strtoul(argv[1], &cp, 0);
-    if (cp == argv[1] || *cp != '\0' ) { 
+    if (cp == argv[1] || *cp != '\0' ) {
 	warnx("bad flags `%s'", argv[1]);
 	return 1;
     }
-    
+
     if (flags > UINT_MAX) {
 	warnx("flags set beyond 32-bit range of field (%lx)\n", flags);
 	return(1);
@@ -710,11 +711,11 @@ CMDFUNCSTART(chgen)
 	return 1;
 
     gen = strtol(argv[1], &cp, 0);
-    if (cp == argv[1] || *cp != '\0' ) { 
+    if (cp == argv[1] || *cp != '\0' ) {
 	warnx("bad gen `%s'", argv[1]);
 	return 1;
     }
-    
+
     if (gen > INT_MAX || gen < INT_MIN) {
 	warnx("gen set beyond 32-bit range of field (%lx)\n", gen);
 	return(1);
@@ -735,7 +736,7 @@ CMDFUNCSTART(linkcount)
 	return 1;
 
     lcnt = strtol(argv[1], &cp, 0);
-    if (cp == argv[1] || *cp != '\0' ) { 
+    if (cp == argv[1] || *cp != '\0' ) {
 	warnx("bad link count `%s'", argv[1]);
 	return 1;
     }
@@ -743,7 +744,7 @@ CMDFUNCSTART(linkcount)
 	warnx("max link count is %d\n", USHRT_MAX);
 	return 1;
     }
-    
+
     curinode->di_nlink = lcnt;
     inodirty();
     printactive(0);
@@ -761,7 +762,7 @@ CMDFUNCSTART(chowner)
 	return 1;
 
     uid = strtoul(argv[1], &cp, 0);
-    if (cp == argv[1] || *cp != '\0' ) { 
+    if (cp == argv[1] || *cp != '\0' ) {
 	/* try looking up name */
 	if ((pwd = getpwnam(argv[1]))) {
 	    uid = pwd->pw_uid;
@@ -770,7 +771,7 @@ CMDFUNCSTART(chowner)
 	    return 1;
 	}
     }
-    
+
     curinode->di_uid = uid;
     inodirty();
     printactive(0);
@@ -788,7 +789,7 @@ CMDFUNCSTART(chgroup)
 	return 1;
 
     gid = strtoul(argv[1], &cp, 0);
-    if (cp == argv[1] || *cp != '\0' ) { 
+    if (cp == argv[1] || *cp != '\0' ) {
 	if ((grp = getgrnam(argv[1]))) {
 	    gid = grp->gr_gid;
 	} else {
@@ -796,7 +797,7 @@ CMDFUNCSTART(chgroup)
 	    return 1;
 	}
     }
-    
+
     curinode->di_gid = gid;
     inodirty();
     printactive(0);
@@ -829,7 +830,7 @@ dotime(char *name, int32_t *rts)
     for (p = name; *p; p++)
 	if (*p < '0' || *p > '9')
 	    goto badformat;
-    
+
     p = name;
 #define VAL() ((*p++) - '0')
     t.tm_year = VAL();
diff --git a/sbin/fsdb/fsdbutil.c b/sbin/fsdb/fsdbutil.c
index 8457843db2..9fe2834b10 100644
--- a/sbin/fsdb/fsdbutil.c
+++ b/sbin/fsdb/fsdbutil.c
@@ -3,7 +3,7 @@
 /*
  *  Copyright (c) 1995 John T. Kohl
  *  All rights reserved.
- * 
+ *
  *  Redistribution and use in source and binary forms, with or without
  *  modification, are permitted provided that the following conditions
  *  are met:
@@ -14,7 +14,7 @@
  *     documentation and/or other materials provided with the distribution.
  *  3. The name of the author may not be used to endorse or promote products
  *     derived from this software without specific prior written permission.
- * 
+ *
  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR `AS IS'' AND ANY EXPRESS OR
  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
@@ -35,6 +35,7 @@
 #include <err.h>
 #include <grp.h>
 #include <pwd.h>
+#include <stdint.h>
 #include <string.h>
 #include <time.h>
 
@@ -76,7 +77,7 @@ argcount(struct cmdtable *cmdp, int argc, char **argv)
     else
 	warnx("command `%s' takes from %u to %u arguments",
 	      cmdp->cmd, cmdp->minargc-1, cmdp->maxargc-1);
-	    
+
     warnx("usage: %s: %s", cmdp->cmd, cmdp->helptxt);
     return 1;
 }
diff --git a/sbin/fsirand/fsirand.c b/sbin/fsirand/fsirand.c
index 9f7536d91f..9eea9e7f1d 100644
--- a/sbin/fsirand/fsirand.c
+++ b/sbin/fsirand/fsirand.c
@@ -37,6 +37,7 @@
 #include <sys/time.h>
 #include <sys/resource.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/fs.h>
 
diff --git a/sbin/growfs/debug.c b/sbin/growfs/debug.c
index 0ad3004f5b..a5a6cc1cc5 100644
--- a/sbin/growfs/debug.c
+++ b/sbin/growfs/debug.c
@@ -2,10 +2,10 @@
  * Copyright (c) 2000 Christoph Herrmann, Thomas-Henning von Kamptz
  * Copyright (c) 1980, 1989, 1993 The Regents of the University of California.
  * All rights reserved.
- * 
+ *
  * This code is derived from software contributed to Berkeley by
  * Christoph Herrmann and Thomas-Henning von Kamptz, Munich and Frankfurt.
- * 
+ *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
@@ -22,7 +22,7 @@
  * 4. Neither the name of the University nor the names of its contributors
  *    may be used to endorse or promote products derived from this software
  *    without specific prior written permission.
- * 
+ *
  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
@@ -42,6 +42,7 @@
 /* ********************************************************** INCLUDES ***** */
 #include <sys/param.h>
 
+#include <stdint.h>
 #include <stdio.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/fs.h>
@@ -414,7 +415,7 @@ dbg_dump_inmap(struct fs *sb, const char *comment, struct cg *cgr)
 		for(k=0; k<32; k+=8) {
 			if(j+k+8<e) {
 				fprintf(dbg_log,
-				    "%02x%02x%02x%02x%02x%02x%02x%02x ", 
+				    "%02x%02x%02x%02x%02x%02x%02x%02x ",
 				    cp[0], cp[1], cp[2], cp[3],
 				    cp[4], cp[5], cp[6], cp[7]);
 			} else {
@@ -459,7 +460,7 @@ dbg_dump_frmap(struct fs *sb, const char *comment, struct cg *cgr)
 		for(k=0; k<32; k+=8) {
 			if(j+k+8<e) {
 				fprintf(dbg_log,
-				    "%02x%02x%02x%02x%02x%02x%02x%02x ", 
+				    "%02x%02x%02x%02x%02x%02x%02x%02x ",
 				    cp[0], cp[1], cp[2], cp[3],
 				    cp[4], cp[5], cp[6], cp[7]);
 			} else {
@@ -503,7 +504,7 @@ dbg_dump_clmap(struct fs *sb, const char *comment, struct cg *cgr)
 		for(k=0; k<32; k+=8) {
 			if(j+k+8<e) {
 				fprintf(dbg_log,
-				    "%02x%02x%02x%02x%02x%02x%02x%02x ", 
+				    "%02x%02x%02x%02x%02x%02x%02x%02x ",
 				    cp[0], cp[1], cp[2], cp[3],
 				    cp[4], cp[5], cp[6], cp[7]);
 			} else {
@@ -597,7 +598,7 @@ dbg_dump_ino(struct fs *sb, const char *comment, struct ufs1_dinode *ino)
 {
 	int ictr;
 	int remaining_blocks;
-	
+
 	if(!dbg_log) {
 		return;
 	}
@@ -608,7 +609,7 @@ dbg_dump_ino(struct fs *sb, const char *comment, struct ufs1_dinode *ino)
 
 	fprintf(dbg_log, "mode       u_int16_t      0%o\n", ino->di_mode);
 	fprintf(dbg_log, "nlink      int16_t        0x%04x\n", ino->di_nlink);
-	fprintf(dbg_log, "size       u_int64_t      0x%08x%08x\n", 
+	fprintf(dbg_log, "size       u_int64_t      0x%08x%08x\n",
 	    ((unsigned int *)&(ino->di_size))[1],
 	    ((unsigned int *)&(ino->di_size))[0]);
 	fprintf(dbg_log, "atime      int32_t        0x%08x\n", ino->di_atime);
diff --git a/sbin/growfs/debug.h b/sbin/growfs/debug.h
index 702184626c..033f63f64c 100644
--- a/sbin/growfs/debug.h
+++ b/sbin/growfs/debug.h
@@ -2,10 +2,10 @@
  * Copyright (c) 2000 Christoph Herrmann, Thomas-Henning von Kamptz
  * Copyright (c) 1980, 1989, 1993 The Regents of the University of California.
  * All rights reserved.
- * 
+ *
  * This code is derived from software contributed to Berkeley by
  * Christoph Herrmann and Thomas-Henning von Kamptz, Munich and Frankfurt.
- * 
+ *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
@@ -22,7 +22,7 @@
  * 4. Neither the name of the University nor the names of its contributors
  *    may be used to endorse or promote products derived from this software
  *    without specific prior written permission.
- * 
+ *
  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
@@ -44,6 +44,7 @@
 /* ********************************************************** INCLUDES ***** */
 #include <sys/param.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/fs.h>
 
diff --git a/sbin/growfs/growfs.c b/sbin/growfs/growfs.c
index adbd66e40a..f4becdca22 100644
--- a/sbin/growfs/growfs.c
+++ b/sbin/growfs/growfs.c
@@ -55,6 +55,7 @@
 #include <stdlib.h>
 #include <string.h>
 #include <unistd.h>
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/fs.h>
 
diff --git a/sbin/ifconfig/regdomain.h b/sbin/ifconfig/regdomain.h
index cf6b4b37b6..6302ceb883 100644
--- a/sbin/ifconfig/regdomain.h
+++ b/sbin/ifconfig/regdomain.h
@@ -29,6 +29,7 @@
 
 #include <sys/cdefs.h>
 #include <sys/queue.h>
+#include <stdint.h>
 
 #include <netproto/802_11/ieee80211_regdomain.h>
 
diff --git a/sbin/jscan/jscan.c b/sbin/jscan/jscan.c
index d3cd8f6db0..d1730991a8 100644
--- a/sbin/jscan/jscan.c
+++ b/sbin/jscan/jscan.c
@@ -1,13 +1,13 @@
 /*
  * Copyright (c) 2003,2004 The DragonFly Project.  All rights reserved.
- * 
+ *
  * This code is derived from software contributed to The DragonFly Project
  * by Matthew Dillon <dillon@backplane.com>
- * 
+ *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
- * 
+ *
  * 1. Redistributions of source code must retain the above copyright
  *    notice, this list of conditions and the following disclaimer.
  * 2. Redistributions in binary form must reproduce the above copyright
@@ -17,7 +17,7 @@
  * 3. Neither the name of The DragonFly Project nor the names of its
  *    contributors may be used to endorse or promote products derived
  *    from this software without specific, prior written permission.
- * 
+ *
  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
@@ -30,8 +30,6 @@
  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
  * SUCH DAMAGE.
- * 
- * $DragonFly: src/sbin/jscan/jscan.c,v 1.13 2008/06/05 18:06:30 swildner Exp $
  */
 
 #include "jscan.h"
@@ -47,7 +45,7 @@ off_t prefix_file_size = 100 * 1024 * 1024;
 off_t trans_count;
 static enum jdirection jdirection = JD_FORWARDS;
 
-static void jscan_do_output(struct jfile *, const char *, 
+static void jscan_do_output(struct jfile *, const char *,
 			    const char *, int64_t);
 static void jscan_do_mirror(struct jfile *, const char *,
 			    const char *, int64_t);
@@ -209,7 +207,7 @@ main(int ac, char **av)
     /*
      * STEP1 - OPEN INPUT
      *
-     * The input will either be a pipe, a regular file, or a journaling 
+     * The input will either be a pipe, a regular file, or a journaling
      * file prefix.
      */
     jf = NULL;
@@ -237,7 +235,7 @@ main(int ac, char **av)
 	jmodes |= JMODEF_INPUT_PREFIX;
     }
     if (jf == NULL) {
-	fprintf(stderr, "Unable to open input %s: %s\n", 
+	fprintf(stderr, "Unable to open input %s: %s\n",
 		input_prefix, strerror(errno));
 	exit(1);
     }
@@ -254,9 +252,9 @@ main(int ac, char **av)
      */
     get_transid_from_file(output_transid_file, &output_transid,
 			  JMODEF_OUTPUT_TRANSID_GOOD);
-    get_transid_from_file(mirror_transid_file, &mirror_transid, 
+    get_transid_from_file(mirror_transid_file, &mirror_transid,
 			  JMODEF_MIRROR_TRANSID_GOOD);
-    get_transid_from_file(record_transid_file, &record_transid, 
+    get_transid_from_file(record_transid_file, &record_transid,
 			  JMODEF_RECORD_TRANSID_GOOD);
     transid = LLONG_MAX;
     if ((jmodes & JMODEF_OUTPUT_TRANSID_GOOD) && output_transid < transid)
@@ -301,12 +299,12 @@ main(int ac, char **av)
      */
     if (jmodes & JMODEF_RECORD) {
 	if (jrecord_init(record_prefix) < 0) {
-	    fprintf(stderr, "Unable to initialize file set for: %s\n", 
+	    fprintf(stderr, "Unable to initialize file set for: %s\n",
 		    record_prefix);
 	    exit(1);
 	}
 	if (jmodes & JMODEF_MIRROR) {
-	    fork_subprocess(jf, jscan_do_mirror, record_prefix, 
+	    fork_subprocess(jf, jscan_do_mirror, record_prefix,
 			    mirror_transid_file,
 			    mirror_directory, mirror_transid);
 	    /* XXX ack stream for temporary record file removal */
@@ -329,7 +327,7 @@ main(int ac, char **av)
      */
     if (jmodes & JMODEF_INPUT_PREFIX) {
 	if ((jmodes & JMODEF_OUTPUT) && (jmodes & JMODEF_MIRROR)) {
-	    fork_subprocess(jf, jscan_do_mirror, input_prefix, 
+	    fork_subprocess(jf, jscan_do_mirror, input_prefix,
 			    mirror_transid_file,
 			    mirror_directory, mirror_transid);
 	    jscan_do_output(jf, output_transid_file, NULL, output_transid);
@@ -364,7 +362,7 @@ main(int ac, char **av)
 
     jsession_init(&jsdebug, jf, jdirection,
 		  NULL, 0);
-    jsession_init(&jsoutput, jf, jdirection, 
+    jsession_init(&jsoutput, jf, jdirection,
 		  output_transid_file, output_transid);
     jsession_init(&jsmirror, jf, jdirection,
 		  mirror_transid_file, mirror_transid);
@@ -561,7 +559,7 @@ jscan_do_debug(struct jfile *jf, const char *dummy1 __unused,
 static void
 usage(const char *av0)
 {
-    fprintf(stderr, 
+    fprintf(stderr,
 	"%s [-2dfuvF] [-D dir] [-m mirror_transid_file/none]\n"
 	"\t[-o/O output_transid_file/none]\n"
 	"\t[-s size[kmgt]] -w/W record_prefix] [input_file/input_prefix]\n",
diff --git a/sbin/jscan/jscan.h b/sbin/jscan/jscan.h
index 1e86fd565a..d2356f35db 100644
--- a/sbin/jscan/jscan.h
+++ b/sbin/jscan/jscan.h
@@ -1,13 +1,13 @@
 /*
  * Copyright (c) 2004,2005 The DragonFly Project.  All rights reserved.
- * 
+ *
  * This code is derived from software contributed to The DragonFly Project
  * by Matthew Dillon <dillon@backplane.com>
- * 
+ *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
- * 
+ *
  * 1. Redistributions of source code must retain the above copyright
  *    notice, this list of conditions and the following disclaimer.
  * 2. Redistributions in binary form must reproduce the above copyright
@@ -17,7 +17,7 @@
  * 3. Neither the name of The DragonFly Project nor the names of its
  *    contributors may be used to endorse or promote products derived
  *    from this software without specific, prior written permission.
- * 
+ *
  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
@@ -36,6 +36,7 @@
 #include <sys/time.h>
 #include <sys/journal.h>
 #include <sys/stat.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdarg.h>
 #include <stdlib.h>
@@ -164,7 +165,7 @@ char *dupdatastr(const void *buf, int bytes);
 char *dupdatapath(const void *buf, int bytes);
 void get_transid_from_file(const char *path, int64_t *transid, int flags);
 
-void jsession_init(struct jsession *ss, struct jfile *jfin, 
+void jsession_init(struct jsession *ss, struct jfile *jfin,
 		   enum jdirection direction,
 		   const char *transid_file, int64_t transid);
 void jsession_update_transid(struct jsession *ss, int64_t transid);
@@ -174,7 +175,7 @@ void jsession_term(struct jsession *ss);
 struct jfile *jopen_fd(int fd);
 struct jfile *jopen_prefix(const char *prefix, int rw);
 void jclose(struct jfile *jf);
-struct jdata *jread(struct jfile *jf, struct jdata *jd, 
+struct jdata *jread(struct jfile *jf, struct jdata *jd,
 		    enum jdirection direction);
 struct jdata *jseek(struct jfile *jf, int64_t transid,
 		    enum jdirection direction);
diff --git a/sbin/md5/md5.c b/sbin/md5/md5.c
index 7632488e31..30d24eb729 100644
--- a/sbin/md5/md5.c
+++ b/sbin/md5/md5.c
@@ -26,6 +26,7 @@
 #include <sys/resource.h>
 #include <err.h>
 #include <sys/mman.h>
+#include <stdint.h>		/* for (intmax_t) */
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/sbin/natacontrol/natacontrol.c b/sbin/natacontrol/natacontrol.c
index afadbb070d..a7da4299d7 100644
--- a/sbin/natacontrol/natacontrol.c
+++ b/sbin/natacontrol/natacontrol.c
@@ -28,6 +28,7 @@
 
 #include <sys/nata.h>
 
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/sbin/newfs/defs.h b/sbin/newfs/defs.h
index 1e097e8d00..0dd1b4276a 100644
--- a/sbin/newfs/defs.h
+++ b/sbin/newfs/defs.h
@@ -22,8 +22,6 @@
  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
  * SUCH DAMAGE.
- *
- * $DragonFly: src/sbin/newfs/defs.h,v 1.3 2007/05/20 23:21:36 dillon Exp $
  */
 
 #include <sys/param.h>
@@ -32,6 +30,7 @@
 #include <sys/wait.h>
 #include <sys/resource.h>
 #include <sys/stat.h>
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/dir.h>
 #include <vfs/ufs/fs.h>
diff --git a/sbin/newfs_msdos/mkfs_msdos.h b/sbin/newfs_msdos/mkfs_msdos.h
index d94e77052f..5199fbee52 100644
--- a/sbin/newfs_msdos/mkfs_msdos.h
+++ b/sbin/newfs_msdos/mkfs_msdos.h
@@ -32,6 +32,7 @@
 
 #include <sys/types.h>
 #include <stdbool.h>
+#include <stdint.h>
 
 #define ALLOPTS \
 AOPT('@', off_t, offset, 0, "Offset in device") \
diff --git a/sbin/nvmectl/nvmectl.h b/sbin/nvmectl/nvmectl.h
index bf7a39d76b..a43d9a2679 100644
--- a/sbin/nvmectl/nvmectl.h
+++ b/sbin/nvmectl/nvmectl.h
@@ -35,6 +35,7 @@
 #include <sys/types.h>
 #include <sys/file.h>
 #include <sys/ioctl.h>
+#include <stdint.h>
 #include <dev/disk/nvme/nvme_fw.h>
 #include <dev/disk/nvme/nvme_log.h>
 #include <dev/disk/nvme/nvme_ident.h>
diff --git a/sbin/quotacheck/quotacheck.c b/sbin/quotacheck/quotacheck.c
index 230f0c4104..2573a39024 100644
--- a/sbin/quotacheck/quotacheck.c
+++ b/sbin/quotacheck/quotacheck.c
@@ -40,6 +40,7 @@
 #include <sys/param.h>
 #include <sys/stat.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/quota.h>
 #include <vfs/ufs/fs.h>
diff --git a/sbin/restore/dirs.c b/sbin/restore/dirs.c
index 9bf8b26444..c560df9d54 100644
--- a/sbin/restore/dirs.c
+++ b/sbin/restore/dirs.c
@@ -40,6 +40,7 @@
 #include <sys/stat.h>
 #include <sys/time.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/dir.h>
 #include <protocols/dumprestore.h>
diff --git a/sbin/restore/interactive.c b/sbin/restore/interactive.c
index 0faa267003..d952d443d4 100644
--- a/sbin/restore/interactive.c
+++ b/sbin/restore/interactive.c
@@ -33,6 +33,7 @@
 #include <sys/param.h>
 #include <sys/stat.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/dir.h>
 #include <protocols/dumprestore.h>
diff --git a/sbin/restore/main.c b/sbin/restore/main.c
index f7efc9c3fa..7f0049bd2c 100644
--- a/sbin/restore/main.c
+++ b/sbin/restore/main.c
@@ -34,6 +34,7 @@
 #include <sys/param.h>
 #include <sys/stat.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <protocols/dumprestore.h>
 
diff --git a/sbin/restore/restore.c b/sbin/restore/restore.c
index 36573e3b7c..84f8bb37f2 100644
--- a/sbin/restore/restore.c
+++ b/sbin/restore/restore.c
@@ -32,6 +32,7 @@
 
 #include <sys/types.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 
 #include <stdio.h>
diff --git a/sbin/restore/symtab.c b/sbin/restore/symtab.c
index e041c866d9..5f83281193 100644
--- a/sbin/restore/symtab.c
+++ b/sbin/restore/symtab.c
@@ -42,6 +42,7 @@
 #include <sys/param.h>
 #include <sys/stat.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 
 #include <errno.h>
diff --git a/sbin/restore/utilities.c b/sbin/restore/utilities.c
index cbfc50b027..2ef0f175de 100644
--- a/sbin/restore/utilities.c
+++ b/sbin/restore/utilities.c
@@ -33,6 +33,7 @@
 #include <sys/param.h>
 #include <sys/stat.h>
 
+#include <stdint.h>
 #include <vfs/ufs/dinode.h>
 #include <vfs/ufs/dir.h>
 
diff --git a/sbin/savecore/zopen.c b/sbin/savecore/zopen.c
index aa68e27aa2..1e7c8d18b5 100644
--- a/sbin/savecore/zopen.c
+++ b/sbin/savecore/zopen.c
@@ -4,6 +4,7 @@
  * $FreeBSD: src/lib/libz/zopen.c,v 1.2.2.2 2003/02/01 13:33:12 sobomax Exp $
  */
 
+#include <stdint.h>
 #include <stdio.h>
 #include <zlib.h>
 
diff --git a/sbin/usched/usched.c b/sbin/usched/usched.c
index 213e92145b..1a58a3fe62 100644
--- a/sbin/usched/usched.c
+++ b/sbin/usched/usched.c
@@ -35,7 +35,8 @@
 
 #include <sys/types.h>
 #include <sys/usched.h>
-#include <machine/cpumask.h>
+#include <sys/cpumask.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <unistd.h>
diff --git a/sbin/vinum/vinumutil.c b/sbin/vinum/vinumutil.c
index 98925f9b59..ae00ab4c15 100644
--- a/sbin/vinum/vinumutil.c
+++ b/sbin/vinum/vinumutil.c
@@ -33,11 +33,11 @@
  *
  * $Id: vinumutil.c,v 1.14 1999/12/30 07:04:02 grog Exp grog $
  * $FreeBSD: src/sys/dev/vinum/vinumutil.c,v 1.15 2000/02/29 06:16:44 grog Exp $
- * $DragonFly: src/sbin/vinum/vinumutil.c,v 1.7 2007/01/20 19:20:39 dillon Exp $
  */
 
 /* This file contains utility routines used both in kernel and user context */
 
+#include <stdint.h>
 #include <dev/raid/vinum/vinumhdr.h>
 #include <dev/raid/vinum/statetexts.h>
 #include <stdio.h>
diff --git a/sys/boot/common/bootstrap.h b/sys/boot/common/bootstrap.h
index 45ed5fd2e5..60429155d9 100644
--- a/sys/boot/common/bootstrap.h
+++ b/sys/boot/common/bootstrap.h
@@ -29,6 +29,7 @@
 #include <sys/types.h>
 #include <sys/queue.h>
 #include <sys/linker_set.h>
+#include <machine/types.h>	/* XXX for vm_offset_t */
 
 struct stat;
 
diff --git a/sys/boot/common/ls.c b/sys/boot/common/ls.c
index 1bc3bdd450..c60bdc0a95 100644
--- a/sys/boot/common/ls.c
+++ b/sys/boot/common/ls.c
@@ -36,6 +36,7 @@
  */
 
 #include <sys/param.h>
+#include <stdint.h>
 #include <ufs/ufs/dinode.h>
 #include <ufs/ufs/dir.h>
 
@@ -60,7 +61,7 @@ command_ls(int argc, char *argv[])
     char	lbuf[128];		/* one line */
     int		result, ch;
     int		verbose;
-	
+
     result = CMD_OK;
     fd = -1;
     verbose = 0;
@@ -151,7 +152,7 @@ ls_getdir(char **pathp)
 	    "bad path '%s'", path);
 	goto out;
     }
-    
+
     fd = rel_open(cp, NULL, O_RDONLY);
     if (fd < 0) {
 	snprintf(command_errbuf, sizeof(command_errbuf),
diff --git a/sys/boot/efi/loader/loader_efi.h b/sys/boot/efi/loader/loader_efi.h
index 12ab7b8e1d..364a5e5572 100644
--- a/sys/boot/efi/loader/loader_efi.h
+++ b/sys/boot/efi/loader/loader_efi.h
@@ -32,6 +32,7 @@
 #define	_LOADER_EFI_COPY_H_
 
 #include <stand.h>
+#include <machine/types.h>	/* XXX for vm_offset_t */
 
 int	efi_autoload(void);
 
diff --git a/sys/boot/pc32/boot2/scrc32.c b/sys/boot/pc32/boot2/scrc32.c
index a818250ebe..16478e7348 100644
--- a/sys/boot/pc32/boot2/scrc32.c
+++ b/sys/boot/pc32/boot2/scrc32.c
@@ -34,6 +34,7 @@
 #include <sys/systm.h>
 #else
 #include <sys/types.h>
+#include <stdint.h>
 #endif
 
 #ifndef _KERNEL
diff --git a/sys/boot/pc32/btx/lib/btxv86.h b/sys/boot/pc32/btx/lib/btxv86.h
index 061762df13..a299d92ba7 100644
--- a/sys/boot/pc32/btx/lib/btxv86.h
+++ b/sys/boot/pc32/btx/lib/btxv86.h
@@ -15,13 +15,13 @@
 
 /*
  * $FreeBSD: src/sys/boot/i386/btx/lib/btxv86.h,v 1.5 1999/08/28 00:40:08 peter Exp $
- * $DragonFly: src/sys/boot/pc32/btx/lib/btxv86.h,v 1.3 2003/11/10 06:08:35 dillon Exp $
  */
 
 #ifndef _BTXV86_H_
 #define _BTXV86_H_
 
 #include <sys/types.h>
+#include <machine/types.h>	/* XXX for vm_offset_t */
 
 #define V86_ADDR   0x10000	/* Segment:offset address */
 #define V86_CALLF  0x20000	/* Emulate far call */
diff --git a/sys/boot/pc32/btxld/btx.h b/sys/boot/pc32/btxld/btx.h
index 229698b588..5c270e7a7f 100644
--- a/sys/boot/pc32/btxld/btx.h
+++ b/sys/boot/pc32/btxld/btx.h
@@ -24,13 +24,13 @@
  * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  *
  * $FreeBSD: src/usr.sbin/btxld/btx.h,v 1.2 1999/08/28 01:15:41 peter Exp $
- * $DragonFly: src/usr.sbin/btxld/btx.h,v 1.2 2003/06/17 04:29:52 dillon Exp $
  */
 
 #ifndef _BTX_H_
 #define _BTX_H_
 
 #include <sys/types.h>
+#include <stdint.h>
 
 #define BTX_PGSIZE	0x1000		/* Page size */
 #define BTX_PGBASE	0x5000		/* Start of page tables */
diff --git a/sys/boot/pc32/libi386/biosacpi.c b/sys/boot/pc32/libi386/biosacpi.c
index 2c46eb8253..90f9b1e9a5 100644
--- a/sys/boot/pc32/libi386/biosacpi.c
+++ b/sys/boot/pc32/libi386/biosacpi.c
@@ -60,7 +60,7 @@ biosacpi_detect(void)
 	return;
 
     /* export values from the RSDP */
-    sprintf(buf, "0x%08lx", VTOP(rsdp));
+    sprintf(buf, "0x%08x", VTOP(rsdp));
     setenv("hint.acpi.0.rsdp", buf, 1);
     revision = rsdp->Revision;
     if (revision == 0)
diff --git a/sys/boot/pc32/libi386/libi386.h b/sys/boot/pc32/libi386/libi386.h
index a15905d11b..6c71d89807 100644
--- a/sys/boot/pc32/libi386/libi386.h
+++ b/sys/boot/pc32/libi386/libi386.h
@@ -26,6 +26,7 @@
  * $FreeBSD: src/sys/boot/i386/libi386/libi386.h,v 1.16 2003/05/01 03:56:29 peter Exp $
  */
 
+#include <machine/types.h>	/* XXX for vm_offset_t */
 
 /*
  * i386 fully-qualified device descriptor.
diff --git a/sys/bus/cam/scsi/scsi_all.h b/sys/bus/cam/scsi/scsi_all.h
index 6d84f55ab9..0cd44cad2e 100644
--- a/sys/bus/cam/scsi/scsi_all.h
+++ b/sys/bus/cam/scsi/scsi_all.h
@@ -27,6 +27,9 @@
 #ifndef _SYS_CDEFS_H_
 #include <sys/cdefs.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 #if !defined(_KERNEL) && !defined(_STDIO_H_)
 #include <stdio.h>	/* FILE for userland protos */
 #endif
diff --git a/sys/bus/firewire/fwcrom.c b/sys/bus/firewire/fwcrom.c
index fcf9e8d505..e4ad766414 100644
--- a/sys/bus/firewire/fwcrom.c
+++ b/sys/bus/firewire/fwcrom.c
@@ -42,6 +42,7 @@
 #include <sys/systm.h>
 #include <sys/kernel.h>
 #else
+#include <machine/types.h>	/* XXX for vm_offset_t */
 #include <netinet/in.h>
 #include <fcntl.h>
 #include <stdio.h>
diff --git a/sys/bus/pci/pcivar.h b/sys/bus/pci/pcivar.h
index 9dff3a358d..958035a312 100644
--- a/sys/bus/pci/pcivar.h
+++ b/sys/bus/pci/pcivar.h
@@ -32,6 +32,9 @@
 #ifndef _SYS_QUEUE_H_
 #include <sys/queue.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 
 /* some PCI bus constants */
 
diff --git a/sys/bus/u4b/usb_dev.h b/sys/bus/u4b/usb_dev.h
index d084353fce..26016c386f 100644
--- a/sys/bus/u4b/usb_dev.h
+++ b/sys/bus/u4b/usb_dev.h
@@ -27,6 +27,7 @@
 #ifndef _USB_DEV_H_
 #define	_USB_DEV_H_
 
+#include <sys/stdint.h>
 #include <sys/file.h>
 #include <sys/poll.h>
 #include <sys/signalvar.h>
diff --git a/sys/contrib/dev/acpica/source/include/platform/acdragonfly.h b/sys/contrib/dev/acpica/source/include/platform/acdragonfly.h
index 318110edc1..2a014942e8 100644
--- a/sys/contrib/dev/acpica/source/include/platform/acdragonfly.h
+++ b/sys/contrib/dev/acpica/source/include/platform/acdragonfly.h
@@ -153,6 +153,11 @@
 #define __ACDRAGONFLY_H_
 
 #include <sys/types.h>
+#ifdef _KERNEL
+#include <sys/stdint.h>
+#else
+#include <stdint.h>
+#endif
 
 #ifdef __LP64__
 #define ACPI_MACHINE_WIDTH              64
diff --git a/sys/cpu/x86_64/include/cpumask.h b/sys/cpu/x86_64/include/cpumask.h
index 5173efec02..2da5abad9d 100644
--- a/sys/cpu/x86_64/include/cpumask.h
+++ b/sys/cpu/x86_64/include/cpumask.h
@@ -35,16 +35,25 @@
 #ifndef _CPU_CPUMASK_H_
 #define	_CPU_CPUMASK_H_
 
-#include <cpu/types.h>
+#include <machine/stdint.h>
 #ifdef _KERNEL
 #include <cpu/atomic.h>
 #endif
 
-#if _CPUMASK_ELEMENTS != 4
-#error "CPUMASK macros incompatible with cpumask_t"
-#endif
+/*
+ * cpumask_t - a mask representing a set of cpus and supporting routines.
+ *
+ * WARNING! It is recommended that this mask NOT be made variably-sized
+ *	    because it affects a huge number of system structures.  However,
+ *	    kernel code (non-module) can be optimized to not operate on the
+ *	    whole mask.
+ */
 
-#define CPUMASK_ELEMENTS	_CPUMASK_ELEMENTS
+typedef struct {
+	__uint64_t	ary[4];
+} __cpumask_t;
+
+#define CPUMASK_ELEMENTS	4
 
 #define CPUMASK_INITIALIZER_ALLONES	{ .ary = { (__uint64_t)-1, \
 					  (__uint64_t)-1, \
@@ -212,6 +221,52 @@
 					(mask).ary[3] ^= -1L;		\
 					} while(0)
 
+#ifndef _KERNEL
+#define	__CPU_SETSIZE		((int)(sizeof(cpumask_t) * 8))
+
+#define	__CPU_COUNT(set)	(					\
+				__builtin_popcountl((set)->ary[0]) +	\
+				__builtin_popcountl((set)->ary[1]) +	\
+				__builtin_popcountl((set)->ary[2]) +	\
+				__builtin_popcountl((set)->ary[3]))
+
+#define	__CPU_CLR(cpu, set)	CPUMASK_NANDBIT(*set, cpu)
+#define	__CPU_EQUAL(set1, set2)	CPUMASK_CMPMASKEQ(*set1, *set2)
+#define	__CPU_ISSET(cpu, set)	CPUMASK_TESTBIT(*set, cpu)
+#define	__CPU_SET(cpu, set)	CPUMASK_ORBIT(*set, cpu)
+#define	__CPU_ZERO(set)		CPUMASK_ASSZERO(*set)
+
+#define	__CPU_AND(dst, set1, set2)					\
+			do {						\
+				if (dst == set1) {			\
+					CPUMASK_ANDMASK(*dst, *set2);	\
+				} else {				\
+					*dst = *set2;			\
+					CPUMASK_ANDMASK(*dst, *set1);	\
+				}					\
+			} while (0)
+
+#define	__CPU_OR(dst, set1, set2)					\
+			do {						\
+				if (dst == set1) {			\
+					CPUMASK_ORMASK(*dst, *set2);	\
+				} else {				\
+					*dst = *set2;			\
+					CPUMASK_ORMASK(*dst, *set1);	\
+				}					\
+			} while (0)
+
+#define	__CPU_XOR(dst, set1, set2)					\
+			do {						\
+				if (dst == set1) {			\
+					CPUMASK_XORMASK(*dst, *set2);	\
+				} else {				\
+					*dst = *set2;			\
+					CPUMASK_XORMASK(*dst, *set1);	\
+				}					\
+			} while (0)
+#endif
+
 #ifdef _KERNEL
 #define ATOMIC_CPUMASK_ORBIT(mask, i)					  \
 			atomic_set_cpumask(&(mask).ary[((i) >> 6) & 3],	  \
diff --git a/sys/cpu/x86_64/include/frame.h b/sys/cpu/x86_64/include/frame.h
index fe4df3eba8..b5262d25c8 100644
--- a/sys/cpu/x86_64/include/frame.h
+++ b/sys/cpu/x86_64/include/frame.h
@@ -38,7 +38,6 @@
 #ifndef _CPU_FRAME_H_
 #define _CPU_FRAME_H_
 
-/* JG? */
 #include <sys/types.h>
 
 /*
@@ -144,7 +143,7 @@ struct trampframe {
 	register_t	tr_pcb_flags;	/* copy of pcb control flags */
 	register_t	tr_pcb_cr3_iso;	/* copy of isolated pml4e */
 	register_t	tr_pcb_cr3;	/* copy of primary pml4e */
-	uint32_t	tr_pcb_spec_ctrl[2];/* SPEC_CTRL + ficticious flags */
+	u_int32_t	tr_pcb_spec_ctrl[2];/* SPEC_CTRL + ficticious flags */
 	register_t	tr_pcb_gs_kernel; /* (used by nmi, dbg) */
 	register_t	tr_pcb_gs_saved;  /* (used by nmi) */
 	register_t	tr_pcb_cr3_saved; /* (used by nmi) */
diff --git a/sys/cpu/x86_64/include/npx.h b/sys/cpu/x86_64/include/npx.h
index 56c76a559b..c8e678f040 100644
--- a/sys/cpu/x86_64/include/npx.h
+++ b/sys/cpu/x86_64/include/npx.h
@@ -42,7 +42,7 @@
 #ifndef _CPU_NPX_H_
 #define	_CPU_NPX_H_
 
-#include <stdint.h>
+#include <sys/stdint.h>
 
 /* Environment information of floating point unit */
 struct	env87 {
diff --git a/sys/cpu/x86_64/include/param.h b/sys/cpu/x86_64/include/param.h
index 03441227be..1d7d1745a4 100644
--- a/sys/cpu/x86_64/include/param.h
+++ b/sys/cpu/x86_64/include/param.h
@@ -71,27 +71,27 @@
 #define SMP_MAXCPU	256
 #define MAXCPU		SMP_MAXCPU
 
-/* JG license? from fbsd/src/sys/amd64/include/param.h */
+/* Constants derived from sizeof() that need recalculation. */
 /* level 1 == page table */
 #define	NPTEPGSHIFT	9		/* LOG2(NPTEPG) */
 #define PAGE_SHIFT	12		/* LOG2(PAGE_SIZE) */
 #define PAGE_SIZE	(1<<PAGE_SHIFT)	/* bytes/page */
 #define PAGE_MASK	(PAGE_SIZE-1)
-#define NPTEPG		(PAGE_SIZE/(sizeof (pt_entry_t)))
+#define NPTEPG		(PAGE_SIZE/8LU)	/* PAGE_SIZE/sizeof(pt_entry_t) */
 
 /* level 2 == page directory */
 #define	NPDEPGSHIFT	9		/* LOG2(NPDEPG) */
 #define PDRSHIFT	21		/* LOG2(NBPDR) */
 #define NBPDR		(1<<PDRSHIFT)	/* bytes/page dir */
 #define PDRMASK		(NBPDR-1)
-#define NPDEPG		(PAGE_SIZE/(sizeof (pd_entry_t)))
+#define NPDEPG		(PAGE_SIZE/8LU)	/* PAGE_SIZE/sizeof(pd_entry_t) */
 
 /* level 3 == page directory pointer table */
 #define	NPDPEPGSHIFT	9		/* LOG2(NPDPEPG) */
 #define PDPSHIFT	30		/* LOG2(NBPDP) */
 #define NBPDP		(1<<PDPSHIFT)	/* bytes/page dir ptr table */
 #define PDPMASK		(NBPDP-1)
-#define NPDPEPG		(PAGE_SIZE/(sizeof (pdp_entry_t)))
+#define NPDPEPG		(PAGE_SIZE/8LU)	/* PAGE_SIZE/sizeof(pdp_entry_t) */
 
 /* level 4 */
 #define	NPML4EPGSHIFT	9		/* LOG2(NPML4EPG) */
@@ -99,7 +99,7 @@
 #define NPML4		(1UL<<PML4SHIFT)/* bytes/page map level4 table */
 #define	NBPML4		(1ul<<PML4SHIFT)/* bytes/page map lev4 table */
 #define PML4MASK	(NPML4-1)
-#define NPML4EPG	(PAGE_SIZE/(sizeof (pml4_entry_t)))
+#define NPML4EPG	(PAGE_SIZE/8LU)	/* PAGE_SIZE/sizeof(pml4_entry_t) */
 
 /*
  * Virtual address sign-extension and mask.  If bit 47 is set then
diff --git a/sys/cpu/x86_64/include/pmap.h b/sys/cpu/x86_64/include/pmap.h
index ba19fc4367..65916ebf13 100644
--- a/sys/cpu/x86_64/include/pmap.h
+++ b/sys/cpu/x86_64/include/pmap.h
@@ -45,6 +45,20 @@
 #ifndef _CPU_PMAP_H_
 #define _CPU_PMAP_H_
 
+#ifndef LOCORE
+
+#include <machine/stdint.h>
+
+/*
+ * MMU page tables, keep public for VM_MAX_USER_ADDRESS/PS_STRINGS.
+ */
+typedef	__uint64_t	pml4_entry_t;
+typedef	__uint64_t	pdp_entry_t;
+typedef	__uint64_t	pd_entry_t;
+typedef	__uint64_t	pt_entry_t;
+
+#endif /* !LOCORE */
+
 /*
  * Page-directory and page-table entries follow this format, with a few
  * of the fields not present here and there, depending on a lot of things.
diff --git a/sys/cpu/x86_64/include/segments.h b/sys/cpu/x86_64/include/segments.h
index 0aa64af912..537ca19339 100644
--- a/sys/cpu/x86_64/include/segments.h
+++ b/sys/cpu/x86_64/include/segments.h
@@ -38,6 +38,10 @@
 #ifndef _CPU_SEGMENTS_H_
 #define	_CPU_SEGMENTS_H_
 
+#ifndef _KERNEL
+#include <sys/stdint.h>		/* for uint64_t */
+#endif
+
 /*
  * x86_64 Segmentation Data Structures and definitions
  */
diff --git a/sys/cpu/x86_64/include/stdint.h b/sys/cpu/x86_64/include/stdint.h
index fc310e14b0..d0651d3b70 100644
--- a/sys/cpu/x86_64/include/stdint.h
+++ b/sys/cpu/x86_64/include/stdint.h
@@ -1,7 +1,7 @@
 /*-
  * Copyright (c) 2001, 2002 Mike Barcroft <mike@FreeBSD.org>
  * Copyright (c) 2001 The NetBSD Foundation, Inc.  All rights reserved.
- * Copyright (c) 1990, 1993 The Regents of the University of California. 
+ * Copyright (c) 1990, 1993 The Regents of the University of California.
  *		All rights reserved.
  *
  * This code is derived from software contributed to The NetBSD Foundation
@@ -68,21 +68,26 @@ __extension__
 typedef	unsigned long long __uint64_t;
 #endif
 
+/*
+ * Basic signed and unsigned LP types.  We support LP64 and ILP32 models only.
+ */
+#ifdef __LP64__
+typedef	long		__bslp_t;
+typedef	unsigned long	__bulp_t;
+#else
+typedef	int		__bslp_t;
+typedef	unsigned int	__bulp_t;
+#endif
+
 /*
  * Standard type definitions.
  */
 typedef	__int64_t	__intmax_t;
 typedef	__uint64_t	__uintmax_t;
 
-#ifdef __LP64__
-typedef	__int64_t	__intptr_t;
-typedef	__uint64_t	__uintptr_t;
-typedef	__int64_t	__ptrdiff_t;		/* ptr1 - ptr2 */
-#else
-typedef	__int32_t	__intptr_t;
-typedef	__uint32_t	__uintptr_t;
-typedef	__int32_t	__ptrdiff_t;		/* ptr1 - ptr2 */
-#endif
+typedef	__bslp_t	__intptr_t;
+typedef	__bulp_t	__uintptr_t;
+typedef	__bslp_t	__ptrdiff_t;	/* ptr1 - ptr2 */
 
 typedef	__int32_t	__int_fast8_t;
 typedef	__int32_t	__int_fast16_t;
@@ -108,28 +113,27 @@ typedef	__uint64_t	__uint_least64_t;
  * do not wish to overly pollute their namespaces.
  */
 
-#ifdef __LP64__
-typedef __uint64_t	__size_t;
-typedef __int64_t	__ssize_t;
-typedef __int64_t	__register_t;
-typedef __uint64_t	__u_register_t;
+/* <sys/types.h> */
+typedef	unsigned long	__clock_t;	/* ticks in CLOCKS_PER_SEC */
+typedef	unsigned long	__clockid_t;	/* CLOCK_* identifiers */
+typedef	__int64_t	__off_t;	/* file offset or size */
+typedef	__int32_t	__pid_t;	/* process [group] id */
+typedef	__bulp_t	__size_t;	/* sizes of objects */
+typedef	__bslp_t	__ssize_t;	/* byte counts or error status */
+typedef	long		__suseconds_t;	/* microseconds (signed) */
+typedef	__bslp_t	__time_t;	/* epoch time */
+typedef	int		__timer_t;	/* POSIX timer identifiers */
+
+/* misc types */
+#if __GNUC_PREREQ__(2, 7)
+typedef	int		__register_t __attribute__((__mode__(__word__)));
 #else
-typedef __uint32_t	__size_t;
-typedef __int32_t	__ssize_t;
-typedef __int32_t	__register_t;
-typedef __uint32_t	__u_register_t;
+typedef	__bslp_t	__register_t;
 #endif
 
-typedef long		__suseconds_t;
-typedef long		__time_t;
-typedef int		__timer_t;
 typedef __int32_t	__sig_atomic_t;	/* XXX */
-typedef unsigned long	__clock_t;
-typedef unsigned long	__clockid_t;
 typedef __uint32_t	__socklen_t;
 typedef volatile int	__atomic_intr_t;
 typedef __int64_t	__rlim_t;
-typedef __int64_t	__off_t;
-typedef __int32_t	__pid_t;
 
 #endif /* _CPU_STDINT_H_ */
diff --git a/sys/cpu/x86_64/include/tls.h b/sys/cpu/x86_64/include/tls.h
index 8a924feb59..cb799efc68 100644
--- a/sys/cpu/x86_64/include/tls.h
+++ b/sys/cpu/x86_64/include/tls.h
@@ -35,6 +35,9 @@
 #ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>			/* for uintptr_t */
+#endif
 #ifndef _SYS_TLS_H_
 #include <sys/tls.h>
 #endif
diff --git a/sys/cpu/x86_64/include/types.h b/sys/cpu/x86_64/include/types.h
index ef124646d8..c96de60ece 100644
--- a/sys/cpu/x86_64/include/types.h
+++ b/sys/cpu/x86_64/include/types.h
@@ -36,18 +36,8 @@
 
 #include <machine/stdint.h>
 
-#if defined(__x86_64__)
-typedef	__int64_t	__segsz_t;	/* segment size */
-typedef	__int64_t	register_t;
-typedef	__uint64_t	u_register_t;
-#elif defined(__i386__)
-typedef	__int32_t	__segsz_t;	/* segment size */
-typedef	__int32_t	register_t;
-typedef	__uint32_t	u_register_t;
-#endif
-
-typedef unsigned long	vm_offset_t;    /* address space bounded offset */
-typedef unsigned long	vm_size_t;      /* address space bounded size */
+typedef __bulp_t	vm_offset_t;	/* address space bounded offset */
+typedef __bulp_t	vm_size_t;	/* address space bounded size */
 
 typedef __uint64_t	vm_pindex_t;    /* physical page index */
 typedef __uint64_t	vm_spindex_t;   /* physical page index (signed) */
@@ -55,38 +45,4 @@ typedef	__int64_t	vm_ooffset_t;	/* VM object bounded offset */
 typedef __uint64_t	vm_poff_t;	/* physical offset */
 typedef __uint64_t	vm_paddr_t;	/* physical addr (same as vm_poff_t) */
 
-/*
- * MMU page tables
- */
-typedef __uint64_t	pml4_entry_t;
-typedef __uint64_t	pdp_entry_t;
-typedef __uint64_t	pd_entry_t;
-typedef __uint64_t	pt_entry_t;
-typedef __uint32_t      cpulock_t;      /* count and exclusive lock */
-
-/*
- * cpumask_t - a mask representing a set of cpus and supporting routines.
- *
- * WARNING! It is recommended that this mask NOT be made variably-sized
- *	    because it affects a huge number of system structures.  However,
- *	    kernel code (non-module) can be optimized to not operate on the
- *	    whole mask.
- */
-
-#define _CPUMASK_ELEMENTS	4	/* tested by assembly for #error */
-
-typedef struct {
-	__uint64_t      ary[4];
-} cpumask_t;
-
-#define CPULOCK_EXCLBIT	0		/* exclusive lock bit number */
-#define CPULOCK_EXCL	0x00000001	/* exclusive lock */
-#define CPULOCK_INCR	0x00000002	/* auxillary counter add/sub */
-#define CPULOCK_CNTMASK	0x7FFFFFFE
-
-#define PML4SIZE	sizeof(pml4_entry_t) /* for assembly files */
-#define PDPSIZE		sizeof(pdp_entry_t) /* for assembly files */
-#define PDESIZE         sizeof(pd_entry_t) /* for assembly files */
-#define PTESIZE         sizeof(pt_entry_t) /* for assembly files */
-
 #endif /* !_CPU_TYPES_H_ */
diff --git a/sys/dev/acpica/acpiio.h b/sys/dev/acpica/acpiio.h
index 7829438182..b9d1d23717 100644
--- a/sys/dev/acpica/acpiio.h
+++ b/sys/dev/acpica/acpiio.h
@@ -31,6 +31,7 @@
 #define _ACPIIO_H_
 
 #include <sys/ioccom.h>
+#include <sys/stdint.h>
 
 /*
  * Core ACPI subsystem ioctls
diff --git a/sys/dev/misc/evdev/input.h b/sys/dev/misc/evdev/input.h
index c3f1a07832..35891bcf97 100644
--- a/sys/dev/misc/evdev/input.h
+++ b/sys/dev/misc/evdev/input.h
@@ -33,6 +33,7 @@
 #include <sys/ioccom.h>
 #include <sys/time.h>
 #include <sys/types.h>
+#include <sys/stdint.h>
 
 #include "input-event-codes.h"
 
diff --git a/sys/emulation/ndis/pe_var.h b/sys/emulation/ndis/pe_var.h
index 0ac691cf36..25f3957596 100644
--- a/sys/emulation/ndis/pe_var.h
+++ b/sys/emulation/ndis/pe_var.h
@@ -35,6 +35,9 @@
 #ifndef _PE_VAR_H_
 #define	_PE_VAR_H_
 
+#include <sys/stdint.h>		/* for uint16_t, uint32_t */
+#include <machine/types.h>	/* XXX for vm_offset_t */
+
 /*
  *  Image Format
  */
diff --git a/sys/gnu/vfs/ext2fs/ext2_fs.h b/sys/gnu/vfs/ext2fs/ext2_fs.h
index 0a5ca16d43..6b08e36d91 100644
--- a/sys/gnu/vfs/ext2fs/ext2_fs.h
+++ b/sys/gnu/vfs/ext2fs/ext2_fs.h
@@ -25,6 +25,7 @@
 #define _LINUX_EXT2_FS_H
 
 #include <sys/types.h>
+#include <sys/stdint.h>
 #include <sys/ioccom.h>
 
 #define __u32 u_int32_t
diff --git a/sys/kern/init_sysent.c b/sys/kern/init_sysent.c
index 97b02ecd7e..8a796061cd 100644
--- a/sys/kern/init_sysent.c
+++ b/sys/kern/init_sysent.c
@@ -9,7 +9,6 @@
 #include <sys/sysent.h>
 #include <sys/sysproto.h>
 #include <sys/statvfs.h>
-#include <machine/cpumask.h>
 
 #define AS(name) ((sizeof(struct name) - sizeof(struct sysmsg)) / sizeof(register_t))
 
diff --git a/sys/kern/kern_usched.c b/sys/kern/kern_usched.c
index 8399d8cf52..1c8dfe0681 100644
--- a/sys/kern/kern_usched.c
+++ b/sys/kern/kern_usched.c
@@ -33,6 +33,7 @@
  *
  */
 
+#include <sys/cpumask.h>
 #include <sys/errno.h>
 #include <sys/globaldata.h>		/* curthread */
 #include <sys/proc.h>
@@ -41,7 +42,6 @@
 #include <sys/systm.h>			/* strcmp() */
 #include <sys/usched.h>
 
-#include <machine/cpumask.h>
 #include <machine/smp.h>
 
 static TAILQ_HEAD(, usched) usched_list = TAILQ_HEAD_INITIALIZER(usched_list);
diff --git a/sys/kern/makesyscalls.sh b/sys/kern/makesyscalls.sh
index debe226ae8..1885dcf0d9 100644
--- a/sys/kern/makesyscalls.sh
+++ b/sys/kern/makesyscalls.sh
@@ -87,6 +87,7 @@ s/\$//g
 		printf "#include <sys/select.h>\n" > sysarg
 		printf "#include <sys/signal.h>\n" > sysarg
 		printf "#include <sys/acl.h>\n" > sysarg
+		printf "#include <sys/cpumask.h>\n" > sysarg
 		printf "#include <sys/mqueue.h>\n" > sysarg
 		printf "#include <sys/msgport.h>\n" > sysarg
 		printf "#include <sys/sysmsg.h>\n" > sysarg
diff --git a/sys/kern/syscalls.master b/sys/kern/syscalls.master
index 28a401c77b..80549b9f1b 100644
--- a/sys/kern/syscalls.master
+++ b/sys/kern/syscalls.master
@@ -32,7 +32,6 @@
 #include <sys/sysent.h>
 #include <sys/sysproto.h>
 #include <sys/statvfs.h>
-#include <machine/cpumask.h>
 
 ; Reserved/unimplemented system calls in the range 0-150 inclusive
 ; are reserved for use in future Berkeley releases.
diff --git a/sys/libkern/crc32.c b/sys/libkern/crc32.c
index 056cdd7bc6..fb0c20883c 100644
--- a/sys/libkern/crc32.c
+++ b/sys/libkern/crc32.c
@@ -39,7 +39,6 @@
  * CRC32 code derived from work by Gary S. Brown.
  *
  * $FreeBSD: src/sys/libkern/crc32.c,v 1.1.2.1 2002/07/31 09:08:34 imp Exp $
- * $DragonFly: src/sys/libkern/crc32.c,v 1.7 2008/11/03 08:41:31 swildner Exp $
  */
 
 /*
@@ -52,6 +51,7 @@
 #include <sys/param.h>
 #include <sys/systm.h>
 #else
+#include <sys/stdint.h>
 #include <sys/types.h>
 #endif
 
diff --git a/sys/libkern/icrc32.c b/sys/libkern/icrc32.c
index 9cc892e461..f14c21e617 100644
--- a/sys/libkern/icrc32.c
+++ b/sys/libkern/icrc32.c
@@ -4,6 +4,7 @@
  */
 
 #include <sys/param.h>
+#include <sys/stdint.h>
 #ifdef _KERNEL
 #include <sys/systm.h>
 #endif
diff --git a/sys/libprop/prop_number.h b/sys/libprop/prop_number.h
index 17cec6908a..2a1e503b06 100644
--- a/sys/libprop/prop_number.h
+++ b/sys/libprop/prop_number.h
@@ -32,9 +32,7 @@
 #ifndef _PROPLIB_PROP_NUMBER_H_
 #define	_PROPLIB_PROP_NUMBER_H_
 
-#if !defined(_KERNEL) && !defined(_STANDALONE)
-#include <stdint.h>
-#endif
+#include <sys/stdint.h>
 #include <libprop/prop_object.h>
 
 typedef struct _prop_number *prop_number_t;
diff --git a/sys/libprop/prop_object.h b/sys/libprop/prop_object.h
index e7e3682168..09409e7450 100644
--- a/sys/libprop/prop_object.h
+++ b/sys/libprop/prop_object.h
@@ -36,6 +36,7 @@
 
 #ifndef _KERNEL
 #include <stdbool.h>
+#include <stdint.h>
 #endif
 
 typedef void *prop_object_t;
diff --git a/sys/libprop/prop_rb_impl.h b/sys/libprop/prop_rb_impl.h
index 814ba7d350..5826802c04 100644
--- a/sys/libprop/prop_rb_impl.h
+++ b/sys/libprop/prop_rb_impl.h
@@ -47,6 +47,7 @@
 #else	/* __NetBSD__ */
 
 #include <sys/types.h>
+#include <sys/stdint.h>
 #include <sys/queue.h>
 #include <machine/endian.h>
 
diff --git a/sys/net/altq/if_altq.h b/sys/net/altq/if_altq.h
index 51da040076..80f07d0238 100644
--- a/sys/net/altq/if_altq.h
+++ b/sys/net/altq/if_altq.h
@@ -29,6 +29,8 @@
 #define	_NET_ALTQ_IF_ALTQ_H_
 
 #include <sys/mbuf.h>
+#include <sys/queue.h>
+#include <sys/stdint.h>
 #include <sys/serialize.h>
 #include <net/altq/if_classq.h>
 
diff --git a/sys/net/bpf.h b/sys/net/bpf.h
index 1c9f40c023..f12a32cd44 100644
--- a/sys/net/bpf.h
+++ b/sys/net/bpf.h
@@ -42,6 +42,7 @@
 
 #include <sys/param.h>
 #include <sys/time.h>
+#include <sys/stdint.h>
 #include <sys/ioccom.h>
 
 __BEGIN_DECLS
diff --git a/sys/net/ethernet.h b/sys/net/ethernet.h
index 749aa50954..84dc884c08 100644
--- a/sys/net/ethernet.h
+++ b/sys/net/ethernet.h
@@ -11,6 +11,9 @@
 #ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 
 /*
  * The number of bytes in an ethernet (MAC) address.
diff --git a/sys/net/if.h b/sys/net/if.h
index 769ec2e599..0d526fda9d 100644
--- a/sys/net/if.h
+++ b/sys/net/if.h
@@ -43,6 +43,7 @@
 #include <sys/socket.h>
 #ifndef _KERNEL
 #include <sys/time.h>
+#include <sys/stdint.h>
 #endif /* !_KERNEL */
 #endif /* __BSD_VISIBLE */
 
@@ -70,7 +71,7 @@ struct if_data {
 	u_long	ifi_mtu;		/* maximum transmission unit */
 	u_long	ifi_metric;		/* routing metric (external only) */
 	u_long  ifi_link_state;		/* current link state */
-	uint64_t ifi_baudrate;		/* linespeed */
+	u_int64_t ifi_baudrate;		/* linespeed */
 	/* volatile statistics */
 	u_long	ifi_ipackets;		/* packets received on interface */
 	u_long	ifi_ierrors;		/* input errors on interface */
diff --git a/sys/net/if_media.h b/sys/net/if_media.h
index 25d68c83e6..a40df8dae5 100644
--- a/sys/net/if_media.h
+++ b/sys/net/if_media.h
@@ -41,6 +41,9 @@
 #ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 
 /*
  * Prototypes and definitions for BSD/OS-compatible network interface
diff --git a/sys/netbt/bluetooth.h b/sys/netbt/bluetooth.h
index 54cd927c96..a5a059e881 100644
--- a/sys/netbt/bluetooth.h
+++ b/sys/netbt/bluetooth.h
@@ -1,4 +1,3 @@
-/* $DragonFly: src/sys/netbt/bluetooth.h,v 1.2 2008/03/18 13:41:42 hasso Exp $ */
 /* $OpenBSD: src/sys/netbt/bluetooth.h,v 1.5 2008/02/24 21:34:48 uwe Exp $ */
 /* $NetBSD: bluetooth.h,v 1.6 2007/09/17 01:23:17 rillig Exp $ */
 
@@ -37,6 +36,7 @@
 
 #include <sys/socket.h>
 #include <sys/types.h>
+#include <sys/stdint.h>
 
 /*
  * Bluetooth Address Family Protocol Numbers
diff --git a/sys/netbt/l2cap.h b/sys/netbt/l2cap.h
index fe2286a48e..1b6440466e 100644
--- a/sys/netbt/l2cap.h
+++ b/sys/netbt/l2cap.h
@@ -1,4 +1,3 @@
-/* $DragonFly: src/sys/netbt/l2cap.h,v 1.2 2008/03/18 13:41:42 hasso Exp $ */
 /* $OpenBSD: src/sys/netbt/l2cap.h,v 1.5 2008/02/24 21:34:48 uwe Exp $ */
 /* $NetBSD: l2cap.h,v 1.6 2007/11/03 17:20:17 plunky Exp $ */
 
@@ -72,6 +71,7 @@
 #define _NETBT_L2CAP_H_
 
 #include <sys/types.h>
+#include <sys/stdint.h>
 
 /**************************************************************************
  **************************************************************************
diff --git a/sys/netbt/rfcomm.h b/sys/netbt/rfcomm.h
index ff9c324ad5..d9d5c92e23 100644
--- a/sys/netbt/rfcomm.h
+++ b/sys/netbt/rfcomm.h
@@ -1,4 +1,3 @@
-/* $DragonFly: src/sys/netbt/rfcomm.h,v 1.2 2008/03/18 13:41:42 hasso Exp $ */
 /* $OpenBSD: src/sys/netbt/rfcomm.h,v 1.2 2008/02/24 21:34:48 uwe Exp $ */
 /* $NetBSD: rfcomm.h,v 1.6 2007/11/20 20:25:58 plunky Exp $ */
 
@@ -65,6 +64,7 @@
 #define _NETBT_RFCOMM_H_
 
 #include <sys/types.h>
+#include <sys/stdint.h>
 
 /*************************************************************************
  *************************************************************************
diff --git a/sys/netgraph/ksocket/ng_ksocket.h b/sys/netgraph/ksocket/ng_ksocket.h
index 6077b8f9ce..b27058e42a 100644
--- a/sys/netgraph/ksocket/ng_ksocket.h
+++ b/sys/netgraph/ksocket/ng_ksocket.h
@@ -4,7 +4,7 @@
  *
  * Copyright (c) 1996-1999 Whistle Communications, Inc.
  * All rights reserved.
- * 
+ *
  * Subject to the following obligations and disclaimer of warranty, use and
  * redistribution of this software, in source or object code forms, with or
  * without modifications are expressly permitted by Whistle Communications;
@@ -15,7 +15,7 @@
  *    Communications, Inc. trademarks, including the mark "WHISTLE
  *    COMMUNICATIONS" on advertising, endorsements, or otherwise except as
  *    such appears in the above copyright notice or in the software.
- * 
+ *
  * THIS SOFTWARE IS BEING PROVIDED BY WHISTLE COMMUNICATIONS "AS IS", AND
  * TO THE MAXIMUM EXTENT PERMITTED BY LAW, WHISTLE COMMUNICATIONS MAKES NO
  * REPRESENTATIONS OR WARRANTIES, EXPRESS OR IMPLIED, REGARDING THIS SOFTWARE,
@@ -37,7 +37,6 @@
  * Author: Archie Cobbs <archie@freebsd.org>
  *
  * $FreeBSD: src/sys/netgraph/ng_ksocket.h,v 1.2.2.5 2002/07/02 23:44:02 archie Exp $
- * $DragonFly: src/sys/netgraph/ksocket/ng_ksocket.h,v 1.2 2003/06/17 04:28:50 dillon Exp $
  * $Whistle: ng_ksocket.h,v 1.1 1999/11/16 20:04:40 archie Exp $
  */
 
@@ -45,6 +44,7 @@
 #define _NETGRAPH_KSOCKET_H_
 
 #include <sys/socket.h>
+#include <sys/stdint.h>
 
 /* Node type name and magic cookie */
 #define NG_KSOCKET_NODE_TYPE	"ksocket"
@@ -54,7 +54,7 @@
 struct ng_ksocket_sockopt {
 	int32_t		level;		/* second arg of [gs]etsockopt() */
 	int32_t		name;		/* third arg of [gs]etsockopt() */
-	u_char		value[0];	/* fourth arg of [gs]etsockopt() */
+	unsigned char	value[0];	/* fourth arg of [gs]etsockopt() */
 };
 
 /* Max length socket option we can return via NGM_KSOCKET_GETOPT
@@ -72,7 +72,7 @@ struct ng_ksocket_sockopt {
 
 /* For NGM_KSOCKET_ACCEPT control message responses */
 struct ng_ksocket_accept {
-	u_int32_t	nodeid;		/* node ID of connected ksocket */
+	uint32_t	nodeid;		/* node ID of connected ksocket */
 	struct sockaddr	addr;		/* peer's address (variable length) */
 };
 
diff --git a/sys/netgraph7/ksocket/ng_ksocket.h b/sys/netgraph7/ksocket/ng_ksocket.h
index d266177099..463bcfac1f 100644
--- a/sys/netgraph7/ksocket/ng_ksocket.h
+++ b/sys/netgraph7/ksocket/ng_ksocket.h
@@ -5,7 +5,7 @@
 /*-
  * Copyright (c) 1996-1999 Whistle Communications, Inc.
  * All rights reserved.
- * 
+ *
  * Subject to the following obligations and disclaimer of warranty, use and
  * redistribution of this software, in source or object code forms, with or
  * without modifications are expressly permitted by Whistle Communications;
@@ -16,7 +16,7 @@
  *    Communications, Inc. trademarks, including the mark "WHISTLE
  *    COMMUNICATIONS" on advertising, endorsements, or otherwise except as
  *    such appears in the above copyright notice or in the software.
- * 
+ *
  * THIS SOFTWARE IS BEING PROVIDED BY WHISTLE COMMUNICATIONS "AS IS", AND
  * TO THE MAXIMUM EXTENT PERMITTED BY LAW, WHISTLE COMMUNICATIONS MAKES NO
  * REPRESENTATIONS OR WARRANTIES, EXPRESS OR IMPLIED, REGARDING THIS SOFTWARE,
@@ -38,7 +38,6 @@
  * Author: Archie Cobbs <archie@freebsd.org>
  *
  * $FreeBSD: src/sys/netgraph/ng_ksocket.h,v 1.13 2005/10/28 14:41:28 ru Exp $
- * $DragonFly: src/sys/netgraph7/ng_ksocket.h,v 1.2 2008/06/26 23:05:35 dillon Exp $
  * $Whistle: ng_ksocket.h,v 1.1 1999/11/16 20:04:40 archie Exp $
  */
 
@@ -46,6 +45,7 @@
 #define _NETGRAPH_NG_KSOCKET_H_
 
 #include <sys/socket.h>
+#include <sys/stdint.h>
 
 /* Node type name and magic cookie */
 #define NG_KSOCKET_NODE_TYPE	"ksocket"
@@ -55,7 +55,7 @@
 struct ng_ksocket_sockopt {
 	int32_t		level;		/* second arg of [gs]etsockopt() */
 	int32_t		name;		/* third arg of [gs]etsockopt() */
-	u_char		value[];	/* fourth arg of [gs]etsockopt() */
+	unsigned char	value[];	/* fourth arg of [gs]etsockopt() */
 };
 
 /* Max length socket option we can return via NGM_KSOCKET_GETOPT
diff --git a/sys/netgraph7/ng_message.h b/sys/netgraph7/ng_message.h
index a40851d14f..f0475d999d 100644
--- a/sys/netgraph7/ng_message.h
+++ b/sys/netgraph7/ng_message.h
@@ -5,7 +5,7 @@
 /*-
  * Copyright (c) 1996-1999 Whistle Communications, Inc.
  * All rights reserved.
- * 
+ *
  * Subject to the following obligations and disclaimer of warranty, use and
  * redistribution of this software, in source or object code forms, with or
  * without modifications are expressly permitted by Whistle Communications;
@@ -16,7 +16,7 @@
  *    Communications, Inc. trademarks, including the mark "WHISTLE
  *    COMMUNICATIONS" on advertising, endorsements, or otherwise except as
  *    such appears in the above copyright notice or in the software.
- * 
+ *
  * THIS SOFTWARE IS BEING PROVIDED BY WHISTLE COMMUNICATIONS "AS IS", AND
  * TO THE MAXIMUM EXTENT PERMITTED BY LAW, WHISTLE COMMUNICATIONS MAKES NO
  * REPRESENTATIONS OR WARRANTIES, EXPRESS OR IMPLIED, REGARDING THIS SOFTWARE,
@@ -113,7 +113,7 @@ struct ng_mesg {
 #define NGF_RESP	0x00000001	/* the message is a response */
 
 /* Type of a unique node ID. */
-#define ng_ID_t uint32_t
+#define ng_ID_t u_int32_t
 
 /*
  * Here we describe the "generic" messages that all nodes inherently
diff --git a/sys/netinet/in.h b/sys/netinet/in.h
index 24c77dfc87..3de257e2cd 100644
--- a/sys/netinet/in.h
+++ b/sys/netinet/in.h
@@ -51,6 +51,10 @@
 #endif
 #endif
 
+#ifndef _KERNEL
+#include <stdint.h>	/* for uint8_t uint32_t as in <inttypes.h> */
+#endif
+
 /*
  * Constants and structures defined by the internet system,
  * Per RFC 790, September 1981, and numerous additions.
diff --git a/sys/netinet/pim.h b/sys/netinet/pim.h
index 7051d1d660..194320fae6 100644
--- a/sys/netinet/pim.h
+++ b/sys/netinet/pim.h
@@ -42,8 +42,8 @@
  * Modified by Pavlin Radoslavov, USC/ISI, May 1998, October 2000.
  */
 
-#ifndef _SYS_TYPES_H_
-#include <sys/types.h>
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
 #endif
 #include <machine/endian.h>
 
@@ -55,10 +55,10 @@ struct pim {
 #ifdef _PIM_VT
 	uint8_t		pim_vt;		/* PIM version and message type	*/
 #elif _BYTE_ORDER == _BIG_ENDIAN
-	u_int		pim_vers:4,	/* PIM protocol version		*/
+	unsigned int	pim_vers:4,	/* PIM protocol version		*/
 			pim_type:4;	/* PIM message type		*/
 #elif _BYTE_ORDER == _LITTLE_ENDIAN
-	u_int		pim_type:4,	/* PIM message type		*/
+	unsigned int	pim_type:4,	/* PIM message type		*/
 			pim_vers:4;	/* PIM protocol version		*/
 #else
 #error "Byte order not implemented"
diff --git a/sys/netinet/tcp.h b/sys/netinet/tcp.h
index 1eacd0f81d..0838120e15 100644
--- a/sys/netinet/tcp.h
+++ b/sys/netinet/tcp.h
@@ -39,8 +39,8 @@
 
 #include <sys/types.h>
 
-typedef	u_int32_t	tcp_seq;
-typedef	int32_t		tcp_seq_diff_t;
+typedef	__uint32_t	tcp_seq;
+typedef	__int32_t	tcp_seq_diff_t;
 
 #define	tcp6_seq	tcp_seq	/* for KAME src sync over BSD*'s */
 #define	tcp6hdr		tcphdr	/* for KAME src sync over BSD*'s */
diff --git a/sys/netproto/802_11/ieee80211_input.h b/sys/netproto/802_11/ieee80211_input.h
index eea667d7bf..c96929bd9e 100644
--- a/sys/netproto/802_11/ieee80211_input.h
+++ b/sys/netproto/802_11/ieee80211_input.h
@@ -80,6 +80,7 @@ void	ieee80211_ssid_mismatch(struct ieee80211vap *, const char *tag,
 #endif /* !IEEE80211_DEBUG */
 
 #include <sys/endian.h>		/* For le16toh() / le32dec() */
+#include <sys/stdint.h>
 
 static __inline int
 iswpaoui(const uint8_t *frm)
diff --git a/sys/netproto/smb/smb.h b/sys/netproto/smb/smb.h
index 1620f94bc9..782b52f8b2 100644
--- a/sys/netproto/smb/smb.h
+++ b/sys/netproto/smb/smb.h
@@ -30,13 +30,14 @@
  * SUCH DAMAGE.
  *
  * $FreeBSD: src/sys/netsmb/smb.h,v 1.1.2.3 2002/04/23 03:45:01 bp Exp $
- * $DragonFly: src/sys/netproto/smb/smb.h,v 1.2 2003/06/17 04:28:54 dillon Exp $
  */
 
+#include <sys/stdint.h>
+
 /*
  * Common definintions and structures for SMB/CIFS protocol
  */
- 
+
 #ifndef _NETSMB_SMB_H_
 #define _NETSMB_SMB_H_
 
@@ -44,7 +45,7 @@
 /*
  * SMB dialects that we have to deal with.
  */
-enum smb_dialects { 
+enum smb_dialects {
 	SMB_DIALECT_NONE,
 	SMB_DIALECT_CORE,		/* PC NETWORK PROGRAM 1.0, PCLAN1.0 */
 	SMB_DIALECT_COREPLUS,		/* MICROSOFT NETWORKS 1.03 */
diff --git a/sys/platform/pc64/apic/lapic.h b/sys/platform/pc64/apic/lapic.h
index d6a5afd5e4..e0d0f3e183 100644
--- a/sys/platform/pc64/apic/lapic.h
+++ b/sys/platform/pc64/apic/lapic.h
@@ -80,15 +80,15 @@ void	lapic_x2apic_enter(boolean_t);
 #include <machine/smp.h>
 #endif
 
+#ifndef _SYS_CPUMASK_H_
+#include <sys/cpumask.h>
+#endif
+
 void	selected_apic_ipi(cpumask_t, int, int);
 
 /*
  * Send an IPI INTerrupt containing 'vector' to all CPUs EXCEPT myself
  */
-#ifndef _CPU_CPUMASK_H_
-#include <machine/cpumask.h>
-#endif
-
 static __inline int
 all_but_self_ipi(int vector)
 {
diff --git a/sys/platform/pc64/include/clock.h b/sys/platform/pc64/include/clock.h
index 07eecbd5fa..7795722a00 100644
--- a/sys/platform/pc64/include/clock.h
+++ b/sys/platform/pc64/include/clock.h
@@ -9,9 +9,7 @@
 #ifndef _MACHINE_CLOCK_H_
 #define	_MACHINE_CLOCK_H_
 
-#ifndef _SYS_TYPES_H_
-#include <sys/types.h>
-#endif
+#include <machine/stdint.h>
 
 #ifdef _KERNEL
 
@@ -27,8 +25,8 @@ typedef struct TOTALDELAY {
 
 #endif
 
-typedef uint64_t tsc_uclock_t;
-typedef int64_t	tsc_sclock_t;
+typedef __uint64_t	tsc_uclock_t;
+typedef __int64_t	tsc_sclock_t;
 
 #ifdef _KERNEL
 
diff --git a/sys/platform/pc64/include/msi_var.h b/sys/platform/pc64/include/msi_var.h
index ea8ca1f61a..e59392cefd 100644
--- a/sys/platform/pc64/include/msi_var.h
+++ b/sys/platform/pc64/include/msi_var.h
@@ -1,8 +1,8 @@
 #ifndef _ARCH_MSI_VAR_H_
 #define _ARCH_MSI_VAR_H_
 
-#ifndef _SYS_TYPES_H_
-#include <sys/types.h>
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
 #endif
 
 void	msi_setup(int intr, int cpuid);
diff --git a/sys/platform/pc64/include/pmap.h b/sys/platform/pc64/include/pmap.h
index 0a0459dace..99b5174add 100644
--- a/sys/platform/pc64/include/pmap.h
+++ b/sys/platform/pc64/include/pmap.h
@@ -153,6 +153,9 @@
 #ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_CPUMASK_H_
+#include <sys/cpumask.h>
+#endif
 #ifndef _SYS_QUEUE_H_
 #include <sys/queue.h>
 #endif
diff --git a/sys/platform/pc64/vmm/vmm_utils.c b/sys/platform/pc64/vmm/vmm_utils.c
index 332eb32f9b..f571535d29 100644
--- a/sys/platform/pc64/vmm/vmm_utils.c
+++ b/sys/platform/pc64/vmm/vmm_utils.c
@@ -36,6 +36,7 @@
 #include <sys/proc.h>
 #include <sys/systm.h>
 #include <cpu/lwbuf.h>
+#include <cpu/pmap.h>
 #include <vm/vm_page.h>
 #include <vm/vm_extern.h>
 
diff --git a/sys/platform/pc64/x86_64/genassym.c b/sys/platform/pc64/x86_64/genassym.c
index 8f75b5e026..4f9d1ac2e1 100644
--- a/sys/platform/pc64/x86_64/genassym.c
+++ b/sys/platform/pc64/x86_64/genassym.c
@@ -81,8 +81,6 @@ ASSYM(UPAGES, UPAGES);
 ASSYM(PAGE_SIZE, PAGE_SIZE);
 ASSYM(NPTEPG, NPTEPG);
 ASSYM(NPDEPG, NPDEPG);
-ASSYM(PDESIZE, PDESIZE);
-ASSYM(PTESIZE, PTESIZE);
 ASSYM(PAGE_SHIFT, PAGE_SHIFT);
 ASSYM(PAGE_MASK, PAGE_MASK);
 ASSYM(PDRSHIFT, PDRSHIFT);
diff --git a/sys/platform/vkernel64/include/clock.h b/sys/platform/vkernel64/include/clock.h
index 6de7454cdd..d565a8e79e 100644
--- a/sys/platform/vkernel64/include/clock.h
+++ b/sys/platform/vkernel64/include/clock.h
@@ -11,12 +11,10 @@
 
 #ifdef _KERNEL
 
-#ifndef _SYS_TYPES_H_
-#include <sys/types.h>
-#endif
+#include <machine/stdint.h>
 
-typedef uint64_t tsc_uclock_t;
-typedef int64_t tsc_sclock_t;
+typedef __uint64_t tsc_uclock_t;
+typedef __int64_t tsc_sclock_t;
 
 /*
  * x86 to clock driver interface.
diff --git a/sys/platform/vkernel64/include/pmap.h b/sys/platform/vkernel64/include/pmap.h
index 9ebd2bb4f2..c42ddc4176 100644
--- a/sys/platform/vkernel64/include/pmap.h
+++ b/sys/platform/vkernel64/include/pmap.h
@@ -95,6 +95,9 @@
 #ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_CPUMASK_H_
+#include <sys/cpumask.h>
+#endif
 #ifndef _SYS_QUEUE_H_
 #include <sys/queue.h>
 #endif
diff --git a/sys/platform/vkernel64/x86_64/mp.c b/sys/platform/vkernel64/x86_64/mp.c
index 8377d7a577..4845131791 100644
--- a/sys/platform/vkernel64/x86_64/mp.c
+++ b/sys/platform/vkernel64/x86_64/mp.c
@@ -32,7 +32,7 @@
  * SUCH DAMAGE.
  */
 
-
+#include <sys/cpumask.h>
 #include <sys/interrupt.h>
 #include <sys/kernel.h>
 #include <sys/memrange.h>
@@ -50,7 +50,6 @@
 
 #include <machine/cpu.h>
 #include <machine/cpufunc.h>
-#include <machine/cpumask.h>
 #include <machine/globaldata.h>
 #include <machine/md_var.h>
 #include <machine/pmap.h>
diff --git a/sys/sys/aio.h b/sys/sys/aio.h
index aca1f5a55d..f0e854c1ba 100644
--- a/sys/sys/aio.h
+++ b/sys/sys/aio.h
@@ -22,7 +22,7 @@
 #include <sys/_pthreadtypes.h>
 #include <sys/_timespec.h>
 #include <sys/signal.h>
-#include <sys/stdint.h>
+#include <machine/stdint.h>
 
 #ifndef _OFF_T_DECLARED
 typedef	__off_t		off_t;
diff --git a/sys/sys/bio.h b/sys/sys/bio.h
index bb40a3c2e7..e619757d2d 100644
--- a/sys/sys/bio.h
+++ b/sys/sys/bio.h
@@ -30,8 +30,6 @@
  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
  * SUCH DAMAGE.
- *
- * $DragonFly: src/sys/sys/bio.h,v 1.6 2008/07/14 03:08:58 dillon Exp $
  */
 
 #ifndef _SYS_BIO_H_
@@ -40,9 +38,13 @@
 #ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 #ifndef _SYS_QUEUE_H_
 #include <sys/queue.h>
 #endif
+#include <sys/_timeval.h>
 
 struct bio;
 struct bio_track;
diff --git a/sys/sys/blist.h b/sys/sys/blist.h
index d5a9dce221..63d972dcea 100644
--- a/sys/sys/blist.h
+++ b/sys/sys/blist.h
@@ -1,13 +1,13 @@
 /*
  * Copyright (c) 2003,2004 The DragonFly Project.  All rights reserved.
- * 
+ *
  * This code is derived from software contributed to The DragonFly Project
  * by Matthew Dillon <dillon@backplane.com>
- * 
+ *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
- * 
+ *
  * 1. Redistributions of source code must retain the above copyright
  *    notice, this list of conditions and the following disclaimer.
  * 2. Redistributions in binary form must reproduce the above copyright
@@ -17,7 +17,7 @@
  * 3. Neither the name of The DragonFly Project nor the names of its
  *    contributors may be used to endorse or promote products derived
  *    from this software without specific, prior written permission.
- * 
+ *
  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
@@ -30,7 +30,7 @@
  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
  * SUCH DAMAGE.
- * 
+ *
  * Implements bitmap resource lists.
  *
  *	Usage:
@@ -40,7 +40,7 @@
  *		(void)  blist_free(blist, blkno, count)
  *		nblks = blist_fill(blist, blkno, count)
  *		(void)  blist_resize(&blist, count, freeextra)
- *		
+ *
  *
  *	Notes:
  *		on creation, the entire list is marked reserved.  You should
@@ -51,19 +51,21 @@
  *		SWAPBLK_NONE is returned on failure.  This module is typically
  *		capable of managing up to (2^31) blocks per blist, though
  *		the memory utilization would be insane if you actually did
- *		that.  Managing something like 512MB worth of 4K blocks 
- *		eats around 32 KBytes of memory. 
+ *		that.  Managing something like 512MB worth of 4K blocks
+ *		eats around 32 KBytes of memory.
  *
  * $FreeBSD: src/sys/sys/blist.h,v 1.2.2.1 2003/01/12 09:23:12 dillon Exp $
- * $DragonFly: src/sys/sys/blist.h,v 1.7 2008/08/10 22:09:51 dillon Exp $
  */
 
 #ifndef _SYS_BLIST_H_
 #define _SYS_BLIST_H_
 
-#ifndef _SYS_TYPES_H_ 
+#ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 
 #define SWBLK_BITS	64
 typedef int64_t		swblk_t;
diff --git a/sys/sys/callout.h b/sys/sys/callout.h
index 3db4d26a62..ec858e22a0 100644
--- a/sys/sys/callout.h
+++ b/sys/sys/callout.h
@@ -44,6 +44,9 @@
 #ifndef _SYS_SPINLOCK_H_
 #include <sys/spinlock.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 
 /*
  * WITH TYPESTABLE (currently disabled)
diff --git a/sys/sys/cdrio.h b/sys/sys/cdrio.h
index 19ffcc9a03..da0b223a92 100644
--- a/sys/sys/cdrio.h
+++ b/sys/sys/cdrio.h
@@ -26,7 +26,6 @@
  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  *
  * $FreeBSD: src/sys/sys/cdrio.h,v 1.1.2.3 2002/11/20 00:26:18 njl Exp $
- * $DragonFly: src/sys/sys/cdrio.h,v 1.3 2006/05/20 02:42:13 dillon Exp $
  */
 
 #ifndef	_SYS_CDRIO_H_
@@ -35,6 +34,9 @@
 #ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 #ifndef _SYS_IOCCOM_H_
 #include <sys/ioccom.h>
 #endif
diff --git a/sys/sys/cpu_topology.h b/sys/sys/cpu_topology.h
index 3db45c0af4..a0b441d5cf 100644
--- a/sys/sys/cpu_topology.h
+++ b/sys/sys/cpu_topology.h
@@ -3,7 +3,7 @@
 
 #if defined(_KERNEL) || defined(_KERNEL_STRUCTURES)
 
-#include <machine/cpumask.h>
+#include <sys/cpumask.h>
 
 /* CPU TOPOLOGY DATA AND FUNCTIONS */
 struct cpu_node {
diff --git a/sys/sys/cpumask.h b/sys/sys/cpumask.h
new file mode 100644
index 0000000000..4d11fd218b
--- /dev/null
+++ b/sys/sys/cpumask.h
@@ -0,0 +1,60 @@
+/*
+ * Copyright (c) 2019 The DragonFly Project.  All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ * 2. Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in the
+ *    documentation and/or other materials provided with the distribution.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
+ * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
+ * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
+ * FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE
+ * COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
+ * INCIDENTAL, SPECIAL, EXEMPLARY OR CONSEQUENTIAL DAMAGES (INCLUDING,
+ * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED
+ * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
+ * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
+ * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
+ * SUCH DAMAGE.
+ */
+
+#ifndef _SYS_CPUMASK_H_
+#define _SYS_CPUMASK_H_
+
+#include <machine/cpumask.h>
+#include <machine/stdint.h>
+
+typedef	__cpumask_t	cpumask_t;
+
+#ifndef _KERNEL
+#define	CPU_SETSIZE		((int)(sizeof(cpumask_t) * 8))
+#define	CPU_ZERO(set)			__CPU_ZERO(set)
+#define	CPU_SET(cpu, set)		__CPU_SET(cpu, set)
+#define	CPU_CLR(cpu, set)		__CPU_CLR(cpu, set)
+#define	CPU_ISSET(cpu, set)		__CPU_ISSET(cpu, set)
+#define	CPU_COUNT(set)			__CPU_COUNT(set)
+#define	CPU_AND(dst, set1, set2)	__CPU_AND(dst, set1, set2)
+#define	CPU_OR(dst, set1, set2)		__CPU_OR(dst, set1, set2)
+#define	CPU_XOR(dst, set1, set2)	__CPU_XOR(dst, set1, set2)
+#define	CPU_EQUAL(set1, set2)		__CPU_EQUAL(set1, set2)
+#endif
+
+/*
+ * It is convenient to place this type here due to its proximity to the
+ * cpumask_t use cases in structs.  Keep public for easier access to
+ * struct proc for now.
+ */
+typedef	__uint32_t	cpulock_t;	/* count and exclusive lock */
+
+#define	CPULOCK_EXCLBIT	0		/* exclusive lock bit number */
+#define	CPULOCK_EXCL	0x00000001	/* exclusive lock */
+#define	CPULOCK_INCR	0x00000002	/* auxillary counter add/sub */
+#define	CPULOCK_CNTMASK	0x7FFFFFFE
+
+#endif /* !_SYS_CPUMASK_H_ */
diff --git a/sys/sys/devicestat.h b/sys/sys/devicestat.h
index 7fce134847..29c135c62e 100644
--- a/sys/sys/devicestat.h
+++ b/sys/sys/devicestat.h
@@ -34,6 +34,7 @@
 #include <sys/queue.h>
 #include <sys/time.h>
 #include <sys/types.h>
+#include <sys/stdint.h>
 
 #define DEVSTAT_NAME_LEN  16
 
diff --git a/sys/sys/dirent.h b/sys/sys/dirent.h
index 4bd1ef7368..496d0d7474 100644
--- a/sys/sys/dirent.h
+++ b/sys/sys/dirent.h
@@ -55,6 +55,7 @@
 
 #include <sys/cdefs.h>
 #include <sys/types.h>
+#include <sys/stdint.h>
 
 struct dirent {
 #if defined(_KERNEL) || !__BSD_VISIBLE
diff --git a/sys/sys/diskmbr.h b/sys/sys/diskmbr.h
index 32c962e937..242458e3f5 100644
--- a/sys/sys/diskmbr.h
+++ b/sys/sys/diskmbr.h
@@ -33,6 +33,7 @@
 #define	_SYS_DISKMBR_H_
 
 #include <sys/types.h>
+#include <sys/stdint.h>
 
 #define	DOSBBSECTOR	0	/* DOS boot block relative sector number */
 #define	DOSPARTOFF	446
diff --git a/sys/sys/dmsg.h b/sys/sys/dmsg.h
index ecc91e3275..337de5a937 100644
--- a/sys/sys/dmsg.h
+++ b/sys/sys/dmsg.h
@@ -38,6 +38,9 @@
 #ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 #if defined(_KERNEL) || defined(_KERNEL_STRUCTURES)
 #ifndef _SYS_TREE_H_
 #include <sys/tree.h>
diff --git a/sys/sys/efi.h b/sys/sys/efi.h
index 946b191fcb..2419537e78 100644
--- a/sys/sys/efi.h
+++ b/sys/sys/efi.h
@@ -29,6 +29,8 @@
 #ifndef _SYS_EFI_H_
 #define _SYS_EFI_H_
 
+#include <sys/types.h>
+#include <sys/stdint.h>
 #include <sys/uuid.h>
 
 #define	EFI_PAGE_SHIFT		12
diff --git a/sys/sys/elf32.h b/sys/sys/elf32.h
index 8f89193585..17d0147ee4 100644
--- a/sys/sys/elf32.h
+++ b/sys/sys/elf32.h
@@ -32,6 +32,9 @@
 #ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>		/* for int32_t */
+#endif
 #ifndef _SYS_ELF_COMMON_H_
 #include <sys/elf_common.h>
 #endif
diff --git a/sys/sys/elf64.h b/sys/sys/elf64.h
index 5a352798b7..2a88715e5e 100644
--- a/sys/sys/elf64.h
+++ b/sys/sys/elf64.h
@@ -24,7 +24,6 @@
  * SUCH DAMAGE.
  *
  * $FreeBSD: src/sys/sys/elf64.h,v 1.17 2006/10/17 05:43:30 jkoshy Exp $
- * $DragonFly: src/sys/sys/elf64.h,v 1.10 2008/08/30 17:07:17 swildner Exp $
  */
 
 #ifndef _SYS_ELF64_H_
@@ -33,6 +32,9 @@
 #ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>		/* for int32_t, int64_t, uint64_t, uint64_t */
+#endif
 #ifndef _SYS_ELF_COMMON_H_
 #include <sys/elf_common.h>
 #endif
diff --git a/sys/sys/event.h b/sys/sys/event.h
index ff82e134ca..af71a32734 100644
--- a/sys/sys/event.h
+++ b/sys/sys/event.h
@@ -32,9 +32,13 @@
 #ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 #if defined(_KERNEL) || defined(_KERNEL_STRUCTURES)
 #include <sys/queue.h>
 #endif
+#include <sys/_timespec.h>
 
 #define EVFILT_READ		(-1)
 #define EVFILT_WRITE		(-2)
diff --git a/sys/sys/fbio.h b/sys/sys/fbio.h
index e1264c3771..3d8c9e7c83 100644
--- a/sys/sys/fbio.h
+++ b/sys/sys/fbio.h
@@ -44,6 +44,7 @@
 #ifndef _SYS_IOCCOM_H_
 #include <sys/ioccom.h>
 #endif
+#include <machine/types.h>	/* for vm_offset_t */
 
 /*
  * Frame buffer ioctls (from Sprite, trimmed to essentials for X11).
diff --git a/sys/sys/globaldata.h b/sys/sys/globaldata.h
index 704daa6fd2..26d45d4484 100644
--- a/sys/sys/globaldata.h
+++ b/sys/sys/globaldata.h
@@ -1,13 +1,13 @@
 /*
  * Copyright (c) 2003-2011 The DragonFly Project.  All rights reserved.
- * 
+ *
  * This code is derived from software contributed to The DragonFly Project
  * by Matthew Dillon <dillon@backplane.com>
- * 
+ *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
- * 
+ *
  * 1. Redistributions of source code must retain the above copyright
  *    notice, this list of conditions and the following disclaimer.
  * 2. Redistributions in binary form must reproduce the above copyright
@@ -17,7 +17,7 @@
  * 3. Neither the name of The DragonFly Project nor the names of its
  *    contributors may be used to endorse or promote products derived
  *    from this software without specific, prior written permission.
- * 
+ *
  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
@@ -30,7 +30,7 @@
  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
  * SUCH DAMAGE.
- * 
+ *
  * Copyright (c) Peter Wemm <peter@netplex.com.au> All rights reserved.
  *
  * Redistribution and use in source and binary forms, with or without
@@ -60,9 +60,6 @@
 
 #if defined(_KERNEL) || defined(_KERNEL_STRUCTURES)
 
-#ifndef _SYS_STDINT_H_
-#include <sys/stdint.h>		/* __int types */
-#endif
 #ifndef _SYS_TIME_H_
 #include <sys/time.h>		/* struct timeval */
 #endif
@@ -93,6 +90,7 @@
 #ifndef _SYS_LOCK_H_
 #include <sys/lock.h>
 #endif
+#include <machine/stdint.h>
 
 /*
  * This structure maps out the global data that needs to be kept on a
diff --git a/sys/sys/gpt.h b/sys/sys/gpt.h
index 4a7f189ff7..a586ee36fa 100644
--- a/sys/sys/gpt.h
+++ b/sys/sys/gpt.h
@@ -29,6 +29,7 @@
 #ifndef _SYS_GPT_H_
 #define	_SYS_GPT_H_
 
+#include <sys/stdint.h>
 #include <sys/uuid.h>
 
 struct gpt_hdr {
diff --git a/sys/sys/hash.h b/sys/sys/hash.h
index 3428259f17..4169f1c895 100644
--- a/sys/sys/hash.h
+++ b/sys/sys/hash.h
@@ -29,6 +29,7 @@
 #ifndef _SYS_HASH_H_
 #define	_SYS_HASH_H_
 #include <sys/types.h>
+#include <sys/stdint.h>
 
 /* Convenience */
 #ifndef	HASHINIT
diff --git a/sys/sys/ipc.h b/sys/sys/ipc.h
index 06c34b9615..613f78e0ba 100644
--- a/sys/sys/ipc.h
+++ b/sys/sys/ipc.h
@@ -47,7 +47,27 @@
 #define	_SYS_IPC_H_
 
 #include <sys/cdefs.h>
-#include <sys/types.h>
+#include <machine/stdint.h>
+
+#ifndef _GID_T_DECLARED
+typedef	__uint32_t	gid_t;	/* group id */
+#define	_GID_T_DECLARED
+#endif
+
+#ifndef _KEY_T_DECLARED
+typedef	long		key_t;	/* IPC key (for Sys V IPC) */
+#define _KEY_T_DECLARED
+#endif
+
+#ifndef _MODE_T_DECLARED
+typedef	__uint16_t	mode_t;	/* permissions */
+#define	_MODE_T_DECLARED
+#endif
+
+#ifndef _UID_T_DECLARED
+typedef	__uint32_t	uid_t;	/* user id */
+#define	_UID_T_DECLARED
+#endif
 
 struct ipc_perm {
 	uid_t		cuid;	/* creator user id */
diff --git a/sys/sys/jail.h b/sys/sys/jail.h
index 0811cf47bf..3574b9aa70 100644
--- a/sys/sys/jail.h
+++ b/sys/sys/jail.h
@@ -12,12 +12,12 @@
 #ifndef _SYS_JAIL_H_
 #define _SYS_JAIL_H_
 
-#ifndef _SYS_TYPES_H_
-#include <sys/types.h>
-#endif
 #ifndef _SYS_PARAM_H_
 #include <sys/param.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 #ifndef _SYS_QUEUE_H_
 #include <sys/queue.h>
 #endif
diff --git a/sys/sys/journal.h b/sys/sys/journal.h
index cdeab9baea..4dfca9ef30 100644
--- a/sys/sys/journal.h
+++ b/sys/sys/journal.h
@@ -1,13 +1,13 @@
 /*
  * Copyright (c) 2004 The DragonFly Project.  All rights reserved.
- * 
+ *
  * This code is derived from software contributed to The DragonFly Project
  * by Matthew Dillon <dillon@backplane.com>
- * 
+ *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
- * 
+ *
  * 1. Redistributions of source code must retain the above copyright
  *    notice, this list of conditions and the following disclaimer.
  * 2. Redistributions in binary form must reproduce the above copyright
@@ -17,7 +17,7 @@
  * 3. Neither the name of The DragonFly Project nor the names of its
  *    contributors may be used to endorse or promote products derived
  *    from this software without specific, prior written permission.
- * 
+ *
  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
@@ -30,8 +30,6 @@
  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
  * SUCH DAMAGE.
- *
- * $DragonFly: src/sys/sys/journal.h,v 1.13 2007/05/09 00:53:35 dillon Exp $
  */
 
 #ifndef _SYS_JOURNAL_H_
@@ -40,6 +38,9 @@
 #ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 #ifndef _SYS_TIME_H_
 #include <sys/time.h>
 #endif
@@ -67,7 +68,7 @@
  * plus a transaction start bit, end bit, and abort bit.
  *
  * Stream identifiers in the 0x00-0xFF range are special and not used for
- * normal transactional commands. 
+ * normal transactional commands.
  *
  * Stream id 0x00 indicates that no other streams should be active at that
  * point in the journal, which helps the journaling code detect corruption.
@@ -105,7 +106,7 @@
  * The journal_rawrecend structure MUST be a multiple of 8 bytes.
  *
  * NOTE: PAD RECORD SPECIAL CASE.  Pad records can be 16 bytes and have the
- * rawrecend structure overlayed on the sequence number field of the 
+ * rawrecend structure overlayed on the sequence number field of the
  * rawrecbeg structure.  This is necessary because stream records are
  * 16 byte aligned, not 24 byte aligned, and dead space is not allowed.
  * So the pad record must fit into any dead space.  THEREFORE, THE TRANSID
@@ -181,10 +182,10 @@ struct journal_ackrecord {
 
 /*
  * Each logical journaling stream typically represents a transaction...
- * that is, a VFS operation.  The VFS operation is written out using 
+ * that is, a VFS operation.  The VFS operation is written out using
  * sub-records and may contain multiple, possibly nested sub-transactions.
  * multiple sub-transactions occur when a VFS operation cannot be represented
- * by a single command.  This is typically the case when a journal is 
+ * by a single command.  This is typically the case when a journal is
  * configured to be reversable because UNDO sequences almost always have to
  * be specified in such cases.  For example, if you ftruncate() a file the
  * journal might have to write out a sequence of WRITE records representing
@@ -198,7 +199,7 @@ struct journal_ackrecord {
  * If this case occurs a scanner can determine that the recursion has ended
  * by detecting a nested subrecord with the JMASK_LAST bit set.  A scanner
  * may also set the field to the proper value after the fact to make later
- * operations more efficient. 
+ * operations more efficient.
  *
  * Note that this bit must be properly set even if the recsize field is
  * non-zero.  The recsize must always be properly specified for 'leaf'
@@ -213,7 +214,7 @@ struct journal_ackrecord {
  * hundreds of megabytes of data (e.g. if a program were to do a
  * multi-megabyte write()) and be split up across thousands of raw streaming
  * records, possibly interlaced with other unrelated streams from other
- * unrelated processes.  
+ * unrelated processes.
  *
  * If a large sub-transaction is aborted the logical stream may be
  * terminated without writing out all the expected data.  When this occurs
@@ -221,12 +222,12 @@ struct journal_ackrecord {
  * set.  However, scanners should still be robust enough to detect such
  * overflows even if the aborted bit is not set and consider them data
  * corruption.
- * 
+ *
  * Aborts may also occur in the normal course of operations, especially once
  * the journaling API is integrated into the cache coherency API.  A normal
  * abort is issued by emplacing a JLEAF_ABORT record within the transaction
  * being aborted.  Such records must be the last record in the sub-transaction,
- * so JLEAF_LAST is also usually set.  In a transaction with many 
+ * so JLEAF_LAST is also usually set.  In a transaction with many
  * sub-transactions only those sub-transactions with an abort record are
  * aborted, the rest remain valid.  Abort records are considered S.O.P. for
  * two reasons:  First, limited memory buffer space may make it impossible
diff --git a/sys/sys/kinfo.h b/sys/sys/kinfo.h
index 98b6b24b8a..bf5d5f43d5 100644
--- a/sys/sys/kinfo.h
+++ b/sys/sys/kinfo.h
@@ -1,13 +1,13 @@
 /*
  * Copyright (c) 2004 The DragonFly Project.  All rights reserved.
- * 
+ *
  * This code is derived from software contributed to The DragonFly Project
  * by Joerg Sonnenberger <joerg@bec.de>.
- * 
+ *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
- * 
+ *
  * 1. Redistributions of source code must retain the above copyright
  *    notice, this list of conditions and the following disclaimer.
  * 2. Redistributions in binary form must reproduce the above copyright
@@ -17,7 +17,7 @@
  * 3. Neither the name of The DragonFly Project nor the names of its
  *    contributors may be used to endorse or promote products derived
  *    from this software without specific, prior written permission.
- * 
+ *
  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
@@ -35,19 +35,38 @@
 #ifndef _SYS_KINFO_H_
 #define _SYS_KINFO_H_
 
-#ifndef _KERNEL_STRUCTURES
-#define _KERNEL_STRUCTURES
-#endif
-
-#ifndef _SYS_TYPES_H_
-#include <sys/types.h>
-#endif
 #ifndef _SYS_PARAM_H_
 #include <sys/param.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 #include <sys/resource.h>
 #include <sys/rtprio.h>
+#ifdef _KERNEL
 #include <sys/proc.h>
+#endif
+
+/*
+ * NOTE: correct way to use this header from non kernel code is to include
+ * the <sys/user.h> first!  Following helper is for historic reasons only.
+ */
+#ifndef _STRUCT_PROC_ENUMS_DECLARED
+#define _STRUCT_PROC_ENUMS_DECLARED
+enum lwpstat {
+	LSRUN = 1,
+	LSSTOP = 2,
+	LSSLEEP = 3,
+};
+
+enum procstat {
+	SIDL = 1,
+	SACTIVE = 2,
+	SSTOP = 3,
+	SZOMB = 4,
+	SCORE = 5,
+};
+#endif	/* !_STRUCT_PROC_ENUMS_DECLARED */
 
 struct kinfo_file {
 	size_t	 f_size;	/* size of struct kinfo_file */
@@ -177,12 +196,13 @@ struct kinfo_proc {
 	gid_t		kp_rgid;
 	gid_t		kp_svgid;
 
-	pid_t		kp_pid;	/* process id */
+	pid_t		kp_pid;		/* process id */
 	pid_t		kp_ppid;	/* parent process id */
 	pid_t		kp_pgid;	/* process group id */
 	int		kp_jobc;	/* job control counter */
-	pid_t		kp_sid;	/* session id */
-	char		kp_login[roundup(MAXLOGNAME, sizeof(long))];	/* setlogin() name */
+	pid_t		kp_sid;		/* session id */
+	char		kp_login[roundup(MAXLOGNAME, sizeof(long))];
+					/* setlogin() name */
 	dev_t		kp_tdev;	/* controlling tty dev */
 	pid_t		kp_tpgid;	/* tty process group id */
 	pid_t		kp_tsid;	/* tty session id */
@@ -192,13 +212,13 @@ struct kinfo_proc {
 	int		kp_nice;
 	unsigned int	kp_swtime;
 
-	vm_size_t	kp_vm_map_size;	/* vmmap virtual size in bytes */
+	size_t		kp_vm_map_size;		/* vmmap virtual size in bytes */
 	segsz_t		kp_vm_rssize;		/* resident set size in pages */
 	segsz_t		kp_vm_swrss;		/* rss before last swap in pages */
 	segsz_t		kp_vm_tsize;		/* text size in pages */
 	segsz_t		kp_vm_dsize;		/* data size in pages */
 	segsz_t		kp_vm_ssize;		/* stack size in pages */
-        u_int		kp_vm_prssize;		/* proportional rss in pages */
+	u_int		kp_vm_prssize;		/* proportional rss in pages */
 
 	int		kp_jailid;
 
@@ -216,7 +236,7 @@ struct kinfo_proc {
 };
 
 /*
- * KERN_SIGTRAMP
+ * KERN_SIGTRAMP, public, KERN_PROC_SIGTRAMP used in external codes
  */
 struct kinfo_sigtramp {
 	void		*ksigtramp_start;
@@ -224,23 +244,21 @@ struct kinfo_sigtramp {
 	void		*ksigtramp_spare[4];
 };
 
+#if defined(_KERNEL) || defined(_KERNEL_STRUCTURES)
 struct proc;
 struct lwp;
 struct thread;
 
+__BEGIN_DECLS
 void fill_kinfo_proc(struct proc *, struct kinfo_proc *);
 void fill_kinfo_lwp(struct lwp *, struct kinfo_lwp *);
 void fill_kinfo_proc_kthread(struct thread *, struct kinfo_proc *);
+__END_DECLS
+#endif	/* defined(_KERNEL) || defined(_KERNEL_STRUCTURES) */
 
-#define KINFO_NEXT(kp)	((union kinfo *)((uintptr_t)kp + kp->gen.len))
-#define KINFO_END(kp)	(kp->gen.type == KINFO_TYPE_END)
-
-#if defined(_KERNEL)
+#ifdef _KERNEL
 #define cpu_time	cputime_percpu[mycpuid]
-#endif
-
-#if defined(_KERNEL)
 extern struct kinfo_cputime cputime_percpu[MAXCPU];
-#endif
+#endif	/* _KERNEL */
 
-#endif /* !_SYS_KINFO_H_ */
+#endif	/* !_SYS_KINFO_H_ */
diff --git a/sys/sys/ktr.h b/sys/sys/ktr.h
index 076a9f0f20..f9ccdba89c 100644
--- a/sys/sys/ktr.h
+++ b/sys/sys/ktr.h
@@ -1,13 +1,13 @@
 /*
  * Copyright (c) 2005 The DragonFly Project.  All rights reserved.
- * 
+ *
  * This code is derived from software contributed to The DragonFly Project
  * by Matthew Dillon <dillon@backplane.com>
- * 
+ *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
- * 
+ *
  * 1. Redistributions of source code must retain the above copyright
  *    notice, this list of conditions and the following disclaimer.
  * 2. Redistributions in binary form must reproduce the above copyright
@@ -17,7 +17,7 @@
  * 3. Neither the name of The DragonFly Project nor the names of its
  *    contributors may be used to endorse or promote products derived
  *    from this software without specific, prior written permission.
- * 
+ *
  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
@@ -32,7 +32,7 @@
  * SUCH DAMAGE.
  */
 /*
- * Generic Kernel trace buffer support.  
+ * Generic Kernel trace buffer support.
  *
  */
 
@@ -40,6 +40,7 @@
 #define	_SYS_KTR_H_
 
 #include <sys/types.h>
+#include <sys/stdint.h>
 #include <sys/sysctl.h>
 #include <sys/cpputil.h>
 
diff --git a/sys/sys/lock.h b/sys/sys/lock.h
index 8f6dabde6d..64cea933a0 100644
--- a/sys/sys/lock.h
+++ b/sys/sys/lock.h
@@ -41,7 +41,7 @@
 
 /*
  * A number of third party programs #include <sys/lock.h> for no good
- * reason.  Don't actually include anything unless we are the kernel. 
+ * reason.  Don't actually include anything unless we are the kernel.
  */
 #if defined(_KERNEL) || defined(_KERNEL_STRUCTURES)
 
@@ -67,7 +67,7 @@ struct thread;
 struct lock {
 	u_int	lk_flags;		/* see below */
 	int	lk_timo;		/* maximum sleep time (for tsleep) */
-	uint64_t lk_count;		/* see LKC_* bits */
+	u_int64_t lk_count;		/* see LKC_* bits */
 	const char *lk_wmesg;		/* resource sleeping (for tsleep) */
 	struct thread *lk_lockholder;	/* thread of excl lock holder */
 };
diff --git a/sys/sys/lwp.h b/sys/sys/lwp.h
index 80b7ee7e2f..5694acdfda 100644
--- a/sys/sys/lwp.h
+++ b/sys/sys/lwp.h
@@ -16,7 +16,7 @@ struct lwp_params {
 
 #if !defined(_KERNEL) || defined(_KERNEL_VIRTUAL)
 
-#include <machine/cpumask.h>
+#include <sys/cpumask.h>
 
 __BEGIN_DECLS
 
diff --git a/sys/sys/mman.h b/sys/sys/mman.h
index c2bacacdd8..f50f9fbe60 100644
--- a/sys/sys/mman.h
+++ b/sys/sys/mman.h
@@ -34,7 +34,7 @@
 #define	_SYS_MMAN_H_
 
 #include <sys/cdefs.h>
-#include <sys/stdint.h>
+#include <machine/stdint.h>
 
 #ifndef _MODE_T_DECLARED
 #define	_MODE_T_DECLARED
diff --git a/sys/sys/mount.h b/sys/sys/mount.h
index 794f68cf75..f1a23bc9c2 100644
--- a/sys/sys/mount.h
+++ b/sys/sys/mount.h
@@ -34,6 +34,7 @@
 #define _SYS_MOUNT_H_
 
 #include <sys/queue.h>
+#include <sys/stdint.h>
 #include <sys/tree.h>
 #include <sys/ucred.h>
 
diff --git a/sys/sys/mountctl.h b/sys/sys/mountctl.h
index dc43b9e72d..b6cc6b56ab 100644
--- a/sys/sys/mountctl.h
+++ b/sys/sys/mountctl.h
@@ -38,6 +38,9 @@
 #ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 #ifndef _SYS_TIME_H_
 #include <sys/time.h>
 #endif
diff --git a/sys/sys/mpt_ioctl.h b/sys/sys/mpt_ioctl.h
index 063fa1b065..2f1723c1f0 100644
--- a/sys/sys/mpt_ioctl.h
+++ b/sys/sys/mpt_ioctl.h
@@ -36,6 +36,7 @@
 #define	_MPT_IOCTL_H_
 
 #include <sys/ioccom.h>
+#include <sys/stdint.h>
 
 #include <dev/disk/mpt/mpilib/mpi_type.h>
 #include <dev/disk/mpt/mpilib/mpi.h>
diff --git a/sys/sys/msg.h b/sys/sys/msg.h
index 7a60b9c76e..4c016af2a7 100644
--- a/sys/sys/msg.h
+++ b/sys/sys/msg.h
@@ -25,6 +25,7 @@
 
 #include <sys/cdefs.h>
 #include <sys/ipc.h>
+#include <machine/stdint.h>
 
 /*
  * The MSG_NOERROR identifier value, the msqid_ds struct and the msg struct
diff --git a/sys/sys/msgport.h b/sys/sys/msgport.h
index 9917555d56..524331c1d2 100644
--- a/sys/sys/msgport.h
+++ b/sys/sys/msgport.h
@@ -10,12 +10,10 @@
 #ifndef _SYS_QUEUE_H_
 #include <sys/queue.h>		/* TAILQ_* macros */
 #endif
-#ifndef _SYS_STDINT_H_
-#include <sys/stdint.h>
-#endif
 #ifndef _SYS_SPINLOCK_H_
 #include <sys/spinlock.h>
 #endif
+#include <machine/stdint.h>
 
 struct lwkt_msg;
 struct lwkt_port;
diff --git a/sys/sys/mtio.h b/sys/sys/mtio.h
index a704a0db29..77e2095af2 100644
--- a/sys/sys/mtio.h
+++ b/sys/sys/mtio.h
@@ -28,7 +28,6 @@
  *
  *	@(#)mtio.h	8.1 (Berkeley) 6/2/93
  * $FreeBSD: src/sys/sys/mtio.h,v 1.20.2.2 2001/01/22 18:02:47 mjacob Exp $
- * $DragonFly: src/sys/sys/mtio.h,v 1.4 2006/05/20 02:42:13 dillon Exp $
  */
 
 #ifndef	_SYS_MTIO_H_
@@ -37,6 +36,9 @@
 #ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 #ifndef _SYS_IOCCOM_H_
 #include <sys/ioccom.h>
 #endif
@@ -173,7 +175,7 @@ struct scsi_tape_errors {
 		u_int64_t nbytes;	/* total # bytes processed */
 	} wterr, rderr;
 };
-	
+
 union mterrstat {
 	struct scsi_tape_errors scsi_errstat;
 	char _reserved_padding[256];
diff --git a/sys/sys/pciio.h b/sys/sys/pciio.h
index 1667c69b7d..128604263e 100644
--- a/sys/sys/pciio.h
+++ b/sys/sys/pciio.h
@@ -25,7 +25,6 @@
  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  *
  *	$FreeBSD: src/sys/sys/pciio.h,v 1.5 1999/12/08 17:44:04 ken Exp $
- *	$DragonFly: src/sys/sys/pciio.h,v 1.3 2006/05/20 02:42:13 dillon Exp $
  *
  */
 
@@ -35,6 +34,9 @@
 #ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 #ifndef _SYS_IOCCOM_H_
 #include <sys/ioccom.h>
 #endif
@@ -72,10 +74,10 @@ struct	pci_conf {
 	struct pcisel	pc_sel;		/* bus+slot+function */
 	u_int8_t	pc_hdr;		/* PCI header type */
 	u_int16_t	pc_subvendor;	/* card vendor ID */
-	u_int16_t	pc_subdevice;	/* card device ID, assigned by 
+	u_int16_t	pc_subdevice;	/* card device ID, assigned by
 					   card vendor */
 	u_int16_t	pc_vendor;	/* chip vendor ID */
-	u_int16_t	pc_device;	/* chip device ID, assigned by 
+	u_int16_t	pc_device;	/* chip device ID, assigned by
 					   chip vendor */
 	u_int8_t	pc_class;	/* chip PCI class */
 	u_int8_t	pc_subclass;	/* chip PCI subclass */
diff --git a/sys/sys/proc.h b/sys/sys/proc.h
index 69e550df72..04f5b7c423 100644
--- a/sys/sys/proc.h
+++ b/sys/sys/proc.h
@@ -41,6 +41,7 @@
 #else
 
 #include <sys/callout.h>		/* For struct callout. */
+#include <sys/cpumask.h>
 #include <sys/filedesc.h>
 #include <sys/queue.h>
 #include <sys/tree.h>
@@ -151,6 +152,9 @@ struct vmspace_entry;
 struct ktrace_node;
 struct sem_undo;
 
+/* Also declared in sys/kinfo.h */
+#ifndef _STRUCT_PROC_ENUMS_DECLARED
+#define _STRUCT_PROC_ENUMS_DECLARED
 enum lwpstat {
 	LSRUN = 1,
 	LSSTOP = 2,
@@ -164,6 +168,7 @@ enum procstat {
 	SZOMB = 4,
 	SCORE = 5,
 };
+#endif	/* !_STRUCT_PROC_ENUMS_DECLARED */
 
 struct lwp {
 	TAILQ_ENTRY(lwp) lwp_procq;	/* run/sleep queue. */
diff --git a/sys/sys/procctl.h b/sys/sys/procctl.h
index f13629649a..94c7d28dd4 100644
--- a/sys/sys/procctl.h
+++ b/sys/sys/procctl.h
@@ -39,6 +39,7 @@
 #include <sys/lock.h>
 #else
 #include <sys/types.h>
+#include <sys/stdint.h>
 #endif
 
 #ifndef _IDTYPE_T_DECLARED
diff --git a/sys/sys/resident.h b/sys/sys/resident.h
index 5b79bcca48..d487c07647 100644
--- a/sys/sys/resident.h
+++ b/sys/sys/resident.h
@@ -2,22 +2,20 @@
  * SYS/RESIDENT.H
  *
  *	Userland system calls for resident executable support.
- *
- * $DragonFly: src/sys/sys/resident.h,v 1.4 2006/05/20 02:42:13 dillon Exp $
  */
 
 #ifndef _SYS_RESIDENT_H_
 #define _SYS_RESIDENT_H_
 
-#ifndef _SYS_TYPES_H_
-#include <sys/types.h>
-#endif
 #ifndef _SYS_PARAM_H_
 #include <sys/param.h>
 #endif
 #ifndef _SYS_STAT_H_
 #include <sys/stat.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 
 #if !defined(_KERNEL)
 
diff --git a/sys/sys/rman.h b/sys/sys/rman.h
index 184c8c1bf8..b9f1b89fad 100644
--- a/sys/sys/rman.h
+++ b/sys/sys/rman.h
@@ -12,7 +12,7 @@
  * no representations about the suitability of this software for any
  * purpose.  It is provided "as is" without express or implied
  * warranty.
- * 
+ *
  * THIS SOFTWARE IS PROVIDED BY M.I.T. ``AS IS''.  M.I.T. DISCLAIMS
  * ALL EXPRESS OR IMPLIED WARRANTIES WITH REGARD TO THIS SOFTWARE,
  * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
@@ -35,6 +35,9 @@
 #ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 #ifndef _SYS_QUEUE_H_
 #include <sys/queue.h>
 #endif
diff --git a/sys/sys/sched.h b/sys/sys/sched.h
index 3f3e3b901f..38566d3203 100644
--- a/sys/sys/sched.h
+++ b/sys/sys/sched.h
@@ -56,55 +56,13 @@ struct sched_param
 #include <time.h>		/* Per P1003.4 */
 
 #if __BSD_VISIBLE
-#include <machine/cpumask.h>
+#include <sys/cpumask.h>
 
+#ifndef _CPU_SET_T_DECLARED
+#define	_CPU_SET_T_DECLARED
 typedef	cpumask_t		cpu_set_t;
 typedef	cpumask_t		cpuset_t;	/* FreeBSD compat */
-
-#define	CPU_SETSIZE		((int)(sizeof(cpumask_t) * 8))
-
-#define	CPU_ZERO(set)		CPUMASK_ASSZERO(*set)
-#define	CPU_SET(cpu, set)	CPUMASK_ORBIT(*set, cpu)
-#define	CPU_CLR(cpu, set)	CPUMASK_NANDBIT(*set, cpu)
-#define	CPU_ISSET(cpu, set)	CPUMASK_TESTBIT(*set, cpu)
-
-#define	CPU_COUNT(set)				\
-	(__builtin_popcountl((set)->ary[0]) +	\
-	 __builtin_popcountl((set)->ary[1]) +	\
-	 __builtin_popcountl((set)->ary[2]) +	\
-	 __builtin_popcountl((set)->ary[3]))
-
-#define	CPU_AND(dst, set1, set2)		\
-do {						\
-	if (dst == set1) {			\
-		CPUMASK_ANDMASK(*dst, *set2);	\
-	} else {				\
-		*dst = *set2;			\
-		CPUMASK_ANDMASK(*dst, *set1);	\
-	}					\
-} while (0)
-
-#define	CPU_OR(dst, set1, set2)			\
-do {						\
-	if (dst == set1) {			\
-		CPUMASK_ORMASK(*dst, *set2);	\
-	} else {				\
-		*dst = *set2;			\
-		CPUMASK_ORMASK(*dst, *set1);	\
-	}					\
-} while (0)
-
-#define	CPU_XOR(dst, set1, set2)		\
-do {						\
-	if (dst == set1) {			\
-		CPUMASK_XORMASK(*dst, *set2);	\
-	} else {				\
-		*dst = *set2;			\
-		CPUMASK_XORMASK(*dst, *set1);	\
-	}					\
-} while (0)
-
-#define	CPU_EQUAL(set1, set2)	CPUMASK_CMPMASKEQ(*set1, *set2)
+#endif
 #endif /* __BSD_VISIBLE */
 
 __BEGIN_DECLS
@@ -127,6 +85,6 @@ int sched_getcpu(void);
 #endif
 __END_DECLS
 
-#endif
+#endif /* !_KERNEL */
 
 #endif /* _SCHED_H_ */
diff --git a/sys/sys/sem.h b/sys/sys/sem.h
index e228cdd901..3b84428f40 100644
--- a/sys/sys/sem.h
+++ b/sys/sys/sem.h
@@ -12,6 +12,7 @@
 
 #include <sys/cdefs.h>
 #include <sys/ipc.h>
+#include <machine/stdint.h>
 
 #ifndef _PID_T_DECLARED
 typedef	__pid_t		pid_t;
@@ -74,7 +75,7 @@ struct sembuf {
 union semun {
 	int	val;		/* value for SETVAL */
 	struct	semid_ds *buf;	/* buffer for IPC_STAT & IPC_SET */
-	u_short	*array;		/* array for GETALL & SETALL */
+	unsigned short	*array;	/* array for GETALL & SETALL */
 };
 #endif /* __BSD_VISIBLE */
 
diff --git a/sys/sys/sensors.h b/sys/sys/sensors.h
index 6e76d30bba..ec3bfc1d38 100644
--- a/sys/sys/sensors.h
+++ b/sys/sys/sensors.h
@@ -1,5 +1,4 @@
 /* $OpenBSD: sensors.h,v 1.23 2007/03/22 16:55:31 deraadt Exp $ */
-/* $DragonFly: src/sys/sys/sensors.h,v 1.1 2007/10/02 12:57:01 hasso Exp $ */
 
 /*
  * Copyright (c) 2003, 2004 Alexander Yurchenko <grange@openbsd.org>
@@ -30,6 +29,9 @@
 #ifndef _SYS_SENSORS_H_
 #define _SYS_SENSORS_H_
 
+#include <sys/stdint.h>
+#include <sys/_timeval.h>
+
 #define SENSORS_DEBUG
 
 /* Sensor types */
diff --git a/sys/sys/sglist.h b/sys/sys/sglist.h
index ee5b894e8b..2f0e32bde2 100644
--- a/sys/sys/sglist.h
+++ b/sys/sys/sglist.h
@@ -39,6 +39,10 @@
 #ifndef __SGLIST_H__
 #define	__SGLIST_H__
 
+#ifndef _KERNEL
+#error "This file should not be included by userland programs."
+#endif
+
 #include <sys/refcount.h>
 
 struct sglist_seg {
diff --git a/sys/sys/shm.h b/sys/sys/shm.h
index d65135a031..fd8ab47af9 100644
--- a/sys/sys/shm.h
+++ b/sys/sys/shm.h
@@ -41,6 +41,7 @@
 
 #include <sys/cdefs.h>
 #include <sys/ipc.h>
+#include <machine/stdint.h>
 
 #define	SHM_RDONLY  010000  /* Attach read-only (else read-write) */
 #define	SHM_RND     020000  /* Round attach address to SHMLBA */
diff --git a/sys/sys/signal.h b/sys/sys/signal.h
index 2c04ef1cc8..098b6bce76 100644
--- a/sys/sys/signal.h
+++ b/sys/sys/signal.h
@@ -41,7 +41,7 @@
 #include <sys/cdefs.h>
 #include <sys/_pthreadtypes.h>
 #include <sys/_sigset.h>
-#include <sys/stdint.h>		/* for __ types */
+#include <machine/stdint.h>
 
 #ifndef _PID_T_DECLARED
 typedef	__pid_t		pid_t;
diff --git a/sys/sys/slaballoc.h b/sys/sys/slaballoc.h
index 21e771e85b..d778ea885e 100644
--- a/sys/sys/slaballoc.h
+++ b/sys/sys/slaballoc.h
@@ -39,12 +39,10 @@
 
 #if defined(_KERNEL) || defined(_KERNEL_STRUCTURES)
 
-#ifndef _SYS_STDINT_H_
-#include <sys/stdint.h>
-#endif
 #ifndef _SYS__MALLOC_H_
 #include <sys/_malloc.h>
 #endif
+#include <machine/stdint.h>
 
 /*
  * Note that any allocations which are exact multiples of PAGE_SIZE, or
diff --git a/sys/sys/stat.h b/sys/sys/stat.h
index c6db2fc66f..44958bc8e1 100644
--- a/sys/sys/stat.h
+++ b/sys/sys/stat.h
@@ -39,21 +39,146 @@
 #define	_SYS_STAT_H_
 
 #include <sys/cdefs.h>
-#include <sys/types.h>
+#include <machine/stdint.h>
+
+#ifdef _KERNEL
+#ifndef _UDEV_T_DECLARED
+typedef	__uint32_t	udev_t;		/* device number */
+#define	_UDEV_T_DECLARED
+#endif
+#endif
+
+#if __XSI_VISIBLE
+#ifndef _BLKCNT_T_DECLARED
+typedef	__int64_t	blkcnt_t;	/* file block count */
+#define	_BLKCNT_T_DECLARED
+#endif
+
+#ifndef _BLKSIEZE_T_DECLARED
+typedef	__int64_t	blksize_t;	/* block size */
+#define	_BLKSIEZE_T_DECLARED
+#endif
+#endif /* __XSI_VISIBLE */
+
+#if __POSIX_VISIBLE >= 200112 || __XSI_VISIBLE
+
+#if !defined(_KERNEL) || defined(_KERNEL_VIRTUAL)
+#ifndef _DEV_T_DECLARED
+typedef	__uint32_t	dev_t;		/* device number */
+#define	_DEV_T_DECLARED
+#endif
+#endif
+
+#ifndef _GID_T_DECLARED
+typedef	__uint32_t	gid_t;		/* group id */
+#define	_GID_T_DECLARED
+#endif
+
+#ifndef _INO_T_DECLARED
+typedef	__uint64_t	ino_t;		/* inode number */
+#define	_INO_T_DECLARED
+#endif
+
+#ifndef _MODE_T_DECLARED
+typedef	__uint16_t	mode_t;		/* permissions */
+#define	_MODE_T_DECLARED
+#endif
+
+#ifndef _NLINK_T_DECLARED
+typedef	__uint32_t	nlink_t;	/* link count */
+#define	_NLINK_T_DECLARED
+#endif
+
+#ifndef _OFF_T_DECLARED
+typedef	__off_t		off_t;		/* file offset */
+#define	_OFF_T_DECLARED
+#endif
+
+#ifndef _UID_T_DECLARED
+typedef	__uint32_t	uid_t;		/* user id */
+#define	_UID_T_DECLARED
+#endif
+
+#ifndef _TIME_T_DECLARED
+typedef	__time_t	time_t;
+#define	_TIME_T_DECLARED
+#endif
+
+#endif /* __POSIX_VISIBLE >= 200112 || __XSI_VISIBLE */
+
+#if __POSIX_VISIBLE >= 200809 || __XSI_VISIBLE >= 700
+#include <sys/_timespec.h>
+#define	st_atime	st_atim.tv_sec
+#define	st_mtime	st_mtim.tv_sec
+#define	st_ctime	st_ctim.tv_sec
+#define	__tsP_ST(name)	struct timespec name
+#else
+#define	st_atime	__sec_st_atim
+#define	st_mtime	__sec_st_mtim
+#define	st_ctime	__sec_st_ctim
+#define	__tsP_ST(name)	__time_t __sec_##name; long __nsec_##name
+#endif /* !(__POSIX_VISIBLE >= 200809 || __XSI_VISIBLE >= 700) */
 
 #if !defined(_KERNEL) && __BSD_VISIBLE
 /*
  * XXX We get miscellaneous namespace pollution with this.
  */
 #include <sys/time.h>
+#endif
+
+#if __BSD_VISIBLE
+#define __meB_ST(type, name)	type name
 #else
-#include <sys/_timespec.h>
+#define __meB_ST(type, name)	type __##name
 #endif
 
-#ifdef _KERNEL
-#define	__dev_t	udev_t
+#if defined(_UDEV_T_DECLARED) && defined(_KERNEL)
+#define	__dev_st	udev_t
+#elif defined(_DEV_T_DECLARED)
+#define	__dev_st	dev_t
 #else
-#define	__dev_t	dev_t
+#define	__dev_st	__uint32_t
+#endif
+
+#if defined(_BLKCNT_T_DECLARED)
+#define	__blkc_st	blkcnt_t
+#else
+#define	__blkc_st	__int64_t
+#endif
+#if defined(_BLKSIEZE_T_DECLARED)
+#define	__blks_st	blksize_t
+#else
+#define	__blks_st	__int64_t
+#endif
+#if defined(_GID_T_DECLARED)
+#define	__gid_st	gid_t
+#else
+#define	__gid_st	__uint32_t
+#endif
+#if defined(_INO_T_DECLARED)
+#define	__ino_st	ino_t
+#else
+#define	__ino_st	__uint64_t
+#endif
+#if defined(_NLINK_T_DECLARED)
+#define	__nlink_st	nlink_t
+#else
+#define	__nlink_st	__uint32_t
+#endif
+#if defined(_MODE_T_DECLARED)
+#define	__mode_st	mode_t
+#else
+#define	__mode_st	__uint16_t
+#endif
+#if defined(_OFF_T_DECLARED)
+#define	__off_st	off_t
+#else
+#define	__off_st	__off_t
+#endif
+#if defined(_UID_T_DECLARED)
+#define	__uid_st	uid_t
+#else
+#define	__uid_st	__uint32_t
 #endif
 
 /*
@@ -62,36 +187,42 @@
  * NOTE: st_fsmid removed in DragonFly 2.5.x.
  */
 struct stat {
-	ino_t	  st_ino;		/* inode's number */
-	nlink_t	  st_nlink;		/* number of hard links */
-	__dev_t	  st_dev;		/* inode's device */
-	mode_t	  st_mode;		/* inode protection mode */
-	uint16_t  st_padding1;
-	uid_t	  st_uid;		/* user ID of the file's owner */
-	gid_t	  st_gid;		/* group ID of the file's group */
-	__dev_t	  st_rdev;		/* device type */
-	struct	timespec st_atim;	/* time of last access */
-	struct	timespec st_mtim;	/* time of last data modification */
-	struct	timespec st_ctim;	/* time of last file status change */
-	off_t	  st_size;		/* file size, in bytes */
-	blkcnt_t  st_blocks;		/* blocks allocated for file */
-	u_int32_t __old_st_blksize;	/* old ABI compatibility only */
-	u_int32_t st_flags;		/* user defined flags for file */
-	u_int32_t st_gen;		/* file generation number */
-	int32_t	  st_lspare;
-	blksize_t st_blksize;		/* optimal blocksize for I/O */
-	int64_t	  st_qspare2;
+	__ino_st	st_ino;		/* inode's number */
+	__nlink_st	st_nlink;	/* number of hard links */
+	__dev_st	st_dev;		/* inode's device */
+	__mode_st	st_mode;	/* inode protection mode */
+	__uint16_t	__st_padding1;
+	__uid_st	st_uid;		/* user ID of the file's owner */
+	__gid_st	st_gid;		/* group ID of the file's group */
+	__dev_st	st_rdev;	/* device type */
+	__tsP_ST(st_atim);		/* time of last access */
+	__tsP_ST(st_mtim);		/* time of last data modification */
+	__tsP_ST(st_ctim);		/* time of last file status change */
+	__off_st	st_size;	/* file size, in bytes */
+	__blkc_st	st_blocks;	/* blocks allocated for file */
+	__uint32_t	__old_st_blksize; /* old ABI compatibility only */
+	__meB_ST(__uint32_t, st_flags);	/* user defined flags for file */
+	__meB_ST(__uint32_t, st_gen);	/* file generation number */
+	__meB_ST(__int32_t, st_lspare);
+	__blks_st	st_blksize;	/* optimal blocksize for I/O */
+	__meB_ST(__int64_t, st_qspare2);
 };
 
+#undef __dev_st
+#undef __blkc_st
+#undef __blks_st
+#undef __gid_st
+#undef __ino_st
+#undef __nlink_st
+/* #undef __mode_st needed for protos */
+#undef __off_st
+#undef __uid_st
+#undef __meB_ST
+#undef __tsP_ST
+
 /*#define _ST_FSMID_PRESENT_*/
 #define	_ST_FLAGS_PRESENT_
 
-#undef __dev_t
-
-#define	st_atime st_atim.tv_sec
-#define	st_mtime st_mtim.tv_sec
-#define	st_ctime st_ctim.tv_sec
-
 /* BSD compatibility */
 #if __BSD_VISIBLE
 #define	st_atimespec st_atim
@@ -251,8 +382,8 @@ struct stat {
 #if !defined(_KERNEL) || defined(_KERNEL_VIRTUAL)
 
 __BEGIN_DECLS
-int	chmod(const char *, mode_t);
-int	fchmod(int, mode_t);
+int	chmod(const char *, __mode_st);
+int	fchmod(int, __mode_st);
 #if __POSIX_VISIBLE >= 200809
 int	fchmodat(int, const char *, mode_t, int);
 int	futimens(int, const struct timespec *);
@@ -262,14 +393,14 @@ int	fstat(int, struct stat *);
 #if __POSIX_VISIBLE >= 199506
 int	lstat(const char * __restrict, struct stat * __restrict);
 #endif
-int	mkdir(const char *, mode_t);
-int	mkfifo(const char *, mode_t);
+int	mkdir(const char *, __mode_st);
+int	mkfifo(const char *, __mode_st);
 #if !defined(_MKNOD_DECLARED) && __XSI_VISIBLE
 int	mknod(const char *, mode_t, dev_t);
 #define	_MKNOD_DECLARED
 #endif
 int	stat(const char * __restrict, struct stat * __restrict);
-mode_t	umask(mode_t);
+__mode_st umask(__mode_st);
 #if __POSIX_VISIBLE >= 200809
 int	fstatat(int, const char * __restrict, struct stat * __restrict, int);
 int	mkdirat(int, const char *, mode_t);
@@ -287,6 +418,8 @@ int	lchmod(const char *, mode_t);
 #endif
 __END_DECLS
 
-#endif
+#endif /* !_KERNEL || _KERNEL_VIRTUAL */
+
+#undef __mode_st
 
 #endif /* !_SYS_STAT_H_ */
diff --git a/sys/sys/stdint.h b/sys/sys/stdint.h
index fc8f198fe7..400d7d34a8 100644
--- a/sys/sys/stdint.h
+++ b/sys/sys/stdint.h
@@ -1,16 +1,88 @@
 /*
- * This file is in the public domain.
- * $FreeBSD: src/sys/sys/inttypes.h,v 1.2 1999/08/28 00:51:47 peter Exp $
+ * Copyright (c) 2019 The DragonFly Project.  All rights reserved.
  *
- * Note: since portions of these header files can be included with various
- * other combinations of defines, we cannot surround the whole header file
- * with an #ifndef sequence.  Elements are individually protected.
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ * 2. Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in the
+ *    documentation and/or other materials provided with the distribution.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
+ * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
+ * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
+ * FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE
+ * COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
+ * INCIDENTAL, SPECIAL, EXEMPLARY OR CONSEQUENTIAL DAMAGES (INCLUDING,
+ * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED
+ * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
+ * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
+ * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
+ * SUCH DAMAGE.
  */
 
 #ifndef _SYS_STDINT_H_
-#define _SYS_STDINT_H_
+#define	_SYS_STDINT_H_
 
 #include <sys/cdefs.h>
 #include <machine/stdint.h>
 
-#endif	/* SYS_STDINT_H */
+/*
+ * Proxy header for kernel compilation.  Do not include outside kernel
+ * headers. Userland should use <stdint.h> instead.
+ *
+ * This header is not a convenient placeholder for non integer types.
+ */
+
+#ifdef _KERNEL
+#include <machine/int_limits.h>
+
+typedef	__boolean_t	boolean_t;		/* kernel only */
+
+#if !defined(__bool_true_false_are_defined) && !defined(__cplusplus)
+#define	__bool_true_false_are_defined	1
+#define	false	0
+#define	true	1
+#if __STDC_VERSION__ < 199901L && __GNUC__ < 3
+typedef	int	_Bool;
+#endif
+typedef	_Bool	bool;
+#endif /* !__bool_true_false_are_defined && !__cplusplus */
+
+#define	offsetof(type, field)	__offsetof(type, field)
+
+#ifndef _PTRDIFF_T_DECLARED
+typedef	__ptrdiff_t	ptrdiff_t;	/* ptr1 - ptr2 for kernel */
+#define	_PTRDIFF_T_DECLARED
+#endif
+
+typedef	__int8_t	int8_t;
+typedef	__int16_t	int16_t;
+typedef	__int32_t	int32_t;
+typedef	__int64_t	int64_t;
+
+typedef	__uint8_t	uint8_t;
+typedef	__uint16_t	uint16_t;
+typedef	__uint32_t	uint32_t;
+typedef	__uint64_t	uint64_t;
+
+#ifndef _INTPTR_T_DECLARED
+typedef	__intptr_t	intptr_t;	/* VKERNEL uses <unistd.h> */
+#define	_INTPTR_T_DECLARED
+#endif
+typedef	__uintptr_t	uintptr_t;
+
+typedef	__intmax_t	intmax_t;
+typedef	__uintmax_t	uintmax_t;
+#endif /* _KERNEL */
+
+#ifndef _KERNEL
+#ifndef _STDINT_H_
+#include <stdint.h>			/* in case we still need it */
+#endif
+#endif /* !_KERNEL */
+
+#endif /* SYS_STDINT_H */
diff --git a/sys/sys/sysproto.h b/sys/sys/sysproto.h
index 01e8ff65cd..5d2ccac780 100644
--- a/sys/sys/sysproto.h
+++ b/sys/sys/sysproto.h
@@ -11,6 +11,7 @@
 #include <sys/select.h>
 #include <sys/signal.h>
 #include <sys/acl.h>
+#include <sys/cpumask.h>
 #include <sys/mqueue.h>
 #include <sys/msgport.h>
 #include <sys/sysmsg.h>
diff --git a/sys/sys/systimer.h b/sys/sys/systimer.h
index a8d830120e..b7f909801b 100644
--- a/sys/sys/systimer.h
+++ b/sys/sys/systimer.h
@@ -1,15 +1,15 @@
 /*
  * SYS/SYSTIMER.H
- * 
+ *
  * Copyright (c) 2003,2004 The DragonFly Project.  All rights reserved.
- * 
+ *
  * This code is derived from software contributed to The DragonFly Project
  * by Matthew Dillon <dillon@backplane.com>
- * 
+ *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
- * 
+ *
  * 1. Redistributions of source code must retain the above copyright
  *    notice, this list of conditions and the following disclaimer.
  * 2. Redistributions in binary form must reproduce the above copyright
@@ -19,7 +19,7 @@
  * 3. Neither the name of The DragonFly Project nor the names of its
  *    contributors may be used to endorse or promote products derived
  *    from this software without specific, prior written permission.
- * 
+ *
  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
@@ -32,8 +32,6 @@
  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
  * SUCH DAMAGE.
- * 
- * $DragonFly: src/sys/sys/systimer.h,v 1.13 2007/04/30 06:57:36 dillon Exp $
  */
 
 #ifndef _SYS_SYSTIMER_H_
@@ -48,16 +46,10 @@
 #include <sys/queue.h>
 #endif
 
-/* XXX fix sys/kinfo.h */
-#ifndef __BOOLEAN_T_DEFINED__
-#define __BOOLEAN_T_DEFINED__
-typedef	__boolean_t	boolean_t;
-#endif
-
 struct intrframe;
 
 typedef __uint32_t	sysclock_t;
-typedef int32_t		ssysclock_t;
+typedef __int32_t	ssysclock_t;
 typedef TAILQ_HEAD(systimerq, systimer) *systimerq_t;
 typedef void (*systimer_func_t)(struct systimer *, int, struct intrframe *);
 
@@ -81,6 +73,7 @@ typedef struct systimer {
 #define SYSTF_100KHZSYNC	0x0010		/* 100Khz coincident sync */
 #define SYSTF_FIRST		0x0020		/* order first if coincident */
 
+#ifdef _KERNEL
 void systimer_intr_enable(void);
 void systimer_intr(sysclock_t *, int, struct intrframe *);
 void systimer_add(systimer_t);
@@ -95,7 +88,7 @@ void systimer_adjust_periodic(systimer_t, int);
 void systimer_init_oneshot(systimer_t, systimer_func_t, void *, int);
 
 /*
- * The cputimer interface.  This provides a free-running (non-interrupt) 
+ * The cputimer interface.  This provides a free-running (non-interrupt)
  * and monotonically increasing timebase for the system.
  *
  * The cputimer structure holds the fixed cputimer frequency, determining
@@ -315,6 +308,7 @@ struct cpucounter {
 void cpucounter_register(struct cpucounter *);
 const struct cpucounter *cpucounter_find_pcpu(void);
 const struct cpucounter *cpucounter_find(void);
+#endif	/* _KERNEL */
 
 #endif	/* _KERNEL || _KERNEL_STRUCTURES */
 
diff --git a/sys/sys/thread.h b/sys/sys/thread.h
index b60502843b..7e12aba66b 100644
--- a/sys/sys/thread.h
+++ b/sys/sys/thread.h
@@ -1,7 +1,7 @@
 /*
  * SYS/THREAD.H
  *
- *	Implements the architecture independant portion of the LWKT 
+ *	Implements the architecture independant portion of the LWKT
  *	subsystem.
  *
  * Types which must already be defined when this header is included by
@@ -11,9 +11,6 @@
 #ifndef _SYS_THREAD_H_
 #define _SYS_THREAD_H_
 
-#ifndef _SYS_STDINT_H_
-#include <sys/stdint.h>		/* __int types */
-#endif
 #ifndef _SYS_PARAM_H_
 #include <sys/param.h>		/* MAXCOMLEN */
 #endif
@@ -26,6 +23,9 @@
 #ifndef _SYS_TIME_H_
 #include <sys/time.h>   	/* struct timeval */
 #endif
+#ifndef _SYS_CPUMASK_H_
+#include <sys/cpumask.h>	/* cpumask_t */
+#endif
 #ifndef _SYS_LOCK_H
 #include <sys/lock.h>
 #endif
@@ -36,6 +36,7 @@
 #include <sys/iosched.h>
 #endif
 #include <machine/thread.h>
+#include <machine/stdint.h>
 
 struct globaldata;
 struct lwp;
@@ -300,7 +301,7 @@ struct thread {
 #define CRIT_DEBUG_ARRAY_MASK   (CRIT_DEBUG_ARRAY_SIZE - 1)
     const char	*td_crit_debug_array[CRIT_DEBUG_ARRAY_SIZE];
     int		td_crit_debug_index;
-    int		td_in_crit_report;	
+    int		td_in_crit_report;
 #endif
     struct md_thread td_mach;
 #ifdef DEBUG_LOCKS
diff --git a/sys/sys/thread2.h b/sys/sys/thread2.h
index abef300fbc..7a7db68ff6 100644
--- a/sys/sys/thread2.h
+++ b/sys/sys/thread2.h
@@ -1,7 +1,7 @@
 /*
  * SYS/THREAD2.H
  *
- * Implements inline procedure support for the LWKT subsystem. 
+ * Implements inline procedure support for the LWKT subsystem.
  *
  * Generally speaking these routines only operate on threads associated
  * with the current cpu.  For example, a higher priority thread pending
@@ -25,8 +25,10 @@
 #ifndef _SYS_GLOBALDATA_H_
 #include <sys/globaldata.h>
 #endif
+#ifndef _SYS_CPUMASK_H_
+#include <sys/cpumask.h>
+#endif
 #include <machine/cpufunc.h>
-#include <machine/cpumask.h>
 
 /*
  * Don't let GCC reorder critical section count adjustments, because it
@@ -303,7 +305,7 @@ lwkt_cpusync_init(lwkt_cpusync_t cs, cpumask_t mask,
 /*
  * IPIQ messaging wrappers.  IPIQ remote functions are passed three arguments:
  * a void * pointer, an integer, and a pointer to the trap frame (or NULL if
- * the trap frame is not known).  However, we wish to provide opaque 
+ * the trap frame is not known).  However, we wish to provide opaque
  * interfaces for simpler callbacks... the basic IPI messaging function as
  * used by the kernel takes a single argument.
  */
@@ -338,7 +340,7 @@ lwkt_send_ipiq_passive(globaldata_t target, ipifunc1_t func, void *arg)
 }
 
 static __inline int
-lwkt_send_ipiq2_passive(globaldata_t target, ipifunc2_t func, 
+lwkt_send_ipiq2_passive(globaldata_t target, ipifunc2_t func,
 		       void *arg1, int arg2)
 {
     return(lwkt_send_ipiq3_passive(target, (ipifunc3_t)func, arg1, arg2));
diff --git a/sys/sys/types.h b/sys/sys/types.h
index a69e675983..11a5186b91 100644
--- a/sys/sys/types.h
+++ b/sys/sys/types.h
@@ -41,19 +41,8 @@
 #ifndef _SYS_CDEFS_H_
 #include <sys/cdefs.h>
 #endif
-#ifndef _STDINT_H_
-#include <stdint.h>
-#endif
 #include <machine/endian.h>
-#ifndef _MACHINE_TYPES_H_
-#include <machine/types.h>
-#endif
-#ifndef _SYS_STDINT_H_
-#include <sys/stdint.h>
-#endif
-#ifndef _SYS__PTHREADTYPES_H_
-#include <sys/_pthreadtypes.h>
-#endif
+#include <machine/stdint.h>
 
 #if __BSD_VISIBLE
 typedef	unsigned char	u_char;
@@ -65,7 +54,6 @@ typedef	unsigned char	unchar;		/* Sys V compatibility */
 typedef	unsigned short	ushort;		/* Sys V compatibility */
 typedef	unsigned int	uint;		/* Sys V compatibility */
 typedef	unsigned long	ulong;		/* Sys V compatibility */
-#endif
 
 typedef	__uint8_t	u_int8_t;
 typedef	__uint16_t	u_int16_t;
@@ -74,9 +62,16 @@ typedef	__uint64_t	u_int64_t;
 typedef	__uint64_t	u_quad_t;	/* quads */
 typedef	__int64_t	quad_t;
 typedef	quad_t *	qaddr_t;
+#endif /* __BSD_VISIBLE */
 
+#ifndef _BLKCNT_T_DECLARED
 typedef	__int64_t	blkcnt_t;	/* file block count */
+#define	_BLKCNT_T_DECLARED
+#endif
+#ifndef _BLKSIEZE_T_DECLARED
 typedef	__int64_t	blksize_t;	/* block size */
+#define	_BLKSIEZE_T_DECLARED
+#endif
 typedef	char *		caddr_t;	/* core address */
 typedef	const char *	c_caddr_t;	/* core address, pointer to const */
 typedef	volatile char *	v_caddr_t;	/* core address, pointer to volatile */
@@ -107,13 +102,22 @@ typedef	__uint32_t	in_addr_t;	/* base type for internet address */
 typedef	__uint16_t	in_port_t;
 #define	_IN_PORT_T_DECLARED
 #endif
+#ifndef _INO_T_DECLARED
 typedef	__uint64_t	ino_t;		/* inode number */
+#define	_INO_T_DECLARED
+#endif
+#ifndef _KEY_T_DECLARED
 typedef	long		key_t;		/* IPC key (for Sys V IPC) */
+#define	_KEY_T_DECLARED
+#endif
 #ifndef _MODE_T_DECLARED
 typedef	__uint16_t	mode_t;		/* permissions */
 #define	_MODE_T_DECLARED
 #endif
+#ifndef _NLINK_T_DECLARED
 typedef	__uint32_t	nlink_t;	/* link count */
+#define	_NLINK_T_DECLARED
+#endif
 #ifndef _OFF_T_DECLARED
 typedef	__off_t		off_t;		/* file offset */
 #define	_OFF_T_DECLARED
@@ -122,11 +126,16 @@ typedef	__off_t		off_t;		/* file offset */
 typedef	__pid_t		pid_t;		/* process id */
 #define	_PID_T_DECLARED
 #endif
+#if __BSD_VISIBLE
+typedef	__register_t	register_t;	/* register-sized type */
+#endif
 #ifndef _RLIM_T_DECLARED
 typedef	__rlim_t	rlim_t;		/* resource limit */
 #define	_RLIM_T_DECLARED
 #endif
-typedef	__segsz_t	segsz_t;	/* segment size */
+#if __BSD_VISIBLE
+typedef	__bslp_t	segsz_t;	/* segment size */
+#endif
 #ifndef _SUSECONDS_T_DECLARED
 typedef	__suseconds_t	suseconds_t;	/* microseconds (signed) */
 #define	_SUSECONDS_T_DECLARED
@@ -137,61 +146,37 @@ typedef	__uint32_t	uid_t;		/* user id */
 #endif
 typedef	__uint32_t	useconds_t;	/* microseconds (unsigned) */
 
-#if defined(_KERNEL) || defined(_KERNEL_STRUCTURES)
-
-#ifndef __BOOLEAN_T_DEFINED__
-#define	__BOOLEAN_T_DEFINED__
-typedef	__boolean_t	boolean_t;
-#endif
-
-typedef	u_int64_t	uoff_t;
-
-#ifdef _KERNEL
-#if !defined(__bool_true_false_are_defined) && !defined(__cplusplus)
-#define	__bool_true_false_are_defined	1
-#define	false	0
-#define	true	1
-#if __STDC_VERSION__ < 199901L && __GNUC__ < 3
-typedef	int	_Bool;
-#endif
-typedef	_Bool	bool;
-#endif /* !__bool_true_false_are_defined && !__cplusplus */
-#endif /* _KERNEL */
-
-#endif /* _KERNEL || _KERNEL_STRUCTURES */
-
 /*
- * XXX cdev_t has different meanings for userland vs kernel compiles.  What
- * do we do for _KERNEL_STRUCTURES ?  For the moment stick with the userland
- * meaning as being the more compatible solution.
+ * The kernel now uses only udev_t or cdev_t.  Userland uses dev_t.
+ * Virtual kernel builds needs dev_t in order to include userland headers.
  */
-
 #if defined(_KERNEL) || defined(_KERNEL_STRUCTURES)
-
 struct cdev;
-
-typedef	u_int32_t	udev_t;		/* device number */
 typedef	struct cdev	*cdev_t;
-
+#ifndef _UDEV_T_DECLARED
+typedef	__uint32_t	udev_t;		/* device number */
+#define	_UDEV_T_DECLARED
 #endif
+typedef	__uint64_t	uoff_t;		/* uio offset */
+#endif /* _KERNEL) || _KERNEL_STRUCTURES */
 
-/*
- * The kernel now uses only udev_t or cdev_t.  Userland uses dev_t.
- * Virtual kernel builds needs dev_t in order to include userland header
- * files.
- */
-#ifdef _KERNEL
-
-#define	offsetof(type, field) __offsetof(type, field)
+#if defined(_KERNEL) /* && defined(_KERNEL_VIRTUAL) XXX genassym in vm_param.h needs it */
+#ifndef _DEV_T_DECLARED
 typedef	udev_t		dev_t;		/* device number */
+#define	_DEV_T_DECLARED
+#endif
+#endif /* _KERNEL */
 
-#else
-
-typedef	u_int32_t	dev_t;		/* device number */
-#define	udev_t dev_t
+#ifndef _KERNEL
+#ifndef _DEV_T_DECLARED
+typedef	__uint32_t	dev_t;		/* device number */
+#define	_DEV_T_DECLARED
+#endif
 
 #if __BSD_VISIBLE
-
+#if !defined(_KERNEL_STRUCTURES)
+#define	udev_t dev_t
+#endif
 /*
  * minor() gives a cookie instead of an index since we don't want to
  * change the meanings of bits 0-15 or waste time and space shifting
@@ -200,9 +185,7 @@ typedef	u_int32_t	dev_t;		/* device number */
 #define	major(x)	((int)(((u_int)(x) >> 8)&0xff)) /* major number */
 #define	minor(x)	((int)((x)&0xffff00ff))         /* minor number */
 #define	makedev(x,y)	((dev_t)(((x) << 8) | (y)))     /* create dev_t */
-
 #endif /* __BSD_VISIBLE */
-
 #endif /* !_KERNEL */
 
 #ifndef _CLOCK_T_DECLARED
@@ -242,9 +225,22 @@ typedef	__time_t	time_t;
 typedef	__timer_t	timer_t;
 #endif
 
+#ifndef _KERNEL
+#ifdef _WANT_STDINT
+#include <stdint.h>			/* XXX used by certain ports */
+#endif
+#endif
+
+#if defined(_KERNEL) || defined(_KERNEL_STRUCTURES)
+#include <sys/stdint.h>			/* kernel int types */
+#include <machine/types.h>		/* for vm_offet_t */
+#endif
+
 #if __BSD_VISIBLE
 #include <sys/_fd_set.h>
 #include <sys/_timeval.h>
 #endif /* __BSD_VISIBLE */
 
+#include <sys/_pthreadtypes.h>		/* now POSIX thread types */
+
 #endif /* !_SYS_TYPES_H_ */
diff --git a/sys/sys/uio.h b/sys/sys/uio.h
index 5083afc27f..6f8d29afad 100644
--- a/sys/sys/uio.h
+++ b/sys/sys/uio.h
@@ -35,15 +35,16 @@
 
 #include <sys/cdefs.h>
 #include <sys/_iovec.h>
+#include <machine/stdint.h>
 
-#ifdef __BSD_VISIBLE
+#if __BSD_VISIBLE
 #ifndef _OFF_T_DECLARED
 typedef	__off_t		off_t;
 #define	_OFF_T_DECLARED
 #endif
 #endif
 
-/* The size_t and __ types are expected to be provided by <sys/_iovec.h> */
+/* The size_t is expected to be provided by <sys/_iovec.h> */
 
 #ifndef _SSIZE_T_DECLARED
 typedef	__ssize_t	ssize_t;
diff --git a/sys/sys/upmap.h b/sys/sys/upmap.h
index da1697e26c..a97440e7da 100644
--- a/sys/sys/upmap.h
+++ b/sys/sys/upmap.h
@@ -41,6 +41,9 @@
 #ifndef _SYS_TIME_H_
 #include <sys/time.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 
 #define UPMAP_MAXPROCTITLE	1024
 #define UPMAP_MAPSIZE		65536
diff --git a/sys/sys/usched.h b/sys/sys/usched.h
index 41d30ca8ae..296d01db46 100644
--- a/sys/sys/usched.h
+++ b/sys/sys/usched.h
@@ -2,8 +2,6 @@
  * SYS/USCHED.H
  *
  *	Userland scheduler API
- * 
- * $DragonFly: src/sys/sys/usched.h,v 1.15 2008/04/21 15:24:47 dillon Exp $
  */
 
 #ifndef _SYS_USCHED_H_
@@ -14,6 +12,9 @@
 #ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_CPUMASK_H_
+#include <sys/cpumask.h>
+#endif
 #ifndef _SYS_QUEUE_H_
 #include <sys/queue.h>
 #endif
@@ -49,7 +50,7 @@ struct usched {
 
 union usched_data {
     /*
-     * BSD4 scheduler. 
+     * BSD4 scheduler.
      */
     struct {
 	short	priority;	/* lower is better */
diff --git a/sys/sys/vfscache.h b/sys/sys/vfscache.h
index c0b9ee512d..2ba7f7ccb7 100644
--- a/sys/sys/vfscache.h
+++ b/sys/sys/vfscache.h
@@ -3,11 +3,11 @@
  *
  * This code is derived from software contributed to The DragonFly Project
  * by Matthew Dillon <dillon@backplane.com>
- * 
+ *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
- * 
+ *
  * 1. Redistributions of source code must retain the above copyright
  *    notice, this list of conditions and the following disclaimer.
  * 2. Redistributions in binary form must reproduce the above copyright
@@ -17,7 +17,7 @@
  * 3. Neither the name of The DragonFly Project nor the names of its
  *    contributors may be used to endorse or promote products derived
  *    from this software without specific, prior written permission.
- * 
+ *
  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
@@ -138,8 +138,8 @@ struct vattr {
 	u_quad_t	va_filerev;	/* file modification number */
 	u_int		va_vaflags;	/* operations flags, see below */
 	long		va_spare;	/* remain quad aligned */
-	uint32_t	va_fuseflags;	/* used by FUSE */
-	uint32_t	va_unused01;
+	u_int32_t	va_fuseflags;	/* used by FUSE */
+	u_int32_t	va_unused01;
 	uuid_t		va_uid_uuid;	/* native uuids if available */
 	uuid_t		va_gid_uuid;
 	uuid_t		va_fsid_uuid;
diff --git a/sys/sys/vmm.h b/sys/sys/vmm.h
index 3f85440c2c..8ef75ad8d0 100644
--- a/sys/sys/vmm.h
+++ b/sys/sys/vmm.h
@@ -51,7 +51,7 @@ struct vmm_guest_options {
 	register_t vmm_cr3;
 	register_t new_stack;
 	struct trapframe tf;
-	uint8_t master;
+	u_int8_t master;
 };
 
 
diff --git a/sys/sys/vmmeter.h b/sys/sys/vmmeter.h
index 536ef748cf..5f7e30a06d 100644
--- a/sys/sys/vmmeter.h
+++ b/sys/sys/vmmeter.h
@@ -36,6 +36,9 @@
 #ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 
 struct globaldata;
 
diff --git a/sys/sys/vnioctl.h b/sys/sys/vnioctl.h
index ee23edc16c..2c744c7094 100644
--- a/sys/sys/vnioctl.h
+++ b/sys/sys/vnioctl.h
@@ -47,6 +47,9 @@
 #ifndef _SYS_PARAM_H_
 #include <sys/param.h>		/* PATH_MAX */
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 
 /*
  * Ioctl definitions for file (vnode) disk pseudo-device.
diff --git a/sys/sys/wait.h b/sys/sys/wait.h
index a4960d2132..1d8acd05d2 100644
--- a/sys/sys/wait.h
+++ b/sys/sys/wait.h
@@ -139,7 +139,7 @@ typedef	enum
 #endif
 
 #if !defined(_KERNEL) || defined(_KERNEL_VIRTUAL)
-#include <sys/stdint.h>
+#include <machine/stdint.h>
 
 #ifndef _PID_T_DECLARED
 typedef	__pid_t		pid_t;		/* process id */
diff --git a/sys/sys/xdiskioctl.h b/sys/sys/xdiskioctl.h
index 4282da42ff..2daef179a8 100644
--- a/sys/sys/xdiskioctl.h
+++ b/sys/sys/xdiskioctl.h
@@ -48,7 +48,7 @@
 struct xdisk_attach_ioctl {
 	int	fd;
 	int	unused01;
-	int32_t	reserved02[8];
+	__int32_t reserved02[8];
 };
 
 #define XDISKIOCATTACH	_IOWR('X', 0, struct xdisk_attach_ioctl)
diff --git a/sys/vfs/fuse/fuse_abi.h b/sys/vfs/fuse/fuse_abi.h
index b4967d48bf..6a42eb9165 100644
--- a/sys/vfs/fuse/fuse_abi.h
+++ b/sys/vfs/fuse/fuse_abi.h
@@ -127,7 +127,9 @@
 #ifndef _LINUX_FUSE_H
 #define _LINUX_FUSE_H
 
-#ifdef __KERNEL__
+#if defined(_KERNEL)
+#include <sys/stdint.h>
+#elif defined(__KERNEL__)
 #include <linux/types.h>
 #else
 #include <stdint.h>
diff --git a/sys/vfs/hammer/hammer_disk.h b/sys/vfs/hammer/hammer_disk.h
index 6527f1092a..0572713198 100644
--- a/sys/vfs/hammer/hammer_disk.h
+++ b/sys/vfs/hammer/hammer_disk.h
@@ -38,6 +38,7 @@
 #define VFS_HAMMER_DISK_H_
 
 #include <sys/endian.h>
+#include <sys/stdint.h>
 
 #ifndef _SYS_UUID_H_
 #include <sys/uuid.h>
diff --git a/sys/vfs/hammer2/hammer2_ccms.h b/sys/vfs/hammer2/hammer2_ccms.h
index 8585e52a36..e3ad4684b1 100644
--- a/sys/vfs/hammer2/hammer2_ccms.h
+++ b/sys/vfs/hammer2/hammer2_ccms.h
@@ -72,6 +72,9 @@
 #ifndef _SYS_TYPES_H_
 #include <sys/types.h>
 #endif
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 #ifndef _SYS_PARAM_H_
 #include <sys/param.h>
 #endif
diff --git a/sys/vfs/hammer2/hammer2_disk.h b/sys/vfs/hammer2/hammer2_disk.h
index f57b94101f..4726b76a1f 100644
--- a/sys/vfs/hammer2/hammer2_disk.h
+++ b/sys/vfs/hammer2/hammer2_disk.h
@@ -36,6 +36,9 @@
 #ifndef _VFS_HAMMER2_DISK_H_
 #define _VFS_HAMMER2_DISK_H_
 
+#ifndef _SYS_STDINT_H_
+#include <sys/stdint.h>
+#endif
 #ifndef _SYS_UUID_H_
 #include <sys/uuid.h>
 #endif
diff --git a/sys/vfs/hammer2/hammer2_lz4.c b/sys/vfs/hammer2/hammer2_lz4.c
index 19f88b27d1..80180ed791 100644
--- a/sys/vfs/hammer2/hammer2_lz4.c
+++ b/sys/vfs/hammer2/hammer2_lz4.c
@@ -119,7 +119,7 @@ static MALLOC_DEFINE(C_HASHTABLE, "comphashtable",
 // Basic Types
 //**************************************
 #if defined (__STDC_VERSION__) && __STDC_VERSION__ >= 199901L   // C99
-# include <stdint.h>
+# include <sys/stdint.h>
   typedef uint8_t  BYTE;
   typedef uint16_t U16;
   typedef uint32_t U32;
diff --git a/sys/vfs/hammer2/xxhash/xxhash.c b/sys/vfs/hammer2/xxhash/xxhash.c
index 8289f4b240..14d4dcc78f 100644
--- a/sys/vfs/hammer2/xxhash/xxhash.c
+++ b/sys/vfs/hammer2/xxhash/xxhash.c
@@ -139,7 +139,7 @@ static void* XXH_memcpy(void* dest, const void* src, size_t size) { return memcp
 #ifndef MEM_MODULE
 # define MEM_MODULE
 # if defined (__STDC_VERSION__) && __STDC_VERSION__ >= 199901L   /* C99 */
-#   include <stdint.h>
+#   include <sys/stdint.h>
     typedef uint8_t  BYTE;
     typedef uint16_t U16;
     typedef uint32_t U32;
diff --git a/sys/vfs/msdosfs/bpb.h b/sys/vfs/msdosfs/bpb.h
index 682974fb78..77fba0c088 100644
--- a/sys/vfs/msdosfs/bpb.h
+++ b/sys/vfs/msdosfs/bpb.h
@@ -20,6 +20,8 @@
 #ifndef _FS_MSDOSFS_BPB_H_
 #define	_FS_MSDOSFS_BPB_H_
 
+#include <sys/stdint.h>
+
 /*
  * BIOS Parameter Block (BPB) for DOS 3.3
  */
diff --git a/sys/vfs/ufs/ffs_subr.c b/sys/vfs/ufs/ffs_subr.c
index 5de6c4897d..7a60602365 100644
--- a/sys/vfs/ufs/ffs_subr.c
+++ b/sys/vfs/ufs/ffs_subr.c
@@ -33,6 +33,7 @@
 #include <sys/param.h>
 
 #ifndef _KERNEL
+#include <stdint.h>
 #include "dinode.h"
 #include "fs.h"
 extern void panic(const char *, ...) __printflike(1, 2) __dead2;
diff --git a/sys/vm/vm_pager.h b/sys/vm/vm_pager.h
index 8113cd5ec9..8990291fc1 100644
--- a/sys/vm/vm_pager.h
+++ b/sys/vm/vm_pager.h
@@ -52,6 +52,7 @@
 #include <vm/vm_object.h>
 #endif
 
+#ifdef _KERNEL
 TAILQ_HEAD(pagerlst, vm_object);
 
 struct buf;
@@ -63,6 +64,7 @@ struct pagerops {
 	void (*pgo_putpages) (vm_object_t, vm_page_t *, int, int, int *);
 	boolean_t (*pgo_haspage) (vm_object_t, vm_pindex_t);
 };
+#endif	/* _KERNEL */
 
 /*
  * get/put return values
@@ -162,8 +164,8 @@ vm_pager_put_pages(
 static __inline boolean_t
 vm_pager_has_page(vm_object_t object, vm_pindex_t offset)
 {
-        return ((*pagertab[object->type]->pgo_haspage)(object, offset));
-} 
+	return ((*pagertab[object->type]->pgo_haspage)(object, offset));
+}
 
 struct cdev_pager_ops {
 	int (*cdev_pg_fault)(vm_object_t vm_obj, vm_ooffset_t offset,
@@ -179,6 +181,6 @@ vm_object_t cdev_pager_allocate(void *handle, enum obj_type tp,
 vm_object_t cdev_pager_lookup(void *handle);
 void cdev_pager_free_page(vm_object_t object, vm_page_t m);
 
-#endif
+#endif	/* _KERNEL */
 
-#endif				/* _VM_VM_PAGER_H_ */
+#endif	/* _VM_VM_PAGER_H_ */
diff --git a/sys/vm/vm_zone.h b/sys/vm/vm_zone.h
index 04173e889d..a9d9ce2dc6 100644
--- a/sys/vm/vm_zone.h
+++ b/sys/vm/vm_zone.h
@@ -12,12 +12,16 @@
  *	John S. Dyson.
  *
  * $FreeBSD: src/sys/vm/vm_zone.h,v 1.13.2.2 2002/10/10 19:50:16 dillon Exp $
- * $DragonFly: src/sys/vm/vm_zone.h,v 1.10 2008/01/21 20:21:19 nth Exp $
  */
 
 #ifndef _VM_VM_ZONE_H_
 #define _VM_VM_ZONE_H_
 
+#if defined(_KERNEL) || defined(_KERNEL_STRUCTURES)
+
+#include <sys/spinlock.h>
+#include <sys/thread.h>
+
 #define ZONE_INTERRUPT 0x0001	/* If you need to allocate at int time */
 #define ZONE_PANICFAIL 0x0002	/* panic if the zalloc fails */
 #define ZONE_SPECIAL   0x0004	/* special vm_map_entry zone, see zget() */
@@ -27,9 +31,6 @@
 
 #define ZONE_MAXPGLOAD	32	/* max VM pages burst in zget() */
 
-#include <sys/spinlock.h>
-#include <sys/thread.h>
-
 /*
  * Zone allocator.
  * Zones are deprecated, use <sys/objcache.h> instead for new developments.
@@ -74,7 +75,7 @@ typedef struct vm_zone {
 	long		zkmmax;		/* # of slots in zkmvec */
 } *vm_zone_t;
 
-
+#ifdef _KERNEL
 void		zerror (int) __dead2;
 vm_zone_t	zinit (char *name, size_t size, long nentries, uint32_t flags);
 int		zinitna (vm_zone_t z, char *name,
@@ -84,5 +85,8 @@ void		zfree (vm_zone_t z, void *item);
 void		zbootinit (vm_zone_t z, char *name, size_t size, void *item,
 			       long nitems);
 void		zdestroy(vm_zone_t z);
+#endif	/* _KERNEL */
+
+#endif	/* _KERNEL || _KERNEL_STRUCTURES */
 
 #endif	/* _VM_VM_ZONE_H_ */
diff --git a/usr.bin/c89/c89.c b/usr.bin/c89/c89.c
index 486461b362..2024365bb7 100644
--- a/usr.bin/c89/c89.c
+++ b/usr.bin/c89/c89.c
@@ -26,10 +26,10 @@
  * SUCH DAMAGE.
  *
  * $FreeBSD: src/usr.bin/c89/c89.c,v 1.5 2005/05/21 09:55:04 ru Exp $
- * $DragonFly: src/usr.bin/c89/c89.c,v 1.5 2008/05/25 08:18:26 swildner Exp $
  */
 
 #include <err.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/usr.bin/calendar/io.c b/usr.bin/calendar/io.c
index 1cdc30ee06..1c492f2855 100644
--- a/usr.bin/calendar/io.c
+++ b/usr.bin/calendar/io.c
@@ -46,6 +46,7 @@
 #include <paths.h>
 #include <pwd.h>
 #include <stdbool.h>
+#include <stdint.h>	/* for uintptr_t * in __DECONST() */
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/usr.bin/cksum/cksum.c b/usr.bin/cksum/cksum.c
index 0e45cfc251..816dfd011e 100644
--- a/usr.bin/cksum/cksum.c
+++ b/usr.bin/cksum/cksum.c
@@ -31,13 +31,13 @@
  *
  * @(#)cksum.c	8.2 (Berkeley) 4/28/95
  * $FreeBSD: src/usr.bin/cksum/cksum.c,v 1.18 2008/05/15 20:04:36 brooks Exp $
- * $DragonFly: src/usr.bin/cksum/cksum.c,v 1.6 2005/04/10 20:55:38 drhodus Exp $
  */
 
 #include <sys/types.h>
 
 #include <err.h>
 #include <fcntl.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/usr.bin/cksum/extern.h b/usr.bin/cksum/extern.h
index 677dc676b9..aaf03c083f 100644
--- a/usr.bin/cksum/extern.h
+++ b/usr.bin/cksum/extern.h
@@ -28,7 +28,6 @@
  *
  *	@(#)extern.h	8.1 (Berkeley) 6/6/93
  * $FreeBSD: src/usr.bin/cksum/extern.h,v 1.6 2003/03/13 23:32:28 robert Exp $
- * $DragonFly: src/usr.bin/cksum/extern.h,v 1.3 2003/11/03 19:31:28 eirikn Exp $
  */
 
 #include <sys/cdefs.h>
diff --git a/usr.bin/hexdump/display.c b/usr.bin/hexdump/display.c
index eec71fd934..aa3551a647 100644
--- a/usr.bin/hexdump/display.c
+++ b/usr.bin/hexdump/display.c
@@ -28,7 +28,6 @@
  *
  * @(#)display.c	8.1 (Berkeley) 6/6/93
  * $FreeBSD: src/usr.bin/hexdump/display.c,v 1.4.2.2 2002/07/23 14:27:06 tjr Exp $
- * $DragonFly: src/usr.bin/hexdump/display.c,v 1.6 2005/04/10 20:55:38 drhodus Exp $
  */
 
 #include <sys/param.h>
@@ -36,6 +35,7 @@
 
 #include <ctype.h>
 #include <err.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/usr.bin/kcollect/kcollect.h b/usr.bin/kcollect/kcollect.h
index 0e3504dd07..68789a6177 100644
--- a/usr.bin/kcollect/kcollect.h
+++ b/usr.bin/kcollect/kcollect.h
@@ -31,6 +31,7 @@
 
 #include <sys/types.h>
 #include <sys/sysctl.h>
+#include <stdint.h>
 #include <sys/kcollect.h>
 #include <time.h>
 #include <stdio.h>
diff --git a/usr.bin/ktrdump/ktrdump.c b/usr.bin/ktrdump/ktrdump.c
index 9cb66d28f1..850625aa7a 100644
--- a/usr.bin/ktrdump/ktrdump.c
+++ b/usr.bin/ktrdump/ktrdump.c
@@ -40,6 +40,7 @@
 #include <kvm.h>
 #include <limits.h>
 #include <nlist.h>
+#include <stddef.h>
 #include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
@@ -469,12 +470,12 @@ print_entry(FILE *fo, int n, int row, struct ktr_entry *entry,
 	}
 	if (xflag) {
 		if (nflag) {
-		    fprintf(fo, "%p %p ", 
+		    fprintf(fo, "%p %p ",
 			    entry->ktr_caller2, entry->ktr_caller1);
 		} else {
-		    fprintf(fo, "%-25s ", 
+		    fprintf(fo, "%-25s ",
 			    address_to_symbol(entry->ktr_caller2, &symctx));
-		    fprintf(fo, "%-25s ", 
+		    fprintf(fo, "%-25s ",
 			    address_to_symbol(entry->ktr_caller1, &symctx));
 		}
 	}
@@ -627,7 +628,7 @@ mangle_string_ptrs(const char *fmt, uint8_t *fmtdata, int dofree)
 			  char *t = strdup(kvm_string(((char **)fmtdata)[0],
 							  &strctx));
 			  ((const char **)fmtdata)[0] = t;
-					
+
 				skipsize = sizeof(char *);
 			}
 			++ret;
@@ -796,7 +797,7 @@ read_symbols(const char *file)
 		pclose(fp);
 	}
 	if (symend == NULL) {
-		if (sym != NULL) 
+		if (sym != NULL)
 			symend = sym->symaddr;
 		else
 			symend = (char *)-1;
diff --git a/usr.bin/limits/limits.c b/usr.bin/limits/limits.c
index 9c916983f3..30c3384170 100644
--- a/usr.bin/limits/limits.c
+++ b/usr.bin/limits/limits.c
@@ -29,6 +29,7 @@
 #include <sys/types.h>
 #include <sys/stat.h>
 #include <sys/param.h>
+#include <stdint.h>		/* for (intmax_t) */
 #include <stdlib.h>
 #include <unistd.h>
 #include <stdarg.h>
diff --git a/usr.bin/localedef/localedef.h b/usr.bin/localedef/localedef.h
index 28736f8582..bc326b4dd8 100644
--- a/usr.bin/localedef/localedef.h
+++ b/usr.bin/localedef/localedef.h
@@ -33,6 +33,7 @@
  */
 
 /* Common header files. */
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <stdarg.h>
diff --git a/usr.bin/m4/extern.h b/usr.bin/m4/extern.h
index 82ccd6da6b..5ef1875e30 100644
--- a/usr.bin/m4/extern.h
+++ b/usr.bin/m4/extern.h
@@ -36,6 +36,8 @@
  * $FreeBSD: src/usr.bin/m4/extern.h,v 1.17 2012/11/17 01:54:24 svnexp Exp $
  */
 
+#include <stdint.h>
+
 /* eval.c */
 extern void	eval(const char *[], int, int, int);
 extern void	dodefine(const char *, const char *);
diff --git a/usr.bin/netstat/route.c b/usr.bin/netstat/route.c
index 128a8f1c99..f73d0b7029 100644
--- a/usr.bin/netstat/route.c
+++ b/usr.bin/netstat/route.c
@@ -30,6 +30,7 @@
  * $FreeBSD: src/usr.bin/netstat/route.c,v 1.41.2.14 2002/07/17 02:22:22 kbyanc Exp $
  */
 
+#define _KERNEL_STRUCTURES
 #include <sys/kinfo.h>
 #include <sys/param.h>
 #include <sys/socket.h>
@@ -37,7 +38,7 @@
 
 #include <net/ethernet.h>
 #include <net/if.h>
-#include <net/if_var.h>
+#include <net/if_var.h>		/* for struct ifnet */
 #include <net/if_dl.h>
 #include <net/if_types.h>
 #include <net/route.h>
diff --git a/usr.bin/ruptime/ruptime.c b/usr.bin/ruptime/ruptime.c
index 23d758b9cf..5702c41b68 100644
--- a/usr.bin/ruptime/ruptime.c
+++ b/usr.bin/ruptime/ruptime.c
@@ -33,6 +33,7 @@
 
 #include <sys/param.h>
 
+#include <stdint.h>
 #include <protocols/rwhod.h>
 
 #include <dirent.h>
diff --git a/usr.bin/rwho/rwho.c b/usr.bin/rwho/rwho.c
index 9520224937..7f2e9f6499 100644
--- a/usr.bin/rwho/rwho.c
+++ b/usr.bin/rwho/rwho.c
@@ -34,6 +34,7 @@
 #include <sys/param.h>
 #include <sys/file.h>
 
+#include <stdint.h>
 #include <protocols/rwhod.h>
 
 #include <dirent.h>
diff --git a/usr.bin/sort/mem.c b/usr.bin/sort/mem.c
index c8e9546006..6e0669ec8f 100644
--- a/usr.bin/sort/mem.c
+++ b/usr.bin/sort/mem.c
@@ -29,6 +29,7 @@
 
 
 #include <err.h>
+#include <stdint.h>	/* for uintptr in __DECONST() */
 #include <stdlib.h>
 #include <string.h>
 
diff --git a/usr.bin/strfile/strfile.h b/usr.bin/strfile/strfile.h
index a64f46b3a2..3110464aff 100644
--- a/usr.bin/strfile/strfile.h
+++ b/usr.bin/strfile/strfile.h
@@ -33,7 +33,7 @@
  */
 /* $FreeBSD: head/usr.bin/fortune/strfile/strfile.h 203926 2010-02-15 15:10:21Z uqs $ */
 
-#include <sys/types.h>
+#include <stdint.h>
 
 #define	STR_ENDSTRING(line,tbl) \
 	(((unsigned char)(line)[0]) == (tbl).str_delim && (line)[1] == '\n')
diff --git a/usr.bin/tail/misc.c b/usr.bin/tail/misc.c
index 202e9bc0ce..16f42cd5fc 100644
--- a/usr.bin/tail/misc.c
+++ b/usr.bin/tail/misc.c
@@ -38,6 +38,7 @@
 #include <sys/mman.h>
 #include <errno.h>
 #include <unistd.h>
+#include <stdint.h>		/* for (intmax_t) */
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/usr.bin/tail/reverse.c b/usr.bin/tail/reverse.c
index 496ac605e7..8f6eef49fc 100644
--- a/usr.bin/tail/reverse.c
+++ b/usr.bin/tail/reverse.c
@@ -31,7 +31,6 @@
  *
  * @(#)reverse.c	8.1 (Berkeley) 6/6/93
  * $FreeBSD: src/usr.bin/tail/reverse.c,v 1.9.2.3 2001/12/19 20:29:31 iedowse Exp $
- * $DragonFly: src/usr.bin/tail/reverse.c,v 1.5 2006/08/13 02:12:18 swildner Exp $
  */
 
 #include <sys/param.h>
@@ -41,6 +40,7 @@
 #include <limits.h>
 #include <errno.h>
 #include <unistd.h>
+#include <stdint.h>		/* for (intmax_t) */
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/usr.bin/talk/invite.c b/usr.bin/talk/invite.c
index c2607bb39d..f08e0d969a 100644
--- a/usr.bin/talk/invite.c
+++ b/usr.bin/talk/invite.c
@@ -36,6 +36,7 @@
 #include <errno.h>
 #include <setjmp.h>
 #include <signal.h>
+#include <stdint.h>
 #include <protocols/talkd.h>
 #include "talk_ctl.h"
 #include "talk.h"
diff --git a/usr.bin/talk/look_up.c b/usr.bin/talk/look_up.c
index e1554e155f..3a19597ab1 100644
--- a/usr.bin/talk/look_up.c
+++ b/usr.bin/talk/look_up.c
@@ -32,6 +32,7 @@
 
 #include <sys/param.h>
 #include <sys/socket.h>
+#include <stdint.h>
 #include <protocols/talkd.h>
 #include <errno.h>
 #include "talk_ctl.h"
diff --git a/usr.bin/window/string.c b/usr.bin/window/string.c
index d4104f5477..83fc888313 100644
--- a/usr.bin/window/string.c
+++ b/usr.bin/window/string.c
@@ -33,6 +33,7 @@
  * SUCH DAMAGE.
  */
 
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/usr.bin/window/ttgeneric.c b/usr.bin/window/ttgeneric.c
index 5decc8f77b..b57e2b89ca 100644
--- a/usr.bin/window/ttgeneric.c
+++ b/usr.bin/window/ttgeneric.c
@@ -33,6 +33,7 @@
  * SUCH DAMAGE.
  */
 
+#include <stdint.h>	/* fr uintptr_t in __DECONST() */
 #include <stdlib.h>
 #include <string.h>
 #include <termcap.h>
diff --git a/usr.bin/xargs/strnsubst.c b/usr.bin/xargs/strnsubst.c
index a22d0a40c8..6bc199853b 100644
--- a/usr.bin/xargs/strnsubst.c
+++ b/usr.bin/xargs/strnsubst.c
@@ -8,10 +8,10 @@
  * 	For the man who taught me vi, and who got too old, too young.
  *
  * $FreeBSD: src/usr.bin/xargs/strnsubst.c,v 1.5.2.1 2002/06/17 04:44:46 jmallett Exp $
- * $DragonFly: src/usr.bin/xargs/strnsubst.c,v 1.2 2003/06/17 04:29:34 dillon Exp $
  */
 
 #include <err.h>
+#include <stdint.h>
 #include <stdlib.h>
 #include <string.h>
 #include <unistd.h>
diff --git a/usr.sbin/cdcontrol/cdcontrol.c b/usr.sbin/cdcontrol/cdcontrol.c
index d60dbe1e90..cf57386198 100644
--- a/usr.sbin/cdcontrol/cdcontrol.c
+++ b/usr.sbin/cdcontrol/cdcontrol.c
@@ -31,6 +31,7 @@
 #include <histedit.h>
 #include <limits.h>
 #include <paths.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/usr.sbin/clog/clog.c b/usr.sbin/clog/clog.c
index 7f5df6050e..12cfeecf18 100644
--- a/usr.sbin/clog/clog.c
+++ b/usr.sbin/clog/clog.c
@@ -3,24 +3,24 @@
  *     Jeff Wheelhouse (jdw@wwwi.com)
  *
  * This code was originally developed by Jeff Wheelhouse (jdw@wwwi.com).
- * 
+ *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
- * 1. Redistribution of source code must retail the above copyright 
+ * 1. Redistribution of source code must retail the above copyright
  *    notice, this list of conditions and the following disclaimer.
  * 2. Redistributions in binary form must reproduce the above copyright
  *    notice, this list of conditions and the following disclaimer in the
  *    documentation and/or other materials provided with the distribution.
  *
- * THIS SOFTWARE IS PROVIDED BY JEFF WHEELHOUSE ``AS IS'' AND ANY EXPRESS OR 
- * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES 
- * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN 
- * NO EVENT SHALL JEFF WHEELHOUSE BE LIABLE FOR ANY DIRECT, INDIRECT, 
- * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING BUT NOT 
- * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, 
- * OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF 
- * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING 
+ * THIS SOFTWARE IS PROVIDED BY JEFF WHEELHOUSE ``AS IS'' AND ANY EXPRESS OR
+ * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
+ * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN
+ * NO EVENT SHALL JEFF WHEELHOUSE BE LIABLE FOR ANY DIRECT, INDIRECT,
+ * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING BUT NOT
+ * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,
+ * OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+ * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
  * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
  * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  *
@@ -33,6 +33,7 @@
 #include <fcntl.h>
 #include <poll.h>
 #include <signal.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
@@ -43,12 +44,10 @@
 #include <sys/stat.h>
 #include <sys/uio.h>
 
-
 #include "clog.h"
 
-
 /*
- *  The BUFFER_SIZE value is just used to allocate a buffer full of NULLs 
+ *  The BUFFER_SIZE value is just used to allocate a buffer full of NULLs
  *  so that a new logfile can be extended to its full size.
  *
  *  Compiling with -pedantic complains when the buffer array is declared
@@ -105,7 +104,7 @@ main(int argc, char **argv)
 	if (init==1) init_log(argv[optind],size);
 	/* if (optf==1) follow_log(artv[optind]); */
 	read_log(argv[optind],optf);
-		
+
 	return 0;
 }
 
@@ -173,7 +172,7 @@ read_log(const char *lname, int optf)
 			exit(16);
 		}
 	}
-	
+
 	munmap(pbuffer,sb.st_size);
 	close(fd);
 
@@ -194,7 +193,7 @@ init_log(const char *lname, size_t size)
 
 	memset(buffer,0,BUFFER_SIZE);
 
-	fd = open(lname,O_RDWR|O_CREAT,0666); 
+	fd = open(lname,O_RDWR|O_CREAT,0666);
 	if (fd==-1) {
 		fprintf(stderr,"%s: ERROR: could not open %s (%s)\n",pname,lname,strerror(errno));
 		exit(2);
@@ -203,7 +202,7 @@ init_log(const char *lname, size_t size)
 		fprintf(stderr,"%s: ERROR: could not truncate %s (%s)\n",pname,lname,strerror(errno));
 		exit(3);
 	}
-	
+
 	while(fill>BUFFER_SIZE) {
 		if (write(fd,buffer,BUFFER_SIZE)==-1){
 			fprintf(stderr,"%s: ERROR: could not write %s (%s)\n",pname,lname,strerror(errno));
diff --git a/usr.sbin/clog/clog.h b/usr.sbin/clog/clog.h
index 14189c317f..ed9e7a2b0f 100644
--- a/usr.sbin/clog/clog.h
+++ b/usr.sbin/clog/clog.h
@@ -3,24 +3,24 @@
  *     Jeff Wheelhouse (jdw@wwwi.com)
  *
  * This code was originally developed by Jeff Wheelhouse (jdw@wwwi.com).
- * 
+ *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
- * 1. Redistribution of source code must retail the above copyright 
+ * 1. Redistribution of source code must retail the above copyright
  *    notice, this list of conditions and the following disclaimer.
  * 2. Redistributions in binary form must reproduce the above copyright
  *    notice, this list of conditions and the following disclaimer in the
  *    documentation and/or other materials provided with the distribution.
  *
- * THIS SOFTWARE IS PROVIDED BY JEFF WHEELHOUSE ``AS IS'' AND ANY EXPRESS OR 
- * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES 
- * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN 
- * NO EVENT SHALL JEFF WHEELHOUSE BE LIABLE FOR ANY DIRECT, INDIRECT, 
- * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING BUT NOT 
- * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, 
- * OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF 
- * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING 
+ * THIS SOFTWARE IS PROVIDED BY JEFF WHEELHOUSE ``AS IS'' AND ANY EXPRESS OR
+ * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
+ * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN
+ * NO EVENT SHALL JEFF WHEELHOUSE BE LIABLE FOR ANY DIRECT, INDIRECT,
+ * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING BUT NOT
+ * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,
+ * OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+ * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
  * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
  * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  *
@@ -50,5 +50,3 @@ struct clog_footer {
 
 
 #endif  /* _CLOG_H_ */
-	
-
diff --git a/usr.sbin/cpucontrol/amd.c b/usr.sbin/cpucontrol/amd.c
index a875afd853..7cc99bbb79 100644
--- a/usr.sbin/cpucontrol/amd.c
+++ b/usr.sbin/cpucontrol/amd.c
@@ -41,6 +41,7 @@ __FBSDID("$FreeBSD$");
 #include <sys/mman.h>
 #include <sys/ioctl.h>
 #include <sys/ioccom.h>
+#include <stdint.h>
 #include <sys/cpuctl.h>
 
 #include <machine/cpufunc.h>
diff --git a/usr.sbin/cpucontrol/amd10h.c b/usr.sbin/cpucontrol/amd10h.c
index fe7deffdbc..7434685f43 100644
--- a/usr.sbin/cpucontrol/amd10h.c
+++ b/usr.sbin/cpucontrol/amd10h.c
@@ -31,6 +31,7 @@ __FBSDID("$FreeBSD$");
 #include <sys/mman.h>
 #include <sys/ioctl.h>
 #include <sys/ioccom.h>
+#include <stdint.h>
 #include <sys/cpuctl.h>
 
 #include <machine/cpufunc.h>
diff --git a/usr.sbin/cpucontrol/intel.c b/usr.sbin/cpucontrol/intel.c
index 7eca224e1e..39e3a0fe14 100644
--- a/usr.sbin/cpucontrol/intel.c
+++ b/usr.sbin/cpucontrol/intel.c
@@ -42,6 +42,7 @@ __FBSDID("$FreeBSD$");
 #include <sys/mman.h>
 #include <sys/ioctl.h>
 #include <sys/ioccom.h>
+#include <stdint.h>
 #include <sys/cpuctl.h>
 
 #include <machine/cpufunc.h>
diff --git a/usr.sbin/cpucontrol/via.c b/usr.sbin/cpucontrol/via.c
index 354817edf8..c04ab5ef03 100644
--- a/usr.sbin/cpucontrol/via.c
+++ b/usr.sbin/cpucontrol/via.c
@@ -42,6 +42,7 @@ __FBSDID("$FreeBSD$");
 #include <sys/mman.h>
 #include <sys/ioctl.h>
 #include <sys/ioccom.h>
+#include <stdint.h>
 #include <sys/cpuctl.h>
 
 #include <machine/cpufunc.h>
diff --git a/usr.sbin/edquota/edquota.c b/usr.sbin/edquota/edquota.c
index 7f9ea31deb..180188c98d 100644
--- a/usr.sbin/edquota/edquota.c
+++ b/usr.sbin/edquota/edquota.c
@@ -41,6 +41,7 @@
 #include <sys/stat.h>
 #include <sys/file.h>
 #include <sys/wait.h>
+#include <stdint.h>
 #include <vfs/ufs/quota.h>
 #include <ctype.h>
 #include <err.h>
diff --git a/usr.sbin/fstyp/fstyp.c b/usr.sbin/fstyp/fstyp.c
index 719bd998ba..f2793aadbe 100644
--- a/usr.sbin/fstyp/fstyp.c
+++ b/usr.sbin/fstyp/fstyp.c
@@ -37,6 +37,7 @@
 #include <errno.h>
 #include <stdbool.h>
 #include <stddef.h>
+#include <stdint.h>		/* for (uintmax_t) */
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/usr.sbin/fstyp/msdosfs.h b/usr.sbin/fstyp/msdosfs.h
index bd0abcef60..dd9ee6f20e 100644
--- a/usr.sbin/fstyp/msdosfs.h
+++ b/usr.sbin/fstyp/msdosfs.h
@@ -27,7 +27,7 @@
  * $FreeBSD$
  */
 
-#include <sys/types.h>
+#include <stdint.h>
 
 /*
  * Conversion macros for little endian encoded unsigned integers
diff --git a/usr.sbin/installer/libaura/popen.c b/usr.sbin/installer/libaura/popen.c
index d4a2fdf324..afcf6c6aab 100644
--- a/usr.sbin/installer/libaura/popen.c
+++ b/usr.sbin/installer/libaura/popen.c
@@ -49,6 +49,7 @@
 #include <errno.h>
 #include <signal.h>
 #include <stdarg.h>
+#include <stdint.h>		/* for uintptr_t in __DECONST() */
 #include <paths.h>
 #include <stdio.h>
 #include <stdlib.h>
diff --git a/usr.sbin/makefs/ffs/ffs_subr.c b/usr.sbin/makefs/ffs/ffs_subr.c
index 45dda21917..9def3bbff4 100644
--- a/usr.sbin/makefs/ffs/ffs_subr.c
+++ b/usr.sbin/makefs/ffs/ffs_subr.c
@@ -36,6 +36,7 @@
 
 #include <sys/param.h>
 #include <sys/types.h>
+#include <stdint.h>
 
 #include <ufs/ufs/dinode.h>
 #include <ufs/ffs/fs.h>
@@ -43,7 +44,7 @@
 #include "ffs/ufs_bswap.h"
 
 /*
- * Update the frsum fields to reflect addition or deletion 
+ * Update the frsum fields to reflect addition or deletion
  * of some frags.
  */
 void
diff --git a/usr.sbin/makefs/makefs.h b/usr.sbin/makefs/makefs.h
index 968331b957..d1a6c62ef7 100644
--- a/usr.sbin/makefs/makefs.h
+++ b/usr.sbin/makefs/makefs.h
@@ -44,13 +44,14 @@
 
 #include <sys/stat.h>
 #include <err.h>
+#include <stdint.h>		/* for uint32_t */
 
 /*
  * fsnode -
  *	a component of the tree; contains a filename, a pointer to
  *	fsinode, optional symlink name, and tree pointers
  *
- * fsinode - 
+ * fsinode -
  *	equivalent to an inode, containing target file system inode number,
  *	refcount (nlink), and stat buffer
  *
diff --git a/usr.sbin/memcontrol/memcontrol.c b/usr.sbin/memcontrol/memcontrol.c
index 750d4ef283..4672494363 100644
--- a/usr.sbin/memcontrol/memcontrol.c
+++ b/usr.sbin/memcontrol/memcontrol.c
@@ -33,6 +33,7 @@
 #include <err.h>
 #include <fcntl.h>
 #include <paths.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
@@ -66,18 +67,18 @@ static void	clearfunc(int memfd, int argc, char *argv[]);
 static void	helpfunc(int memfd, int argc, char *argv[]);
 static void	help(const char *what);
 
-struct 
+struct
 {
     const char	*cmd;
     const char	*desc;
     void	(*func)(int memfd, int argc, char *argv[]);
 } functions[] = {
-    {"list",	
+    {"list",
      "List current memory range attributes\n"
      "    list [-a]\n"
      "        -a    list all range slots, even those that are inactive",
      listfunc},
-    {"set",	
+    {"set",
      "Set memory range attributes\n"
      "    set -b <base> -l <length> -o <owner> <attribute>\n"
      "        <base>      memory range base address\n"
@@ -90,7 +91,7 @@ struct
      "                        write-back\n"
      "                        write-protect",
      setfunc},
-    {"clear",	
+    {"clear",
      "Clear memory range attributes\n"
      "    clear -o <owner>\n"
      "        <owner>     all ranges with this owner will be cleared\n"
@@ -131,7 +132,7 @@ mrgetall(int memfd, int *nmr)
     mro.mo_arg[0] = 0;
     if (ioctl(memfd, MEMRANGE_GET, &mro))
 	err(1, "can't size range descriptor array");
-    
+
     *nmr = mro.mo_arg[0];
     mrd = malloc(*nmr * sizeof(struct mem_range_desc));
     if (mrd == NULL)
@@ -171,7 +172,7 @@ listfunc(int memfd, int argc, char *argv[])
 	}
 
     mrd = mrgetall(memfd, &nd);
-    
+
     for (i = 0; i < nd; i++) {
 	if (!showall && !(mrd[i].mr_flags & MDF_ACTIVE))
 	    continue;
@@ -220,7 +221,7 @@ setfunc(int memfd, int argc, char *argv[])
 		help("set");
 	    strcpy(mrd.mr_owner, optarg);
 	    break;
-	    
+
 	case '?':
 	default:
 	    help("set");
@@ -231,7 +232,7 @@ setfunc(int memfd, int argc, char *argv[])
 
     argc -= optind;
     argv += optind;
-    
+
     while(argc--) {
 	for (i = 0; attrnames[i].name != NULL; i++) {
 	    if (!strcmp(attrnames[i].name, argv[0])) {
@@ -281,7 +282,7 @@ clearfunc(int memfd, int argc, char *argv[])
 		help("clear");
 	    owner = strdup(optarg);
 	    break;
-	    
+
 	case '?':
 	default:
 	    help("clear");
@@ -295,10 +296,10 @@ clearfunc(int memfd, int argc, char *argv[])
 	mrdp = mrgetall(memfd, &nd);
 	mro.mo_arg[0] = MEMRANGE_SET_REMOVE;
 	for (i = 0; i < nd; i++) {
-	    if (!strcmp(owner, mrdp[i].mr_owner) && 
+	    if (!strcmp(owner, mrdp[i].mr_owner) &&
 		(mrdp[i].mr_flags & MDF_ACTIVE) &&
 		!(mrdp[i].mr_flags & MDF_FIXACTIVE)) {
-		
+
 		mro.mo_desc = mrdp + i;
 		if (ioctl(memfd, MEMRANGE_SET, &mro))
 		    warn("couldn't clear range owned by '%s'", owner);
@@ -335,7 +336,7 @@ help(const char *what)
 	    }
 	fprintf(stderr, "Unknown command '%s'\n", what);
     }
-    
+
     /* print general help */
     fprintf(stderr, "Valid commands are :\n");
     for (i = 0; functions[i].cmd != NULL; i++)
diff --git a/usr.sbin/mfiutil/mfiutil.c b/usr.sbin/mfiutil/mfiutil.c
index 55ed3e162d..ff43959980 100644
--- a/usr.sbin/mfiutil/mfiutil.c
+++ b/usr.sbin/mfiutil/mfiutil.c
@@ -31,6 +31,7 @@
 
 #include <sys/errno.h>
 #include <err.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/usr.sbin/mfiutil/mfiutil.h b/usr.sbin/mfiutil/mfiutil.h
index fc849358d5..9eb70a1370 100644
--- a/usr.sbin/mfiutil/mfiutil.h
+++ b/usr.sbin/mfiutil/mfiutil.h
@@ -33,6 +33,7 @@
 #define	__MFIUTIL_H__
 
 #include <sys/linker_set.h>
+#include <stdint.h>
 
 #include <dev/raid/mfi/mfireg.h>
 
diff --git a/usr.sbin/mpsutil/mpr_ioctl.h b/usr.sbin/mpsutil/mpr_ioctl.h
index cb47d5a826..bedd7f31c0 100644
--- a/usr.sbin/mpsutil/mpr_ioctl.h
+++ b/usr.sbin/mpsutil/mpr_ioctl.h
@@ -64,6 +64,8 @@
 #ifndef _MPR_IOCTL_H_
 #define	_MPR_IOCTL_H_
 
+#include <stdint.h>
+
 #include <dev/raid/mpr/mpi/mpi2_type.h>
 #include <dev/raid/mpr/mpi/mpi2.h>
 #include <dev/raid/mpr/mpi/mpi2_cnfg.h>
diff --git a/usr.sbin/mpsutil/mps_ioctl.h b/usr.sbin/mpsutil/mps_ioctl.h
index b3e78ea39f..dfdf4cf0aa 100644
--- a/usr.sbin/mpsutil/mps_ioctl.h
+++ b/usr.sbin/mpsutil/mps_ioctl.h
@@ -64,6 +64,8 @@
 #ifndef _MPS_IOCTL_H_
 #define	_MPS_IOCTL_H_
 
+#include <stdint.h>
+
 #include <dev/raid/mps/mpi/mpi2_type.h>
 #include <dev/raid/mps/mpi/mpi2.h>
 #include <dev/raid/mps/mpi/mpi2_cnfg.h>
diff --git a/usr.sbin/mpsutil/mpsutil.h b/usr.sbin/mpsutil/mpsutil.h
index d9a96aa7f8..190dc04677 100644
--- a/usr.sbin/mpsutil/mpsutil.h
+++ b/usr.sbin/mpsutil/mpsutil.h
@@ -36,6 +36,7 @@
 #include <sys/cdefs.h>
 #include <sys/linker_set.h>
 #include <stdbool.h>
+#include <stdint.h>
 
 #include <dev/raid/mps/mpi/mpi2_type.h>
 #include <dev/raid/mps/mpi/mpi2.h>
diff --git a/usr.sbin/mptable/mptable.c b/usr.sbin/mptable/mptable.c
index 94cdfd138c..fdcaaf71e2 100644
--- a/usr.sbin/mptable/mptable.c
+++ b/usr.sbin/mptable/mptable.c
@@ -23,7 +23,6 @@
  * SUCH DAMAGE.
  *
  * $FreeBSD: src/usr.sbin/mptable/mptable.c,v 1.12.2.3 2000/12/11 01:03:34 obrien Exp $
- * $DragonFly: src/usr.sbin/mptable/mptable.c,v 1.4 2008/04/20 13:44:26 swildner Exp $
  */
 
 /*
@@ -39,6 +38,7 @@
 #define OEM_PROCESSING_READY_NOT
 
 #include <sys/types.h>
+#include <machine/types.h>	/* XXX for vm_offset_t */
 #include <err.h>
 #include <fcntl.h>
 #include <inttypes.h>
diff --git a/usr.sbin/mptutil/mptutil.h b/usr.sbin/mptutil/mptutil.h
index d38987a044..74a50f43bb 100644
--- a/usr.sbin/mptutil/mptutil.h
+++ b/usr.sbin/mptutil/mptutil.h
@@ -34,6 +34,7 @@
 #define	__MPTUTIL_H__
 
 #include <sys/linker_set.h>
+#include <stdint.h>
 
 #include <dev/disk/mpt/mpilib/mpi_type.h>
 #include <dev/disk/mpt/mpilib/mpi.h>
diff --git a/usr.sbin/mtree/pack_dev.c b/usr.sbin/mtree/pack_dev.c
index 42f6fa16cf..2c7ec2bd1e 100644
--- a/usr.sbin/mtree/pack_dev.c
+++ b/usr.sbin/mtree/pack_dev.c
@@ -37,6 +37,7 @@
 #include <sys/stat.h>
 
 #include <limits.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/usr.sbin/ndiscvt/inf.c b/usr.sbin/ndiscvt/inf.c
index ca04328e1c..4839dbb481 100644
--- a/usr.sbin/ndiscvt/inf.c
+++ b/usr.sbin/ndiscvt/inf.c
@@ -32,6 +32,7 @@
  * $FreeBSD: src/usr.sbin/ndiscvt/inf.c,v 1.19 2008/12/27 08:03:32 weongyo Exp $
  */
 
+#include <stdint.h>		/* for uintptr in __DECONST() */
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/usr.sbin/ngctl/ngctl.h b/usr.sbin/ngctl/ngctl.h
index e8a12ec0e8..42b624ee44 100644
--- a/usr.sbin/ngctl/ngctl.h
+++ b/usr.sbin/ngctl/ngctl.h
@@ -3,7 +3,7 @@
  *
  * Copyright (c) 1996-1999 Whistle Communications, Inc.
  * All rights reserved.
- * 
+ *
  * Subject to the following obligations and disclaimer of warranty, use and
  * redistribution of this software, in source or object code forms, with or
  * without modifications are expressly permitted by Whistle Communications;
@@ -14,7 +14,7 @@
  *    Communications, Inc. trademarks, including the mark "WHISTLE
  *    COMMUNICATIONS" on advertising, endorsements, or otherwise except as
  *    such appears in the above copyright notice or in the software.
- * 
+ *
  * THIS SOFTWARE IS BEING PROVIDED BY WHISTLE COMMUNICATIONS "AS IS", AND
  * TO THE MAXIMUM EXTENT PERMITTED BY LAW, WHISTLE COMMUNICATIONS MAKES NO
  * REPRESENTATIONS OR WARRANTIES, EXPRESS OR IMPLIED, REGARDING THIS SOFTWARE,
@@ -34,7 +34,6 @@
  * OF SUCH DAMAGE.
  *
  * $FreeBSD: src/usr.sbin/ngctl/ngctl.h,v 1.6.2.3 2002/02/01 18:17:43 archie Exp $
- * $DragonFly: src/usr.sbin/ngctl/ngctl.h,v 1.4 2005/03/16 04:45:07 joerg Exp $
  */
 
 #include <sys/types.h>
@@ -43,6 +42,7 @@
 #include <sys/socket.h>
 #include <sys/select.h>
 
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/usr.sbin/ngctl/show.c b/usr.sbin/ngctl/show.c
index 341ee40693..99cd4477b2 100644
--- a/usr.sbin/ngctl/show.c
+++ b/usr.sbin/ngctl/show.c
@@ -3,7 +3,7 @@
  *
  * Copyright (c) 1996-1999 Whistle Communications, Inc.
  * All rights reserved.
- * 
+ *
  * Subject to the following obligations and disclaimer of warranty, use and
  * redistribution of this software, in source or object code forms, with or
  * without modifications are expressly permitted by Whistle Communications;
@@ -14,7 +14,7 @@
  *    Communications, Inc. trademarks, including the mark "WHISTLE
  *    COMMUNICATIONS" on advertising, endorsements, or otherwise except as
  *    such appears in the above copyright notice or in the software.
- * 
+ *
  * THIS SOFTWARE IS BEING PROVIDED BY WHISTLE COMMUNICATIONS "AS IS", AND
  * TO THE MAXIMUM EXTENT PERMITTED BY LAW, WHISTLE COMMUNICATIONS MAKES NO
  * REPRESENTATIONS OR WARRANTIES, EXPRESS OR IMPLIED, REGARDING THIS SOFTWARE,
@@ -34,7 +34,6 @@
  * OF SUCH DAMAGE.
  *
  * $FreeBSD: src/usr.sbin/ngctl/show.c,v 1.2 1999/11/30 02:45:31 archie Exp $
- * $DragonFly: src/usr.sbin/ngctl/show.c,v 1.5 2008/07/10 18:29:52 swildner Exp $
  */
 
 #include "ngctl.h"
diff --git a/usr.sbin/powerd/powerd.c b/usr.sbin/powerd/powerd.c
index 0975d73972..fa64a8359f 100644
--- a/usr.sbin/powerd/powerd.c
+++ b/usr.sbin/powerd/powerd.c
@@ -49,8 +49,8 @@
 #include <sys/soundcard.h>
 #include <sys/sensors.h>
 #include <sys/time.h>
+#include <sys/cpumask.h>
 #include <machine/cpufunc.h>
-#include <machine/cpumask.h>
 #include <err.h>
 #include <signal.h>
 #include <stdio.h>
diff --git a/usr.sbin/ppp/acf.c b/usr.sbin/ppp/acf.c
index 65854782f9..c2ef270d76 100644
--- a/usr.sbin/ppp/acf.c
+++ b/usr.sbin/ppp/acf.c
@@ -24,12 +24,12 @@
  * SUCH DAMAGE.
  *
  * $FreeBSD: src/usr.sbin/ppp/acf.c,v 1.4.2.1 2000/08/19 09:29:59 brian Exp $
- * $DragonFly: src/usr.sbin/ppp/acf.c,v 1.3 2008/05/19 10:19:49 corecode Exp $
  */
 
 #include <sys/types.h>
 #include <sys/select.h>
 
+#include <stdint.h>
 #include <stdio.h>
 #include <termios.h>
 
diff --git a/usr.sbin/ppp/async.c b/usr.sbin/ppp/async.c
index 4c3c284d81..f275f58e3e 100644
--- a/usr.sbin/ppp/async.c
+++ b/usr.sbin/ppp/async.c
@@ -26,12 +26,12 @@
  * SUCH DAMAGE.
  *
  * $FreeBSD: src/usr.sbin/ppp/async.c,v 1.23.2.3 2002/09/01 02:12:22 brian Exp $
- * $DragonFly: src/usr.sbin/ppp/async.c,v 1.3 2008/05/19 10:19:49 corecode Exp $
  */
 
 #include <sys/types.h>
 #include <sys/select.h>
 
+#include <stdint.h>
 #include <string.h>
 #include <termios.h>
 
diff --git a/usr.sbin/ppp/hdlc.c b/usr.sbin/ppp/hdlc.c
index 7487b4cd0a..782667d02e 100644
--- a/usr.sbin/ppp/hdlc.c
+++ b/usr.sbin/ppp/hdlc.c
@@ -32,6 +32,7 @@
 #include <sys/un.h>
 
 #include <stdarg.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <string.h>
 #include <termios.h>
diff --git a/usr.sbin/ppp/sync.c b/usr.sbin/ppp/sync.c
index fca8315055..bffd53d7e3 100644
--- a/usr.sbin/ppp/sync.c
+++ b/usr.sbin/ppp/sync.c
@@ -24,12 +24,12 @@
  * SUCH DAMAGE.
  *
  * $FreeBSD: src/usr.sbin/ppp/sync.c,v 1.6 1999/12/20 20:29:47 brian Exp $
- * $DragonFly: src/usr.sbin/ppp/sync.c,v 1.3 2008/05/19 10:19:49 corecode Exp $
  */
 
 #include <sys/types.h>
 #include <sys/select.h>
 
+#include <stdint.h>
 #include <stdio.h>
 #include <termios.h>
 
diff --git a/usr.sbin/ppp/tty.c b/usr.sbin/ppp/tty.c
index 395c03b57d..47cc4df59c 100644
--- a/usr.sbin/ppp/tty.c
+++ b/usr.sbin/ppp/tty.c
@@ -24,7 +24,6 @@
  * SUCH DAMAGE.
  *
  * $FreeBSD: src/usr.sbin/ppp/tty.c,v 1.21.2.3 2002/09/01 02:12:32 brian Exp $
- * $DragonFly: src/usr.sbin/ppp/tty.c,v 1.4 2007/06/04 00:40:32 swildner Exp $
  */
 
 #include <sys/param.h>
@@ -35,6 +34,7 @@
 
 #include <errno.h>
 #include <fcntl.h>
+#include <stdint.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
diff --git a/usr.sbin/repquota/repquota.c b/usr.sbin/repquota/repquota.c
index 2fceec7626..54692073f8 100644
--- a/usr.sbin/repquota/repquota.c
+++ b/usr.sbin/repquota/repquota.c
@@ -39,6 +39,7 @@
  */
 #include <sys/param.h>
 #include <sys/stat.h>
+#include <stdint.h>
 #include <vfs/ufs/quota.h>
 #include <err.h>
 #include <errno.h>
diff --git a/usr.sbin/rtadvd/advcap.c b/usr.sbin/rtadvd/advcap.c
index efeec4baf6..f6875b76ad 100644
--- a/usr.sbin/rtadvd/advcap.c
+++ b/usr.sbin/rtadvd/advcap.c
@@ -40,6 +40,7 @@
 #include <unistd.h>
 #include <fcntl.h>
 #include <ctype.h>
+#include <stdint.h>
 #include <stdlib.h>
 #include <stdio.h>
 #include <syslog.h>
diff --git a/usr.sbin/sdpd/log.c b/usr.sbin/sdpd/log.c
index 33f9bf10ab..a9f29d586f 100644
--- a/usr.sbin/sdpd/log.c
+++ b/usr.sbin/sdpd/log.c
@@ -1,5 +1,4 @@
 /* $NetBSD: log.c,v 1.1 2006/06/19 15:44:56 gdamore Exp $ */
-/* $DragonFly: src/usr.sbin/sdpd/log.c,v 1.1 2008/01/06 21:51:30 hasso Exp $ */
 
 /*
  * log.c
@@ -34,6 +33,7 @@
 
 #include <sys/types.h>
 #include <stdarg.h>
+#include <stdint.h>
 #include <syslog.h>
 
 #include "log.h"
