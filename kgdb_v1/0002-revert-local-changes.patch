From b8f09f66b9f1ac3da6da3a504117d91cf208f840 Mon Sep 17 00:00:00 2001
From: zrj <rimvydas.jasinskas@gmail.com>
Date: Wed, 31 Jul 2019 14:02:59 +0300
Subject: [PATCH 02/10] revert local changes

---
 contrib/gdb-7/gdb/amd64-tdep.h     |  5 -----
 contrib/gdb-7/gdb/common/ptid.h    |  2 +-
 contrib/gdb-7/gdb/configure.host   |  2 --
 contrib/gdb-7/gdb/configure.tgt    | 12 ------------
 contrib/gdb-7/gdb/defs.h           |  6 +-----
 contrib/gdb-7/gdb/exec.c           |  3 ---
 contrib/gdb-7/gdb/i386-tdep.h      |  3 ---
 contrib/gdb-7/gdb/i386bsd-nat.c    |  2 --
 contrib/gdb-7/gdb/i386fbsd-tdep.c  |  2 +-
 contrib/gdb-7/gdb/inferior.c       |  4 ++--
 contrib/gdb-7/gdb/main.c           |  9 ---------
 contrib/gdb-7/gdb/osabi.c          | 10 ----------
 contrib/gdb-7/gdb/remote.c         |  2 +-
 contrib/gdb-7/include/elf/common.h |  4 ----
 contrib/gdb-7/include/libiberty.h  |  2 +-
 contrib/gdb-7/readline/search.c    |  2 +-
 16 files changed, 8 insertions(+), 62 deletions(-)

diff --git a/contrib/gdb-7/gdb/amd64-tdep.h b/contrib/gdb-7/gdb/amd64-tdep.h
index 9b9ae3ed01..a33e7d6a45 100644
--- a/contrib/gdb-7/gdb/amd64-tdep.h
+++ b/contrib/gdb-7/gdb/amd64-tdep.h
@@ -126,9 +126,4 @@ extern CORE_ADDR amd64fbsd_sigtramp_start_addr;
 extern CORE_ADDR amd64fbsd_sigtramp_end_addr;
 extern int amd64fbsd_sc_reg_offset[];
 
-/* Variables exported from amd64dfly-tdep.c.  */
-extern CORE_ADDR amd64dfly_sigtramp_start_addr;
-extern CORE_ADDR amd64dfly_sigtramp_end_addr;
-extern int amd64dfly_sc_reg_offset[];
-
 #endif /* amd64-tdep.h */
diff --git a/contrib/gdb-7/gdb/common/ptid.h b/contrib/gdb-7/gdb/common/ptid.h
index aa2aa40c25..6a8dcbf83b 100644
--- a/contrib/gdb-7/gdb/common/ptid.h
+++ b/contrib/gdb-7/gdb/common/ptid.h
@@ -47,7 +47,7 @@ struct ptid
     long lwp;
 
     /* Thread id */
-    unsigned long tid;
+    long tid;
   };
 
 typedef struct ptid ptid_t;
diff --git a/contrib/gdb-7/gdb/configure.host b/contrib/gdb-7/gdb/configure.host
index ded77f98ec..85f4491b8f 100644
--- a/contrib/gdb-7/gdb/configure.host
+++ b/contrib/gdb-7/gdb/configure.host
@@ -92,7 +92,6 @@ i[34567]86-*-freebsd* | i[34567]86-*-kfreebsd*-gnu)
 i[34567]86-*-netbsdelf* | i[34567]86-*-knetbsd*-gnu)
 			gdb_host=nbsdelf ;;
 i[34567]86-*-netbsd*)	gdb_host=nbsdaout ;;
-i[34567]86-*-dragonfly*) gdb_host=dfly ;;
 i[34567]86-*-go32*)	gdb_host=go32 ;;
 i[34567]86-*-mingw32*)	gdb_host=mingw
 			gdb_host_obs=mingw-hdep.o
@@ -180,7 +179,6 @@ x86_64-*-freebsd* | x86_64-*-kfreebsd*-gnu)
 x86_64-*-netbsd* | x86_64-*-knetbsd*-gnu)
 			gdb_host=nbsd64 ;;
 x86_64-*-openbsd*)	gdb_host=obsd64 ;;
-x86_64-*-dragonfly*)	gdb_host=dfly64 ;;
 x86_64-*-mingw*)        gdb_host=mingw64
 			gdb_host_obs=mingw-hdep.o
 			;;
diff --git a/contrib/gdb-7/gdb/configure.tgt b/contrib/gdb-7/gdb/configure.tgt
index c824bedc89..720d3d3ca1 100644
--- a/contrib/gdb-7/gdb/configure.tgt
+++ b/contrib/gdb-7/gdb/configure.tgt
@@ -200,11 +200,6 @@ i[34567]86-*-openbsd*)
 	gdb_target_obs="i386-tdep.o i387-tdep.o i386bsd-tdep.o i386obsd-tdep.o \
 			bsd-uthread.o solib-svr4.o"
 	;;
-i[34567]86-*-dragonfly*)
-	# Target: DragonFly/i386
-	gdb_target_obs="i386-tdep.o i387-tdep.o i386bsd-tdep.o i386fbsd-tdep.o \
-			i386dfly-tdep.o bsd-uthread.o corelow.o solib.o solib-svr4.o"
-	;;
 i[34567]86-*-nto*)
 	# Target: Intel 386 running qnx6.
 	gdb_target_obs="i386-tdep.o i387-tdep.o solib-svr4.o \
@@ -675,12 +670,6 @@ x86_64-*-openbsd*)
 			i387-tdep.o i386bsd-tdep.o i386obsd-tdep.o \
 			bsd-uthread.o solib-svr4.o"
 	;;
-x86_64-*-dragonfly*)
-	# Target: DragonFly/amd64
-	gdb_target_obs="amd64-tdep.o amd64dfly-tdep.o i386-tdep.o \
-			i387-tdep.o i386bsd-tdep.o i386fbsd-tdep.o i386dfly-tdep.o \
-			i386dfly-tdep.o bsd-uthread.o corelow.o solib.o solib-svr4.o"
-	;;
 xtensa*-*-linux*)	gdb_target=linux
 	# Target: GNU/Linux Xtensa
 	gdb_target_obs="xtensa-tdep.o xtensa-config.o xtensa-linux-tdep.o \
@@ -704,7 +693,6 @@ case "${targ}" in
 *-*-nto*)	gdb_osabi=GDB_OSABI_QNXNTO ;;
 m68*-*-openbsd* | m88*-*-openbsd* | vax-*-openbsd*) ;;
 *-*-openbsd*)	gdb_osabi=GDB_OSABI_OPENBSD_ELF ;;
-*-*-dragonfly*)	gdb_osabi=GDB_OSABI_DRAGONFLY ;;
 *-*-solaris*)	gdb_osabi=GDB_OSABI_SOLARIS ;;
 *-*-*-gnu*)	;; # prevent non-GNU kernels to match the Hurd rule below
 *-*-gnu*)	gdb_osabi=GDB_OSABI_HURD ;;
diff --git a/contrib/gdb-7/gdb/defs.h b/contrib/gdb-7/gdb/defs.h
index 99421e1e70..e157d6b973 100644
--- a/contrib/gdb-7/gdb/defs.h
+++ b/contrib/gdb-7/gdb/defs.h
@@ -26,7 +26,7 @@
 #endif
 
 #include "config.h"		/* Generated by configure.  */
-#include "libgnu/config.h"
+#include "build-gnulib/config.h"
 
 #include <sys/types.h>
 #include <stdio.h>
@@ -583,7 +583,6 @@ enum gdb_osabi
   GDB_OSABI_NETBSD_AOUT,
   GDB_OSABI_NETBSD_ELF,
   GDB_OSABI_OPENBSD_ELF,
-  GDB_OSABI_DRAGONFLY,
   GDB_OSABI_WINCE,
   GDB_OSABI_GO32,
   GDB_OSABI_IRIX,
@@ -794,9 +793,6 @@ extern int use_windows;
 extern void initialize_progspace (void);
 extern void initialize_inferiors (void);
 
-/* For DragonFly kgdb */
-extern int kernel_debugger;
-
 /* Special block numbers */
 
 enum block_enum
diff --git a/contrib/gdb-7/gdb/exec.c b/contrib/gdb-7/gdb/exec.c
index 55f1811af0..92c44f303f 100644
--- a/contrib/gdb-7/gdb/exec.c
+++ b/contrib/gdb-7/gdb/exec.c
@@ -406,9 +406,6 @@ resize_section_table (struct target_section_table *table, int num_added)
 
   old_count = table->sections_end - table->sections;
 
-  if (!num_added)
-    return old_count;
-
   new_count = num_added + old_count;
 
   if (new_count)
diff --git a/contrib/gdb-7/gdb/i386-tdep.h b/contrib/gdb-7/gdb/i386-tdep.h
index 7974eba309..69bd281aaa 100644
--- a/contrib/gdb-7/gdb/i386-tdep.h
+++ b/contrib/gdb-7/gdb/i386-tdep.h
@@ -391,9 +391,6 @@ extern CORE_ADDR i386fbsd_sigtramp_start_addr;
 extern CORE_ADDR i386fbsd_sigtramp_end_addr;
 extern CORE_ADDR i386obsd_sigtramp_start_addr;
 extern CORE_ADDR i386obsd_sigtramp_end_addr;
-extern CORE_ADDR i386dfly_sigtramp_start_addr;
-extern CORE_ADDR i386dfly_sigtramp_end_addr;
-extern int i386dfly_sc_reg_offset[];
 extern int i386fbsd4_sc_reg_offset[];
 extern int i386fbsd_sc_reg_offset[];
 extern int i386nbsd_sc_reg_offset[];
diff --git a/contrib/gdb-7/gdb/i386bsd-nat.c b/contrib/gdb-7/gdb/i386bsd-nat.c
index 7bf4885e06..797e7dce60 100644
--- a/contrib/gdb-7/gdb/i386bsd-nat.c
+++ b/contrib/gdb-7/gdb/i386bsd-nat.c
@@ -353,8 +353,6 @@ _initialize_i386bsd_nat (void)
 #define SC_REG_OFFSET i386nbsd_sc_reg_offset
 #elif defined (OpenBSD)
 #define SC_REG_OFFSET i386obsd_sc_reg_offset
-#elif defined (DragonFly)
-#define SC_REG_OFFSET i386dfly_sc_reg_offset
 #endif
 
 #ifdef SC_REG_OFFSET
diff --git a/contrib/gdb-7/gdb/i386fbsd-tdep.c b/contrib/gdb-7/gdb/i386fbsd-tdep.c
index 74f37d835c..2b49f80c2c 100644
--- a/contrib/gdb-7/gdb/i386fbsd-tdep.c
+++ b/contrib/gdb-7/gdb/i386fbsd-tdep.c
@@ -201,7 +201,7 @@ int i386fbsd4_sc_reg_offset[] =
   20 + 0 * 4			/* %gs */
 };
 
-void
+static void
 i386fbsd4_init_abi (struct gdbarch_info info, struct gdbarch *gdbarch)
 {
   struct gdbarch_tdep *tdep = gdbarch_tdep (gdbarch);
diff --git a/contrib/gdb-7/gdb/inferior.c b/contrib/gdb-7/gdb/inferior.c
index 9a61251a47..eb8629cdb6 100644
--- a/contrib/gdb-7/gdb/inferior.c
+++ b/contrib/gdb-7/gdb/inferior.c
@@ -358,7 +358,7 @@ find_inferior_pid (int pid)
   /* Looking for inferior pid == 0 is always wrong, and indicative of
      a bug somewhere else.  There may be more than one with pid == 0,
      for instance.  */
-  gdb_assert (kernel_debugger || pid != 0);
+  gdb_assert (pid != 0);
 
   for (inf = inferior_list; inf; inf = inf->next)
     if (inf->pid == pid)
@@ -525,7 +525,7 @@ number_of_inferiors (void)
 static char *
 inferior_pid_to_str (int pid)
 {
-  if (kernel_debugger || pid != 0)
+  if (pid != 0)
     return target_pid_to_str (pid_to_ptid (pid));
   else
     return _("<null>");
diff --git a/contrib/gdb-7/gdb/main.c b/contrib/gdb-7/gdb/main.c
index 09c5fd9d8e..bcbf33ffd9 100644
--- a/contrib/gdb-7/gdb/main.c
+++ b/contrib/gdb-7/gdb/main.c
@@ -96,9 +96,6 @@ int return_child_result_value = -1;
 /* GDB as it has been invoked from the command line (i.e. argv[0]).  */
 static char *gdb_program_name;
 
-/* DragonFly kgdb support */
-int kernel_debugger;
-
 static void print_gdb_help (struct ui_file *);
 
 /* Relocate a file or directory.  PROGNAME is the name by which gdb
@@ -444,7 +441,6 @@ captured_main (void *data)
       OPT_ANNOTATE,
       OPT_STATISTICS,
       OPT_TUI,
-      OPT_KGDB,
       OPT_NOWINDOWS,
       OPT_WINDOWS,
       OPT_IX,
@@ -472,7 +468,6 @@ captured_main (void *data)
       {"fullname", no_argument, 0, 'f'},
       {"f", no_argument, 0, 'f'},
 
-      {"kernel", no_argument, 0, OPT_KGDB},
       {"annotate", required_argument, 0, OPT_ANNOTATE},
       {"help", no_argument, &print_help, 1},
       {"se", required_argument, 0, OPT_SE},
@@ -566,9 +561,6 @@ captured_main (void *data)
 	    exit (1);
 #endif
 	    break;
-	  case OPT_KGDB:
-	    kernel_debugger = 1;
-	    break;
 	  case OPT_WINDOWS:
 	    /* FIXME: cagney/2003-03-01: Not sure if this option is
                actually useful, and if it is, what it should do.  */
@@ -1054,7 +1046,6 @@ captured_main (void *data)
 int
 gdb_main (struct captured_main_args *args)
 {
-  kernel_debugger = 0;
   use_windows = args->use_windows;
   catch_errors (captured_main, args, "", RETURN_MASK_ALL);
   /* The only way to end up here is by an error (normal exit is
diff --git a/contrib/gdb-7/gdb/osabi.c b/contrib/gdb-7/gdb/osabi.c
index c6ad974b9e..a123ea05bc 100644
--- a/contrib/gdb-7/gdb/osabi.c
+++ b/contrib/gdb-7/gdb/osabi.c
@@ -60,7 +60,6 @@ static const char * const gdb_osabi_names[] =
   "NetBSD a.out",
   "NetBSD ELF",
   "OpenBSD ELF",
-  "DragonFly",
   "Windows CE",
   "DJGPP",
   "Irix",
@@ -491,15 +490,6 @@ generic_elf_osabi_sniff_abi_tag_sections (bfd *abfd, asection *sect, void *obj)
 	  return;
 	}
 
-      /* DragonFly.  */
-      if (check_note (abfd, sect, note, &sectsize, "DragonFly", 4,
-		      NT_DRAGONFLY_ABI_TAG))
-	{
-	  /* There is no need to check the version yet.  */
-	  *osabi = GDB_OSABI_DRAGONFLY;
-	  return;
-	}
-
       return;
     }
       
diff --git a/contrib/gdb-7/gdb/remote.c b/contrib/gdb-7/gdb/remote.c
index c4073341ad..7761e002aa 100644
--- a/contrib/gdb-7/gdb/remote.c
+++ b/contrib/gdb-7/gdb/remote.c
@@ -5623,7 +5623,7 @@ Packet: '%s'\n"),
 	  {
 	    p++;
 
-	    if (*p == '\0')
+	    if (p == '\0')
 	      ;
 	    else if (strncmp (p,
 			      "process:", sizeof ("process:") - 1) == 0)
diff --git a/contrib/gdb-7/include/elf/common.h b/contrib/gdb-7/include/elf/common.h
index 48e29e911f..8bdefa60b9 100644
--- a/contrib/gdb-7/include/elf/common.h
+++ b/contrib/gdb-7/include/elf/common.h
@@ -629,10 +629,6 @@
 
 #define NT_FREEBSD_ABI_TAG	1
 
-/* Values for DragonFly .note.ABI-tag notes.  Note name is "DragonFly".  */
-
-#define NT_DRAGONFLY_ABI_TAG	1
-
 /* These three macros disassemble and assemble a symbol table st_info field,
    which contains the symbol binding and symbol type.  The STB_ and STT_
    defines identify the binding and type.  */
diff --git a/contrib/gdb-7/include/libiberty.h b/contrib/gdb-7/include/libiberty.h
index 5a34754169..cacde800ea 100644
--- a/contrib/gdb-7/include/libiberty.h
+++ b/contrib/gdb-7/include/libiberty.h
@@ -106,7 +106,7 @@ extern int countargv (char**);
    to find the declaration so provide a fully prototyped one.  If it
    is 1, we found it so don't provide any declaration at all.  */
 #if !HAVE_DECL_BASENAME
-#if defined (__GNU_LIBRARY__ ) || defined (__linux__) || defined (__FreeBSD__) || defined (__OpenBSD__) || defined(__NetBSD__) || defined(__DragonFly__) || defined (__CYGWIN__) || defined (__CYGWIN32__) || defined (__MINGW32__) || defined (HAVE_DECL_BASENAME)
+#if defined (__GNU_LIBRARY__ ) || defined (__linux__) || defined (__FreeBSD__) || defined (__OpenBSD__) || defined(__NetBSD__) || defined (__CYGWIN__) || defined (__CYGWIN32__) || defined (__MINGW32__) || defined (HAVE_DECL_BASENAME)
 extern char *basename (const char *);
 #else
 /* Do not allow basename to be used if there is no prototype seen.  We
diff --git a/contrib/gdb-7/readline/search.c b/contrib/gdb-7/readline/search.c
index bf525e6d3c..04468fc490 100644
--- a/contrib/gdb-7/readline/search.c
+++ b/contrib/gdb-7/readline/search.c
@@ -210,7 +210,7 @@ _rl_nsearch_init (dir, pchar)
   rl_end = rl_point = 0;
 
   p = _rl_make_prompt_for_search (pchar ? pchar : ':');
-  rl_message ("%s", p);
+  rl_message ("%s", p, 0);
   xfree (p);
 
   RL_SETSTATE(RL_STATE_NSEARCH);
-- 
2.22.0

