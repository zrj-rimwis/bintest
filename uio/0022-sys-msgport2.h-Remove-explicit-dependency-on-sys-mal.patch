From fb2f28cf4a07d18edc4f40d30e02f5bcf0b684ac Mon Sep 17 00:00:00 2001
From: zrj <rimvydas.jasinskas@gmail.com>
Date: Mon, 21 Oct 2019 19:02:23 +0300
Subject: [PATCH 22/39] <sys/msgport2.h>: Remove explicit dependency on
 <sys/malloc.h>.

---
 sys/dev/powermng/clockmod/clockmod.c |  5 +++--
 sys/kern/subr_disklabel32.c          | 15 ++++++++-------
 sys/net/pf/pf_ruleset.c              |  1 +
 sys/sys/msgport2.h                   |  5 ++---
 sys/vfs/devfs/devfs_core.c           |  1 +
 5 files changed, 15 insertions(+), 12 deletions(-)

diff --git a/sys/dev/powermng/clockmod/clockmod.c b/sys/dev/powermng/clockmod/clockmod.c
index 26a486705d..6c397e33f9 100644
--- a/sys/dev/powermng/clockmod/clockmod.c
+++ b/sys/dev/powermng/clockmod/clockmod.c
@@ -38,6 +38,7 @@
 #include <sys/bus.h>
 #include <sys/cpu_topology.h>
 #include <sys/cpuhelper.h>
+#include <sys/malloc.h>
 #include <sys/module.h>
 #include <sys/queue.h>
 #include <sys/serialize.h>
@@ -331,7 +332,7 @@ clockmod_dom_create(cpumask_t mask)
 				ctrl->ctl_value |= 1 << 4;
 
 			if (bootverbose) {
-				kprintf("  0x%04jx %s\n", 
+				kprintf("  0x%04jx %s\n",
 				    (uintmax_t)ctrl->ctl_value,
 				    ctrl->ctl_name);
 			}
@@ -472,7 +473,7 @@ clockmod_select_handler(struct cpuhelper_msg *msg)
 	cpuhelper_replymsg(msg, 0);
 }
 
-static int 
+static int
 clockmod_select(const struct clockmod_softc *sc,
     const struct clockmod_dom_ctrl *ctrl)
 {
diff --git a/sys/kern/subr_disklabel32.c b/sys/kern/subr_disklabel32.c
index 323bb02a9e..cea80b9e25 100644
--- a/sys/kern/subr_disklabel32.c
+++ b/sys/kern/subr_disklabel32.c
@@ -1,13 +1,13 @@
 /*
  * Copyright (c) 2003-2007 The DragonFly Project.  All rights reserved.
- * 
+ *
  * This code is derived from software contributed to The DragonFly Project
  * by Matthew Dillon <dillon@backplane.com>
- * 
+ *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
- * 
+ *
  * 1. Redistributions of source code must retain the above copyright
  *    notice, this list of conditions and the following disclaimer.
  * 2. Redistributions in binary form must reproduce the above copyright
@@ -17,7 +17,7 @@
  * 3. Neither the name of The DragonFly Project nor the names of its
  *    contributors may be used to endorse or promote products derived
  *    from this software without specific, prior written permission.
- * 
+ *
  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
@@ -30,7 +30,7 @@
  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
  * SUCH DAMAGE.
- * 
+ *
  * ----------------------------------------------------------------------------
  * "THE BEER-WARE LICENSE" (Revision 42):
  * <phk@FreeBSD.ORG> wrote this file.  As long as you retain this notice you
@@ -90,6 +90,7 @@
 #include <sys/param.h>
 #include <sys/systm.h>
 #include <sys/kernel.h>
+#include <sys/malloc.h>
 #include <sys/proc.h>
 #include <sys/sysctl.h>
 #include <sys/buf.h>
@@ -181,7 +182,7 @@ l32_freedisklabel(disklabel_t *lpp)
 }
 
 /*
- * Attempt to read a disk label from a device.  
+ * Attempt to read a disk label from a device.
  *
  * Returns NULL on sucess, and an error string on failure
  */
@@ -217,7 +218,7 @@ l32_readdisklabel(cdev_t dev, struct diskslice *sp, disklabel_t *lpp,
 			 * NOTE! dsreadandsetlabel() does a strcmp() on
 			 * this string.
 			 */
-			if (msg == NULL) 
+			if (msg == NULL)
 				msg = "no disk label";
 		} else if (dlp->d_npartitions > MAXPARTITIONS32 ||
 			   dkcksum32(dlp) != 0) {
diff --git a/sys/net/pf/pf_ruleset.c b/sys/net/pf/pf_ruleset.c
index 49b9675c1c..8c1db465c5 100644
--- a/sys/net/pf/pf_ruleset.c
+++ b/sys/net/pf/pf_ruleset.c
@@ -39,6 +39,7 @@
 #include <sys/socket.h>
 #ifdef _KERNEL
 # include <sys/systm.h>
+# include <sys/malloc.h>
 #endif /* _KERNEL */
 #include <sys/mbuf.h>
 
diff --git a/sys/sys/msgport2.h b/sys/sys/msgport2.h
index b5e2035cdd..3b0edf9e02 100644
--- a/sys/sys/msgport2.h
+++ b/sys/sys/msgport2.h
@@ -14,11 +14,10 @@
 #ifndef _SYS_SYSTM_H_
 #include <sys/systm.h>
 #endif
-#ifndef _SYS_MALLOC_H_
-#include <sys/malloc.h>
-#endif
 
+#ifdef MALLOC_DECLARE
 MALLOC_DECLARE(M_LWKTMSG);
+#endif
 
 /*
  * Initialize a LWKT message structure.  Note that if the message supports
diff --git a/sys/vfs/devfs/devfs_core.c b/sys/vfs/devfs/devfs_core.c
index ae628d007e..9ffe7694dd 100644
--- a/sys/vfs/devfs/devfs_core.c
+++ b/sys/vfs/devfs/devfs_core.c
@@ -35,6 +35,7 @@
 #include <sys/systm.h>
 #include <sys/kernel.h>
 #include <sys/bus.h>
+#include <sys/malloc.h>
 #include <sys/mount.h>
 #include <sys/vnode.h>
 #include <sys/lock.h>
-- 
2.23.0

